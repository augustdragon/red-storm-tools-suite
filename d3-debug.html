<!DOCTYPE html>
<html>
<head>
    <title>D3 Debug Test</title>
    <script src="shared/js/module-config.js"></script>
    <script src="shared/oob-generator/js/dice-roller.js"></script>
    <script src="shared/oob-generator/js/utils.js"></script>
    <script src="shared/oob-generator/js/table-processors/BaseTableProcessor.js"></script>
    <script src="shared/oob-generator/js/table-processors/NATOTableD3.js"></script>
</head>
<body>
    <h1>D3 Debug Test</h1>
    <button onclick="testAircraftDB()">Test Aircraft DB</button>
    <button onclick="testD3()">Test D3 FRG/DK Raid</button>
    <div id="output"></div>

    <script>
        // Test aircraft database loading
        function testAircraftDB() {
            console.log('=== AIRCRAFT DB TEST ===');
            
            fetch('shared/data/aircraft-nato.json')
                .then(response => response.json())
                .then(data => {
                    window.aircraftNATO = data;
                    console.log('Aircraft database loaded manually');
                    console.log('RF-35XD Draken entry:', data['RF-35XD Draken']);
                    console.log('Aircraft count:', Object.keys(data).length);
                    
                    // Test lookup variations
                    const testNames = ['RF-35XD Draken', 'RF-35XD', 'BR.1150 Atlantic 2', 'BR-150 Atlantic 2'];
                    testNames.forEach(name => {
                        const found = data[name];
                        console.log(`Lookup '${name}':`, found ? `Found - Nation: ${found.nation}` : 'Not found');
                    });
                    
                    document.getElementById('output').innerHTML = `
                        <h2>Aircraft Database Test:</h2>
                        <pre>Aircraft Count: ${Object.keys(data).length}
RF-35XD Draken: ${data['RF-35XD Draken'] ? 'Found - Nation: ' + data['RF-35XD Draken'].nation : 'Not found'}
BR.1150 Atlantic 2: ${data['BR.1150 Atlantic 2'] ? 'Found - Nation: ' + data['BR.1150 Atlantic 2'].nation : 'Not found'}</pre>
                    `;
                });
        }

        // Load D3 table data
        let tableData = null;
        fetch('modules/baltic-approaches/oob-generator/data/nato-tables.json')
            .then(response => response.json())
            .then(data => {
                tableData = data.D3;
                console.log('D3 table data loaded');
                console.log('FRG/DK raid data:', tableData.nationalityRolls['15-31 May']['1-4']);
            });

        function testD3() {
            if (!tableData || !window.aircraftNATO) {
                alert('Data not loaded yet - click Test Aircraft DB first');
                return;
            }

            console.log('=== D3 TEST START ===');
            
            const processor = new NATOTableD3(tableData);
            
            // Test with FRG/DK scenario - force a specific nationality for testing
            // Temporarily modify the processor to force FRG/DK result
            const originalRoll = processor.rollForNationality;
            processor.rollForNationality = function(nationalityRolls, rollLabel) {
                console.log('Forced FRG/DK result for testing');
                return {
                    nationalityRoll: 2,
                    nationalityRollDebug: 'Forced: 2',
                    nationality: 'FRG/DK',
                    nationalityData: nationalityRolls['1-4']
                };
            };
            
            const result = processor.process({ scenarioDate: '15-31 May' });
            console.log('D3 Result:', result);
            
            document.getElementById('output').innerHTML += `
                <h2>D3 Test Result:</h2>
                <pre>${JSON.stringify(result, null, 2)}</pre>
                <h3>Generated Flights:</h3>
                <div>${result.text || 'No text generated'}</div>
            `;
            
            // Restore original method
            processor.rollForNationality = originalRoll;
        }
    </script>
</body>
</html>