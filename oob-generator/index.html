<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Red Storm Order of Battle Generator</title>
  <!-- Updated: Table A implementation with nested roll system -->
  <link rel="stylesheet" href="../shared/red-storm.css">
  <link rel="stylesheet" href="css/oob-generator.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">Red Storm</div>
      <div class="subtitle">Order of Battle Generator</div>
      <!-- Version info hidden for production - uncomment to show: v2024.10.08-debug-26 -->
    </div>

    <a href="../" class="back-link">‚Üê Back to Red Storm Tools</a>

    <!-- Debug Toggle - Hidden for production -->
    <div class="section" id="debugToggle" style="display: none; text-align: center; margin-bottom: 10px;">
      <button class="action-button" id="debugModeButton" onclick="toggleDebugMode()" style="background-color: #666; font-size: 12px; padding: 5px 10px;">
        Debug Mode: OFF
      </button>
      <div id="debugStatus" style="font-size: 11px; color: #888; margin-top: 5px;">
        Debug mode shows all die rolls for testing
      </div>
    </div>

    <div class="content">
      <!-- Scenario Date Toggle -->
      <div class="section" id="scenarioToggle">
        <div class="section-title">Scenario Date</div>
        <div style="display: flex; gap: 10px; justify-content: center;">
          <button class="scenario-date-button" id="preDate" onclick="setScenarioDate('pre')">
            Pre-6/1/87
          </button>
          <button class="scenario-date-button" id="postDate" onclick="setScenarioDate('post')">
            6/1/87 or later
          </button>
        </div>
        <div class="scenario-status" id="scenarioStatus" style="margin-top: 10px; text-align: center; font-size: 14px; color: #b4c4b4;">
          Select scenario date to enable table generation
        </div>
      </div>

      <!-- Table Selection Section -->
            <!-- Table Selection Section -->
      <div class="section" id="tableSelection" style="opacity: 0.5; pointer-events: none;">
        <div class="section-title">Select Order of Battle Table</div>
        
        <!-- Invisible width placeholder to maintain consistent layout -->
        <div style="visibility: hidden; height: 0; overflow: hidden; margin-bottom: 0;">
          <div style="background-color: #4a5a4a; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: bold; margin-bottom: 5px;">NATO Table B - CAP Flight [4ATAF, 6/1/87+]</div>
              <div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">UK: 1 x {2} Tornado F2A, CAP (aircraft: 10)</div>
            </div>
            <button style="padding: 6px 12px; margin-left: 10px; flex-shrink: 0;">Remove</button>
          </div>
        </div>
        
        <div class="faction-section">
          <div class="faction-header nato-header">NATO Tables</div>
          <div class="table-grid">
            <button class="table-button nato-table" onclick="selectTable('A', 'NATO')">A</button>
            <button class="table-button nato-table" onclick="selectTable('B', 'NATO')">B</button>
            <button class="table-button nato-table" onclick="selectTable('C', 'NATO')">C</button>
            <button class="table-button nato-table" onclick="selectTable('D', 'NATO')">D</button>
            <button class="table-button nato-table" onclick="selectTable('E', 'NATO')">E</button>
            <button class="table-button nato-table" onclick="selectTable('F', 'NATO')">F</button>
          </div>
        </div>

        <div class="faction-section">
          <div class="faction-header warsaw-header">WP Tables</div>
          <div class="table-grid">
            <button class="table-button warsaw-table" onclick="selectTable('G', 'WP')">G</button>
            <button class="table-button warsaw-table" onclick="selectTable('H', 'WP')">H</button>
            <button class="table-button warsaw-table" onclick="selectTable('I', 'WP')">I</button>
            <button class="table-button warsaw-table" onclick="selectTable('J', 'WP')">J</button>
            <button class="table-button warsaw-table" onclick="selectTable('K', 'WP')">K</button>
            <button class="table-button warsaw-table" onclick="selectTable('L', 'WP')">L</button>
          </div>
        </div>
      </div>

      <!-- Roll Input Section -->
      <div class="roll-input-section" id="rollInputSection">
        <div class="selected-table" id="selectedTableDisplay"></div>
        
        <div class="input-group">
          <label for="rollCountBasic">Number of rolls:</label>
          <input type="number" id="rollCountBasic" min="1" max="20" value="1" />
        </div>
        
        <div class="action-buttons">
          <button class="action-button roll-button" onclick="makeRolls()">Make Rolls</button>
          <button class="action-button" style="background-color: #6d5d47;" onclick="viewTable()">View Table</button>
          <button class="action-button cancel-button" onclick="cancelSelection()">Cancel</button>
        </div>
      </div>

      <!-- Variable Selection Section -->
      <div class="roll-input-section" id="variableSelectionSection">
        <div class="selected-table" id="variableTableDisplay"></div>
        
        <!-- ATAF Zone Selection -->
        <div class="input-group" id="atafSelection" style="display: none;">
          <label>ATAF Zone:</label>
          <select id="atafZone" style="padding: 8px 12px; border: 1px solid #6a7a6a; border-radius: 4px; background-color: #5a6a5a; color: #f4f4f4; font-size: 16px;">
            <option value="2ATAF">2ATAF</option>
            <option value="4ATAF">4ATAF</option>
          </select>
        </div>
        
        <!-- Nationality Selection for Combat Rescue -->
        <div class="input-group" id="nationalitySelection" style="display: none;">
          <label>Nationality of downed crew:</label>
          <select id="crewNationality" style="padding: 8px 12px; border: 1px solid #6a7a6a; border-radius: 4px; background-color: #5a6a5a; color: #f4f4f4; font-size: 16px;">
            <option value="US">US</option>
            <option value="UK">UK/BE/NE</option>
            <option value="FRG">FRG</option>
            <option value="CAN">CAN (uses US rescue)</option>
            <option value="USSR">USSR</option>
            <option value="GDR">GDR</option>
          </select>
        </div>
        
        <!-- Mission Type Selection for Special Missions -->
        <div class="input-group" id="missionTypeSelection" style="display: none;">
          <label>Mission Type:</label>
          <select id="missionType" onchange="handleMissionTypeChange()" style="padding: 8px 12px; border: 1px solid #6a7a6a; border-radius: 4px; background-color: #5a6a5a; color: #f4f4f4; font-size: 16px;">
            <option value="Fast FAC">Fast FAC</option>
            <option value="Standoff Jamming">Standoff Jamming</option>
            <option value="Tactical Recon">Tactical Recon</option>
          </select>
        </div>
        
        <!-- Nation Selection for WP Table L Tactical Recon -->
        <div class="input-group" id="tacticalReconNationSelection" style="display: none;">
          <label>Nation:</label>
          <select id="tacticalReconNation" style="padding: 8px 12px; border: 1px solid #6a7a6a; border-radius: 4px; background-color: #5a6a5a; color: #f4f4f4; font-size: 16px;">
            <option value="USSR">USSR</option>
            <option value="GDR">GDR</option>
          </select>
        </div>
        
        <!-- Scenario Date Context -->
        <div class="input-group" id="dateContext" style="display: none;">
          <div style="background-color: #2a3a2a; padding: 8px 12px; border-radius: 4px; font-size: 14px; color: #b4c4b4; text-align: center;">
            <span id="dateContextMessage">Scenario Date Context: <span id="currentScenarioDate">Not set</span></span>
          </div>
        </div>
        
        <div class="input-group">
          <label for="rollCountVariable">Number of rolls:</label>
          <input type="number" id="rollCountVariable" min="1" max="20" value="1" />
        </div>
        
        <div class="action-buttons">
          <button class="action-button roll-button" onclick="makeRollsWithVariables()">Make Rolls</button>
          <button class="action-button" style="background-color: #6d5d47;" onclick="viewTableWithVariables()">View Table</button>
          <button class="action-button cancel-button" onclick="cancelVariableSelection()">Cancel</button>
        </div>
      </div>

      <!-- Results Section -->
      <div class="section results-section" id="resultsSection" style="display: none;">
        <div class="results-header">
          <div class="section-title">Generated Results</div>
          <button class="action-button" onclick="generatePrintableSheet()" style="background-color: #5a6a5a; margin-right: 10px;">üìÑ Print Flight Sheet</button>
          <button class="action-button clear-results" onclick="clearAllResults()">Clear All</button>
        </div>
        
        <div class="results-list" id="resultsList">
          <div class="empty-results">No results generated yet</div>
        </div>
      </div>

      <!-- Table View Overlay -->
      <div class="table-view-overlay" id="tableViewOverlay" style="display: none;" onclick="closeModalOnOverlayClick(event)">
        <div class="table-view-modal" onclick="event.stopPropagation()">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 15px;">
            <div class="section-title" id="tableViewTitle" style="margin: 0; flex: 1; min-width: 0;"></div>
            <button class="action-button cancel-button" onclick="hideTableView()" style="padding: 5px 10px; font-size: 12px; flex-shrink: 0;">‚úï Close</button>
          </div>
          <div id="tableViewContent"></div>
          <div style="text-align: center; margin-top: 20px;">
            <button class="action-button cancel-button" onclick="hideTableView()">Close Table View</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Application state
    let selectedTable = null;
    let selectedFaction = null;
    let scenarioDate = null; // 'pre' or 'post'
    let results = [];
    let resultCounter = 1;
    let hasGeneratedResults = false; // Track if any results exist
    let debugMode = false; // Debug mode for showing die rolls
    
    // Debug mode toggle
    function toggleDebugMode() {
      debugMode = !debugMode;
      const button = document.getElementById('debugModeButton');
      const status = document.getElementById('debugStatus');
      
      if (debugMode) {
        button.textContent = 'Debug Mode: ON';
        button.style.backgroundColor = '#d32f2f';
        status.textContent = 'All die rolls will be shown';
        status.style.color = '#d32f2f';
      } else {
        button.textContent = 'Debug Mode: OFF';
        button.style.backgroundColor = '#666';
        status.textContent = 'Debug mode shows all die rolls for testing';
        status.style.color = '#888';
      }
      
      // Refresh the results display to show/hide debug information
      updateResultsDisplay();
    }

    // Simple debug roll function that tracks rolls when debug mode is on
    function makeDebugRoll(sides, description) {
      const roll = Math.floor(Math.random() * sides) + 1;
      const debugEntry = debugMode ? `${description}: ${roll}` : null;
      return { roll, debugEntry };
    }
    
    // Set scenario date
    function setScenarioDate(dateValue) {
      // Don't allow changing date if results exist
      if (hasGeneratedResults) {
        alert('Cannot change scenario date while flights exist. Clear all results first.');
        return;
      }
      
      scenarioDate = dateValue;
      
      // Update button styles
      document.getElementById('preDate').classList.toggle('active', dateValue === 'pre');
      document.getElementById('postDate').classList.toggle('active', dateValue === 'post');
      
      // Update status
      const dateText = dateValue === 'pre' ? 'Pre-6/1/87' : '6/1/87 or later';
      document.getElementById('scenarioStatus').textContent = `Scenario Date: ${dateText}`;
      
      // Enable table selection if disabled
      const tableSection = document.getElementById('tableSelection');
      tableSection.style.opacity = '1';
      tableSection.style.pointerEvents = 'auto';
    }
    
    // Update date button states based on results
    function updateDateButtonStates() {
      const preButton = document.getElementById('preDate');
      const postButton = document.getElementById('postDate');
      
      if (hasGeneratedResults) {
        // Lock the buttons - truly disable them
        preButton.style.opacity = '0.5';
        postButton.style.opacity = '0.5';
        preButton.style.cursor = 'not-allowed';
        postButton.style.cursor = 'not-allowed';
        preButton.style.pointerEvents = 'none';
        postButton.style.pointerEvents = 'none';
        
        // Update status to show locked state
        const dateText = scenarioDate === 'pre' ? 'Pre-6/1/87' : '6/1/87 or later';
        document.getElementById('scenarioStatus').textContent = `Scenario Date: ${dateText} (locked - clear results to change)`;
      } else {
        // Unlock the buttons
        preButton.style.opacity = '1';
        postButton.style.opacity = '1';
        preButton.style.cursor = 'pointer';
        postButton.style.cursor = 'pointer';
        preButton.style.pointerEvents = 'auto';
        postButton.style.pointerEvents = 'auto';
        
        if (scenarioDate) {
          const dateText = scenarioDate === 'pre' ? 'Pre-6/1/87' : '6/1/87 or later';
          document.getElementById('scenarioStatus').textContent = `Scenario Date: ${dateText}`;
        } else {
          document.getElementById('scenarioStatus').textContent = 'Select scenario date to enable table generation';
        }
      }
    }

    // OOB Tables with actual game data
    const oobTables = {
      'A': { 
        name: 'NATO Table A - QRA Flight', 
        faction: 'NATO',
        description: 'NATO QRA Flight - Quick Reaction Alert flights on standby at designated airbases',
        flightSize: 2,
        hasATAF: true,
        hasDate: true,
        variants: {
          '2ATAF': {
            'pre': {
              nations: {
                '1-4': {
                  name: 'UK',
                  aircraft: {
                    '1-6': 'FGR2',
                    '7-10': 'Harrier GR3'
                  }
                },
                '5-6': {
                  name: 'BE/NE',
                  aircraft: {
                    '1-5': 'F-16A(BE)',
                    '6-9': 'F-16A(NE)',
                    '10': 'NF-5A'
                  }
                },
                '7-10': {
                  name: 'FRG',
                  aircraft: {
                    '1-10': 'F-4F'
                  }
                }
              }
            },
            'post': {
              nations: {
                '1-6': {
                  name: 'UK',
                  aircraft: {
                    '1-6': 'FGR2',
                    '7-10': 'Harrier GR3'
                  }
                },
                '7': {
                  name: 'BE/NE',
                  aircraft: {
                    '1-5': 'F-16A(BE)',
                    '6-9': 'F-16A(NE)',
                    '10': 'NF-5A'
                  }
                },
                '8-10': {
                  name: 'FRG',
                  aircraft: {
                    '1-10': 'F-4F'
                  }
                }
              }
            }
          },
          '4ATAF': {
            'pre': {
              nations: {
                '1-5': {
                  name: 'US',
                  aircraft: {
                    '1-2': 'F-4D',
                    '3-4': 'F-4E',
                    '5-8': 'F-16A',
                    '9-10': 'F-16C'
                  }
                },
                '6-8': {
                  name: 'FRG',
                  aircraft: {
                    '1-8': 'F-4F',
                    '9-10': 'F-104G'
                  }
                },
                '9-10': {
                  name: 'CAN',
                  aircraft: {
                    '1-8': 'CF-18A',
                    '9-10': 'CF-5A'
                  }
                }
              }
            },
            'post': {
              nations: {
                '1-7': {
                  name: 'US',
                  aircraft: {
                    '1-2': 'F-4D',
                    '3-4': 'F-4E',
                    '5-8': 'F-16A',
                    '9-10': 'F-16C'
                  }
                },
                '8-9': {
                  name: 'FRG',
                  aircraft: {
                    '1-8': 'F-4F',
                    '9-10': 'F-104G'
                  }
                },
                '10': {
                  name: 'CAN',
                  aircraft: {
                    '1-8': 'CF-18A',
                    '9-10': 'CF-5A'
                  }
                }
              }
            }
          }
        }
      },
      'B': { 
        name: 'NATO Table B - CAP Flight', 
        faction: 'NATO',
        hasATAF: true,
        hasDate: true,
        description: 'NATO CAP Flight - Flights in the air at designated Orbit Points',
        result: '1 x {2} [CAP], CAP',
        zones: {
          '2ATAF': {
            'pre': {
              nations: {
                '1-2': {
                  name: 'US',
                  aircraft: {
                    '1-2': 'F-15A',
                    '3-6': 'F-15C',
                    '7-9': 'F-4E',
                    '10': 'F-4D'
                  }
                },
                '3-5': {
                  name: 'UK',
                  aircraft: {
                    '1-7': 'FGR2',
                    '8-10': 'Tornado F2A'
                  }
                },
                '6-7': {
                  name: 'BE/NE',
                  aircraft: {
                    '1-5': 'F-16A(BE)',
                    '6-10': 'F-16A(NE)'
                  }
                },
                '8-10': {
                  name: 'FRG',
                  aircraft: {
                    '1-10': 'F-4F'
                  }
                }
              }
            },
            'post': {
              nations: {
                '1-4': {
                  name: 'US',
                  aircraft: {
                    '1-2': 'F-15A',
                    '3-6': 'F-15C',
                    '7-9': 'F-4E',
                    '10': 'F-4D'
                  }
                },
                '5-6': {
                  name: 'UK',
                  aircraft: {
                    '1-7': 'FGR2',
                    '8-10': 'Tornado F2A'
                  }
                },
                '7-8': {
                  name: 'BE/NE',
                  aircraft: {
                    '1-5': 'F-16A(BE)',
                    '6-10': 'F-16A(NE)'
                  }
                },
                '9-10': {
                  name: 'FRG',
                  aircraft: {
                    '1-10': 'F-4F'
                  }
                }
              }
            }
          },
          '4ATAF': {
            'pre': {
              nations: {
                '1-5': {
                  name: 'US',
                  aircraft: {
                    '1-2': 'F-15A',
                    '3-6': 'F-15C',
                    '7-9': 'F-4E',
                    '10': 'F-4D'
                  }
                },
                '6-8': {
                  name: 'FRG',
                  aircraft: {
                    '1-9': 'F-4F',
                    '10': 'F-104G'
                  }
                },
                '9-10': {
                  name: 'CAN',
                  aircraft: {
                    '1-9': 'CF-18A',
                    '10': 'CF-5A'
                  }
                }
              }
            },
            'post': {
              nations: {
                '1-7': {
                  name: 'US',
                  aircraft: {
                    '1-2': 'F-15A',
                    '3-6': 'F-15C',
                    '7-9': 'F-4E',
                    '10': 'F-4D'
                  }
                },
                '8-9': {
                  name: 'FRG',
                  aircraft: {
                    '1-9': 'F-4F',
                    '10': 'F-104G'
                  }
                },
                '10': {
                  name: 'CAN',
                  aircraft: {
                    '1-9': 'CF-18A',
                    '10': 'CF-5A'
                  }
                }
              }
            }
          }
        }
      },
      'C': { 
        name: 'NATO Table C - Bombing Raid', 
        faction: 'NATO',
        hasTasking: true,
        hasDate: true,
        description: 'NATO Bombing Raid - Package of CAP, SEAD, and Bombing flights',
        ordnanceNote: 'SEAD flights may always carry ARM as well, if capable.',
        result: '4 x {2} [CAP], CAP; 4 x {2} [SEAD], SEAD; 4 x {4} [Deep Strike], Bombing',
        taskings: {
          'CAP': {
            'pre': {
              nations: {
                '1-5': {
                  name: 'US',
                  aircraft: {
                    '1-2': 'F-15A',
                    '3-6': 'F-15C',
                    '7-8': 'F-4E',
                    '9': 'F-4D',
                    '10': 'F-16C'
                  }
                },
                '6': {
                  name: 'UK',
                  aircraft: {
                    '1-7': 'FGR2',
                    '8-10': 'Tornado F2A'
                  }
                },
                '7-8': {
                  name: 'FRG',
                  aircraft: {
                    '1-10': 'F-4F'
                  }
                },
                '9': {
                  name: 'BE',
                  aircraft: {
                    '1-5': 'F-16A(BE)',
                    '6-10': 'Mirage 5BA'
                  }
                },
                '10': {
                  name: 'NE/CAN',
                  aircraft: {
                    '1-5': 'F-16A(NE)',
                    '6-10': 'CF-18A'
                  }
                }
              }
            },
            'post': {
              nations: {
                '1-6': {
                  name: 'US',
                  aircraft: {
                    '1-2': 'F-15A',
                    '3-6': 'F-15C',
                    '7-8': 'F-4E',
                    '9': 'F-4D',
                    '10': 'F-16C'
                  }
                },
                '7': {
                  name: 'UK',
                  aircraft: {
                    '1-7': 'FGR2',
                    '8-10': 'Tornado F2A'
                  }
                },
                '8-9': {
                  name: 'FRG',
                  aircraft: {
                    '1-10': 'F-4F'
                  }
                },
                '10': {
                  name: 'NE/CAN',
                  aircraft: {
                    '1-5': 'F-16A',
                    '6-10': 'CF-18A'
                  }
                }
              }
            }
          },
          'SEAD': {
            'pre': {
              nations: {
                '1-4': {
                  name: 'US',
                  aircraft: {
                    '1-3': 'F-4G',
                    '4-8': 'F-4G/F-4E',
                    '9': 'F-4G/F-16C',
                    '10': 'A-7D'
                  }
                },
                '5-6': {
                  name: 'UK',
                  aircraft: {
                    '1-5': 'Torn GR1',
                    '6-8': 'Harrier GR3',
                    '9-10': 'Jaguar GR1A'
                  }
                },
                '7-8': {
                  name: 'FRG',
                  aircraft: {
                    '1-5': 'Torn IDS',
                    '6-9': 'F-4F',
                    '10': 'F-104G'
                  }
                },
                '9': {
                  name: 'BE',
                  aircraft: {
                    '1-5': 'F-16A',
                    '6-10': 'Mirage 5BA'
                  }
                },
                '10': {
                  name: 'NE/CAN',
                  aircraft: {
                    '1-5': 'F-16A',
                    '6-10': 'CF-18A'
                  }
                }
              }
            },
            'post': {
              nations: {
                '1-6': {
                  name: 'US',
                  aircraft: {
                    '1-3': 'F-4G',
                    '4-8': 'F-4G/F-4E',
                    '9': 'F-4G/F-16C',
                    '10': 'A-7D'
                  }
                },
                '7': {
                  name: 'UK',
                  aircraft: {
                    '1-5': 'Torn GR1',
                    '6-8': 'Harrier GR3',
                    '9-10': 'Jaguar GR1A'
                  }
                },
                '8-9': {
                  name: 'FRG',
                  aircraft: {
                    '1-5': 'Torn IDS',
                    '6-9': 'F-4F',
                    '8-9': 'Alpha Jet',
                    '10': 'F-104G'
                  }
                },
                '10': {
                  name: 'NE/CAN',
                  aircraft: {
                    '1-5': 'F-16A',
                    '6-10': 'CF-18A'
                  }
                }
              }
            }
          },
          'Bombing': {
            'pre': {
              nations: {
                '1-4': {
                  name: 'US',
                  aircraft: {
                    '1-2': 'F-16A',
                    '3': 'F-16C',
                    '4-6': 'A-10A',
                    '7': 'A-7D',
                    '8-10': 'F-4¬≤'
                  }
                },
                '5-6': {
                  name: 'UK',
                  aircraft: {
                    '1-5': 'Torn GR1',
                    '6-9': 'Harrier GR3',
                    '10': 'Jaguar GR1A'
                  }
                },
                '7-8': {
                  name: 'FRG',
                  aircraft: {
                    '1-4': 'Torn IDS',
                    '5-7': 'F-4F',
                    '8-9': 'Alpha Jet',
                    '10': 'F-104G'
                  }
                },
                '9': {
                  name: 'BE',
                  aircraft: {
                    '1-5': 'F-16A',
                    '6-10': 'Mirage 5BA'
                  }
                },
                '10': {
                  name: 'NE/CAN',
                  aircraft: {
                    '1-4': 'F-16A',
                    '5-10': 'CF-18A'
                  }
                }
              }
            },
            'post': {
              nations: {
                '1-6': {
                  name: 'US',
                  aircraft: {
                    '1-2': 'F-16A',
                    '3': 'F-16C',
                    '4-6': 'A-10A',
                    '7': 'A-7D',
                    '8-10': 'F-4¬≤'
                  }
                },
                '7': {
                  name: 'UK',
                  aircraft: {
                    '1-5': 'Torn GR1',
                    '6-9': 'Harrier GR3',
                    '10': 'Jaguar GR1A'
                  }
                },
                '8-9': {
                  name: 'FRG',
                  aircraft: {
                    '1-4': 'Torn IDS',
                    '5-7': 'F-4F',
                    '8-9': 'Alpha Jet',
                    '10': 'F-104G'
                  }
                },
                '10': {
                  name: 'NE/CAN',
                  aircraft: {
                    '1-4': 'F-16A',
                    '5-10': 'CF-18A'
                  }
                }
              }
            }
          }
        }
      },
      'D': { 
        name: 'NATO Table D - Deep Strike Raid', 
        faction: 'NATO',
        hasTasking: true,
        hasDate: false,
        description: 'NATO Deep Strike Raid - Package of flights for deep behind WP lines',
        ordnanceNote: 'All SEAD or Bombing flights may carry any air-to-ground ordnance allowed for that aircraft type. Recon flights may only carry air-to-air missiles and guns, if capable. No other ordnance allowed.',
        result: '2 x {1} [Escort Jamming]; 4 x {2} [CAP]; 4 x {2} [SEAD]; 4 x {4} [Bombing]; 2 x {2} [Recon]',
        taskings: {
          'Escort Jamming': {
            flightSize: 1,
            flightCount: 2,
            description: 'Escort Jamming',
            nations: {
              '1-10': {
                name: 'US',
                aircraft: {
                  '1-10': 'EF-111A'
                }
              }
            }
          },
          'CAP': {
            flightSize: 2,
            flightCount: 4,
            description: 'Combat Air Patrol',
            nations: {
              '1-6': {
                name: 'US',
                aircraft: {
                  '1-3': 'F-15A',
                  '4-7': 'F-15C',
                  '8-10': 'F-4E'
                }
              },
              '7-8': {
                name: 'UK',
                aircraft: {
                  '1-10': 'FGR2'
                }
              },
              '9-10': {
                name: 'CAN',
                aircraft: {
                  '1-10': 'CF-18A'
                }
              }
            }
          },
          'SEAD': {
            flightSize: 2,
            flightCount: 4,
            description: 'Suppression of Enemy Air Defenses',
            nations: {
              '1-6': {
                name: 'US',
                aircraft: {
                  '1-6': 'F-4G',
                  '7-9': 'F-4G/F-4E',
                  '10': 'F-4G/F-16C'
                }
              },
              '7-9': {
                name: 'UK',
                aircraft: {
                  '1-8': 'Tornado GR1',
                  '9-10': 'Jaguar GR1A'
                }
              },
              '10': {
                name: 'CAN',
                aircraft: {
                  '1-10': 'CF-18A'
                }
              }
            }
          },
          'Bombing': {
            flightSize: 4,
            flightCount: 4,
            description: 'Bombing',
            nations: {
              '1-6': {
                name: 'US',
                aircraft: {
                  '1-5': 'F-4E or F-111D/E (player choice)',
                  '6-10': 'F-111F'
                }
              },
              '7-8': {
                name: 'UK',
                aircraft: {
                  '1-10': 'Tornado GR1'
                }
              },
              '9-10': {
                name: 'FRG',
                aircraft: {
                  '1-10': 'Tornado IDS'
                }
              }
            }
          },
          'Recon': {
            flightSize: 2,
            flightCount: 2,
            description: 'Reconnaissance',
            nations: {
              '1-5': {
                name: 'US',
                aircraft: {
                  '1-10': 'RF-4C'
                }
              },
              '6-7': {
                name: 'UK',
                aircraft: {
                  '1-7': 'Jaguar GR1A',
                  '8-10': 'Tornado GR1A'
                }
              },
              '8-9': {
                name: 'FRG',
                aircraft: {
                  '1-10': 'RF-4E'
                }
              },
              '10': {
                name: 'BE',
                aircraft: {
                  '1-10': 'Mirage 5BR'
                }
              }
            }
          }
        }
      },
      'E': { 
        name: 'NATO Table E - Combat Rescue', 
        faction: 'NATO',
        hasNationality: true,
        hasDate: false,
        description: 'NATO Combat Rescue - Rescue missions for downed aircrew',
        ordnanceNote: 'All flights tasked with Rescue Support may carry any ordnance allowed for the specific aircraft type.',
        result: 'Nationality determined rescue package',
        nationalities: {
          'US': {
            name: 'US Combat Rescue Raid',
            flights: [
              {
                type: 'Rescue Support',
                flightSize: 2,
                flightCount: 2,
                description: 'Rescue Support',
                aircraft: {
                  '1-6': 'A-10A',
                  '7-10': 'A-7D'
                }
              },
              {
                type: 'CSAR',
                flightSize: 1,
                flightCount: 2,
                description: 'Combat Search and Rescue',
                aircraft: {
                  '1-10': 'H-53'
                }
              }
            ]
          },
          'UK': {
            name: 'UK Combat Rescue Raid',
            flights: [
              {
                type: 'Rescue Support',
                flightSize: 2,
                flightCount: 2,
                description: 'Rescue Support',
                aircraft: {
                  '1-8': 'Harrier GR3',
                  '9-10': 'Jaguar GR1A'
                }
              },
              {
                type: 'CSAR',
                flightSize: 1,
                flightCount: 2,
                description: 'Combat Search and Rescue',
                aircraft: {
                  '1-10': 'Puma'
                }
              }
            ]
          },
          'FRG': {
            name: 'FRG Combat Rescue Raid',
            flights: [
              {
                type: 'Rescue Support',
                flightSize: 2,
                flightCount: 2,
                description: 'Rescue Support',
                aircraft: {
                  '1-5': 'Alpha Jet',
                  '6-10': 'F-4F'
                }
              },
              {
                type: 'CSAR',
                flightSize: 1,
                flightCount: 2,
                description: 'Combat Search and Rescue',
                aircraft: {
                  '1-10': 'CH-53'
                }
              }
            ]
          }
        }
      },
      'F': { 
        name: 'NATO Table F - Special Missions', 
        faction: 'NATO',
        hasMissionType: true,
        hasDate: false,
        description: 'NATO Special Missions - Specialized missions for small numbers of aircraft',
        result: 'Mission type determines result',
        missionTypes: {
          'Fast FAC': {
            name: 'Fast FAC',
            flightSize: 2,
            flightCount: 1,
            description: 'Fast Forward Air Control',
            ordnanceNote: 'Aircraft tasked with Fast FAC may not carry any ordnance. They may carry gun and IRM air-to-air weapons if otherwise allowed.',
            nations: {
              '1-5': {
                name: 'US',
                aircraft: {
                  '1-4': 'F-4E',
                  '5-10': 'A-10A'
                }
              },
              '6-7': {
                name: 'UK',
                aircraft: {
                  '1-4': 'Harrier GR3',
                  '5-10': 'Tornado GR1'
                }
              },
              '8-9': {
                name: 'FRG',
                aircraft: {
                  '1-5': 'F-4F',
                  '6-10': 'Alpha Jet'
                }
              },
              '10': {
                name: 'BE/NE/CAN',
                aircraft: {
                  '1-4': 'Mirage 5BA',
                  '5-7': 'F-16A',
                  '8-10': 'CF-18A'
                }
              }
            }
          },
          'Standoff Jamming': {
            name: 'Standoff Jamming',
            flightSize: 1,
            flightCount: 1,
            description: 'Electronic Warfare Jamming',
            ordnanceNote: 'Aircraft tasked with Standoff Jamming may not carry any air-to-ground ordnance.',
            nations: {
              '1-9': {
                name: 'US',
                aircraft: {
                  '1-3': 'EC-130H',
                  '4-10': 'EF-111A'
                }
              },
              '10': {
                name: 'UK/FRG',
                aircraft: {
                  '1-5': 'Falcon 20F',
                  '6-10': 'HFB 320 Hansa Jet'
                }
              }
            }
          },
          'Tactical Recon': {
            name: 'Tactical Recon',
            flightSize: 2,
            flightCount: 1,
            description: 'Tactical Reconnaissance',
            ordnanceNote: 'Recon flights may only carry air-to-air missiles and guns, if capable. No other ordnance allowed.',
            nations: {
              '1-3': {
                name: 'US',
                aircraft: {
                  '1-10': 'RF-4C'
                }
              },
              '4-5': {
                name: 'UK',
                aircraft: {
                  '1-7': 'Jaguar GR1A',
                  '8-10': 'Tornado GR1A'
                }
              },
              '6-9': {
                name: 'FRG',
                aircraft: {
                  '1-10': 'RF-4E'
                }
              },
              '10': {
                name: 'BE/NE',
                aircraft: {
                  '1-5': 'Mirage 5BR',
                  '6-10': 'F-16A(NE)'
                }
              }
            }
          }
        }
      },
      'G': { 
        name: 'WP Table G - QRA Flights', 
        faction: 'WP',
        hasDate: false,
        description: 'WP QRA Flights - Aircraft sitting alert at WP airfields in East Germany',
        flightSize: 2,
        nations: {
          '1-3': {
            name: 'USSR',
            aircraft: {
              '1-2': 'MiG-21bis',
              '3-4': 'MiG-23M',
              '5-6': 'MiG-23ML',
              '7-8': 'MiG-29A',
              '9-10': 'MiG-25PD/Su-27S¬π' // Hidden sub-roll: 1-5 MiG-25PD, 6-10 Su-27S
            }
          },
          '4-10': {
            name: 'GDR',
            aircraft: {
              '1-6': 'MiG-21bis',
              '7-10': 'MiG-23ML'
            }
          }
        }
      },
      'H': { 
        name: 'WP Table H - Fighter Sweep', 
        faction: 'WP',
        hasDate: false,
        flightSize: 4,
        flightCount: 3,
        description: 'WP Fighter Sweep - Squadron-size groups of flights tasked with establishing air superiority',
        nations: {
          '1-7': {
            name: 'USSR',
            aircraft: {
              '1-2': 'MiG-21bis',
              '3-4': 'MiG-23M',
              '5-6': 'MiG-23MLA',
              '7-9': 'MiG-29A',
              '10': 'MiG-25PD/Su-27S¬π' // Hidden sub-roll: 1-5 MiG-25PD, 6-10 Su-27S
            }
          },
          '8-10': {
            name: 'GDR',
            aircraft: {
              '1-5': 'MiG-21bis',
              '6-10': 'MiG-23ML'
            }
          }
        }
      },
      'I': { 
        name: 'WP Table I - Bombing Raid', 
        faction: 'WP',
        hasTasking: true,
        hasNationality: true,
        hasDate: false,
        description: 'WP Bombing Raid - Packages of flights assigned to provide air support to WP ground troops',
        ordnanceNote: 'SEAD flights may always carry ARMs, if capable.',
        nationalities: {
          'USSR': {
            name: 'USSR Bombing Raid',
            taskings: {
              'Close Escort': {
                flightSize: 4,
                flightCount: 3,
                description: 'Close Escort',
                aircraft: {
                  '1': 'MiG-21bis',
                  '2': 'MiG-23M',
                  '3-4': 'MiG-23MLA',
                  '5-7': 'MiG-23MLD',
                  '8-10': 'MiG-29A'
                }
              },
              'SEAD': {
                flightSize: 4,
                flightCount: 2,
                description: 'SEAD',
                aircraft: {
                  '1-2': 'Su-17M4',
                  '3-4': 'MiG-23¬≤',
                  '5-6': 'Su-24',
                  '7-8': 'MiG-27M',
                  '9-10': 'MiG-27K'
                }
              },
              'Bombing': {
                flightSize: 4,
                flightCount: 5,
                description: 'Bombing',
                aircraft: {
                  '1-2': 'Su-17M4',
                  '3-4': 'MiG-23¬≤',
                  '5-6': 'Su-25',
                  '7-8': 'MiG-27M',
                  '9-10': 'MiG-27K'
                }
              }
            }
          },
          'GDR': {
            name: 'GDR Bombing Raid',
            taskings: {
              'Close Escort': {
                flightSize: 4,
                flightCount: 3,
                description: 'Close Escort',
                aircraft: {
                  '1-5': 'MiG-21MF',
                  '6': 'MiG-21SPS',
                  '7-9': 'MiG-21bis',
                  '10': 'MiG-23MF/ML¬π'
                }
              },
              'SEAD': {
                flightSize: 4,
                flightCount: 2,
                description: 'SEAD',
                aircraft: {
                  '1-4': 'Su-22M4',
                  '5-7': 'MiG-21MF',
                  '8-10': 'MiG-23¬≤'
                }
              },
              'Bombing': {
                flightSize: 4,
                flightCount: 5,
                description: 'Bombing',
                aircraft: {
                  '1-4': 'Su-22M4',
                  '5-7': 'MiG-21MF',
                  '8-10': 'MiG-23BN'
                }
              }
            }
          }
        }
      },
      'J': { 
        name: 'WP Table J - Deep Strike Raid', 
        faction: 'WP',
        hasTasking: true,
        hasDate: false,
        description: 'WP Deep Strike Raid - Packages of flights intended to go deep behind NATO lines',
        ordnanceNote: 'All Bombing flights may carry any air-to-ground ordnance allowed for the specified aircraft type. Recon flights may only carry air-to-air missiles and guns, if capable. No other ordnance allowed.',
        taskings: {
          'Escort Jamming': {
            flightSize: 1,
            flightCount: 3,
            description: 'Escort Jamming',
            nations: {
              '1-2': {
                name: 'USSR',
                aircraft: {
                  '1-2': 'Su-24MP',
                  '3-5': 'MiG-25RB',
                  '6-8': 'Yak-28PP',
                  '9-10': 'Tu-22PP'
                }
              },
              '3-5': {
                name: 'USSR',
                aircraft: {
                  '1-5': 'MiG-25RB',
                  '6-10': 'Tu-22PP'
                }
              },
              '6-8': {
                name: 'USSR',
                aircraft: {
                  '1-4': 'Su-24MP',
                  '5-8': 'MiG-25RB',
                  '9-10': 'Yak-28PP'
                }
              },
              '9-10': {
                name: 'GDR',
                aircraft: {
                  '1-10': 'MiG-21PF'
                }
              }
            }
          },
          'Chaff Laying': {
            flightSize: 1,
            flightCount: 3,
            description: 'Chaff Laying',
            nations: {
              '1-5': {
                name: 'USSR',
                aircraft: {
                  '1-5': 'MiG-21bis',
                  '6-10': 'MiG-23M'
                }
              },
              '6-8': {
                name: 'USSR',
                aircraft: {
                  '1-4': 'Yak-28R',
                  '5-8': 'MiG-25RB',
                  '9-10': 'Su-24MR'
                }
              },
              '9-10': {
                name: 'GDR',
                aircraft: {
                  '1-10': 'MiG-21PF'
                }
              }
            }
          },
          'Close Escort': {
            flightSize: 4,
            flightCount: 4,
            description: 'Close Escort',
            nations: {
              '1-3': {
                name: 'USSR',
                aircraft: {
                  '1-3': 'MiG-23MLA',
                  '4-7': 'MiG-23MLD',
                  '8-10': 'Su-27S'
                }
              },
              '4-7': {
                name: 'USSR',
                aircraft: {
                  '1-4': 'MiG-23ML',
                  '5-7': 'MiG-29A',
                  '8-10': 'Su-27S'
                }
              },
              '8-10': {
                name: 'GDR',
                aircraft: {
                  '1-10': 'MiG-23ML'
                }
              }
            }
          },
          'Deep Bombing': {
            flightSize: 4,
            flightCount: 6,
            description: 'Deep Bombing',
            nations: {
              '1-4': {
                name: 'USSR',
                aircraft: {
                  '1-4': 'Su-24M',
                  '5-8': 'Su-24M4',
                  '9-10': 'MiG-27K'
                }
              },
              '5-8': {
                name: 'USSR',
                aircraft: {
                  '1-10': 'Tu-22M'
                }
              },
              '9-10': {
                name: 'GDR',
                aircraft: {
                  '1-10': 'Su-22M4'
                }
              }
            }
          },
          'Recon': {
            flightSize: 1,
            flightCount: 2,
            description: 'Reconnaissance',
            nations: {
              '1-5': {
                name: 'USSR',
                aircraft: {
                  '1-5': 'Su-17M4R',
                  '6-10': 'MiG-25RB'
                }
              },
              '6-7': {
                name: 'USSR',
                aircraft: {
                  '1-7': 'Yak-28R',
                  '8-10': 'Su-24MR'
                }
              },
              '8-9': {
                name: 'USSR',
                aircraft: {
                  '1-5': 'MiG-21R',
                  '6-10': 'MiG-25RB'
                }
              },
              '10': {
                name: 'GDR',
                aircraft: {
                  '1-10': 'MiG-21R'
                }
              }
            }
          }
        }
      },
      'K': { 
        name: 'WP Table K - Combat Rescue', 
        faction: 'WP',
        hasNationality: true,
        hasDate: false,
        description: 'WP Combat Rescue - Size of air battle and high number of losses would limit ability to conduct rescue',
        ordnanceNote: 'All flights tasked with Rescue Support may carry any ordnance allowed for the specified aircraft type.',
        nationalities: {
          'USSR': {
            name: 'USSR Combat Rescue Raid',
            flights: [
              {
                type: 'Rescue Support',
                flightSize: 2,
                flightCount: 2,
                description: 'Rescue Support',
                aircraft: {
                  '1-5': 'Su-25',
                  '6-8': 'Su-17M4',
                  '9-10': 'MiG-21bis'
                }
              },
              {
                type: 'CSAR',
                flightSize: 1,
                flightCount: 2,
                description: 'Combat Search and Rescue',
                aircraft: {
                  '1-10': 'Mi-8'
                }
              }
            ]
          },
          'GDR': {
            name: 'GDR Combat Rescue Raid',
            flights: [
              {
                type: 'Rescue Support',
                flightSize: 2,
                flightCount: 2,
                description: 'Rescue Support',
                aircraft: {
                  '1-5': 'MiG-21bis',
                  '6-10': 'MiG-23BN'
                }
              },
              {
                type: 'CSAR',
                flightSize: 1,
                flightCount: 2,
                description: 'Combat Search and Rescue',
                aircraft: {
                  '1-10': 'Mi-8'
                }
              }
            ]
          }
        }
      },
      'L': { 
        name: 'WP Table L - Special Missions', 
        faction: 'WP',
        hasMissionType: true,
        hasNationSelection: true, // Add nation selection for Tactical Recon
        hasDate: false,
        description: 'WP Special Missions - Specialized missions for small numbers of aircraft',
        missionTypes: {
          'Standoff Jamming': {
            name: 'Standoff Jamming',
            flightSize: 1,
            flightCount: 1,
            description: 'Standoff Jamming flights may not carry any ordnance or air-to-air weapons',
            ordnanceNote: 'Standoff Jamming flights may not carry any ordnance or air-to-air weapons.',
            nations: {
              '1-5': {
                name: 'USSR',
                aircraft: {
                  '1-5': 'An-12PP',
                  '6-10': 'Tu-16P'
                }
              },
              '6-10': {
                name: 'GDR',
                aircraft: {
                  '1-10': 'An-26'
                }
              }
            }
          },
          'Tactical Recon': {
            name: 'Tactical Recon',
            flightSize: 2,
            flightCount: 1,
            description: 'Tactical Reconnaissance',
            ordnanceNote: 'Recon flights may only carry air-to-air missiles and guns, if capable. No other ordnance allowed.',
            requiresNationSelection: true, // Nation must be manually selected
            availableNations: ['USSR', 'GDR'], // Available nations for selection
            nationData: {
              'USSR': {
                name: 'USSR',
                aircraft: {
                  '1-2': 'MiG-21R',
                  '3-4': 'Su-17M3R',
                  '5-7': 'Su-24MR',
                  '8-10': 'MiG-25RB'
                }
              },
              'GDR': {
                name: 'GDR',
                aircraft: {
                  '1-5': 'MiG-21R',
                  '6-10': 'Su-22M4R'
                }
              }
            }
          }
        }
      }
    };

    function handleMissionTypeChange() {
      const missionType = document.getElementById('missionType').value;
      const tacticalReconNationSelection = document.getElementById('tacticalReconNationSelection');
      
      // Show nation selection only for WP Table L Tactical Recon
      if (selectedTable === 'L' && missionType === 'Tactical Recon') {
        tacticalReconNationSelection.style.display = 'flex';
      } else {
        tacticalReconNationSelection.style.display = 'none';
      }
    }

    function initializeParameterSelections() {
      // Hide all parameter selection sections initially
      const atafSelection = document.getElementById('atafSelection');
      const nationalitySelection = document.getElementById('nationalitySelection');
      const missionTypeSelection = document.getElementById('missionTypeSelection');
      const tacticalReconNationSelection = document.getElementById('tacticalReconNationSelection');
      
      // Safely hide all dropdowns
      if (atafSelection) atafSelection.style.display = 'none';
      if (nationalitySelection) nationalitySelection.style.display = 'none';
      if (missionTypeSelection) missionTypeSelection.style.display = 'none';
      if (tacticalReconNationSelection) tacticalReconNationSelection.style.display = 'none';
      
      // Reset all dropdown values to defaults
      const atafZone = document.getElementById('atafZone');
      const crewNationality = document.getElementById('crewNationality');
      const missionType = document.getElementById('missionType');
      const tacticalReconNation = document.getElementById('tacticalReconNation');
      
      if (atafZone) atafZone.selectedIndex = 0;
      if (crewNationality) crewNationality.selectedIndex = 0;
      if (missionType) missionType.selectedIndex = 0;
      if (tacticalReconNation) tacticalReconNation.selectedIndex = 0;
      
      // Reset all labels to their default state
      const atafLabel = document.querySelector('label[for="atafZone"]');
      if (atafLabel) atafLabel.textContent = 'ATAF Zone:';
      
      const nationalityLabel = document.querySelector('#nationalitySelection label');
      if (nationalityLabel) nationalityLabel.textContent = 'Nationality of downed crew:';
      
      const missionTypeLabel = document.querySelector('#missionTypeSelection label');
      if (missionTypeLabel) missionTypeLabel.textContent = 'Mission Type:';
      
      // Clear any previous active sections
      document.getElementById('rollInputSection').classList.remove('active');
      document.getElementById('variableSelectionSection').classList.remove('active');
    }

    function selectTable(tableId, faction) {
      // Initialize all parameter selections first
      initializeParameterSelections();
      
      selectedTable = tableId;
      selectedFaction = faction;
      
      const table = oobTables[tableId];
      
      // Check if scenario date is set (except for WP tables and NATO Table D which are not date-dependent)
      if (!scenarioDate && table.hasDate !== false && tableId !== 'D') {
        alert('Please select a scenario date first.');
        return;
      }
      
      // Check if this table has variables that need to be selected
      if (table.hasATAF) {
        const tableName = table.name.split(' - ')[1] || table.name;
        const displayText = `${faction} Table ${tableId} - ${tableName}`;
        document.getElementById('variableTableDisplay').textContent = displayText;
        
        // Show ATAF selection for this table
        const atafSelection = document.getElementById('atafSelection');
        atafSelection.style.display = 'flex';
        
        document.getElementById('variableSelectionSection').classList.add('active');
        document.getElementById('rollCountVariable').focus();
      } else if (table.hasTasking) {
        // Table C/D: Has taskings but no user selection needed - generates all taskings per roll
        const tableName = table.name.split(' - ')[1] || table.name;
        const displayText = `${faction} Table ${tableId} - ${tableName}`;
        document.getElementById('selectedTableDisplay').textContent = displayText;
        document.getElementById('rollInputSection').classList.add('active');
        document.getElementById('rollCountBasic').focus();
      } else if (table.hasNationality) {
        // Table E/K: Combat Rescue - needs nationality selection
        const tableName = table.name.split(' - ')[1] || table.name;
        const displayText = `${faction} Table ${tableId} - ${tableName}`;
        document.getElementById('variableTableDisplay').textContent = displayText;
        
        // Show nationality selection
        const nationalitySelection = document.getElementById('nationalitySelection');
        nationalitySelection.style.display = 'flex';
        
        // Populate dropdown based on faction
        const crewNationalitySelect = document.getElementById('crewNationality');
        crewNationalitySelect.innerHTML = '';
        
        if (faction === 'NATO') {
          crewNationalitySelect.innerHTML = `
            <option value="US">US</option>
            <option value="UK">UK/BE/NE</option>
            <option value="FRG">FRG</option>
            <option value="CAN">CAN (uses US rescue)</option>
          `;
        } else if (faction === 'WP') {
          crewNationalitySelect.innerHTML = `
            <option value="USSR">USSR</option>
            <option value="GDR">GDR</option>
          `;
        }
        
        document.getElementById('variableSelectionSection').classList.add('active');
        document.getElementById('rollCountVariable').focus();
      } else if (table.hasMissionType) {
        // Table F/L: Special Missions - needs mission type selection
        const tableName = table.name.split(' - ')[1] || table.name;
        const displayText = `${faction} Table ${tableId} - ${tableName}`;
        document.getElementById('variableTableDisplay').textContent = displayText;
        
        // Show mission type selection
        const missionTypeSelection = document.getElementById('missionTypeSelection');
        missionTypeSelection.style.display = 'flex';
        
        // Populate dropdown based on faction
        const missionTypeSelect = document.getElementById('missionType');
        missionTypeSelect.innerHTML = '';
        
        if (faction === 'NATO') {
          missionTypeSelect.innerHTML = `
            <option value="Fast FAC">Fast FAC</option>
            <option value="Standoff Jamming">Standoff Jamming</option>
            <option value="Tactical Recon">Tactical Recon</option>
          `;
        } else if (faction === 'WP') {
          missionTypeSelect.innerHTML = `
            <option value="Standoff Jamming">Standoff Jamming</option>
            <option value="Tactical Recon">Tactical Recon</option>
          `;
        }
        
        // Trigger the mission type change handler to show/hide nation selection if needed
        handleMissionTypeChange();
        
        document.getElementById('variableSelectionSection').classList.add('active');
        document.getElementById('rollCountVariable').focus();
      } else {
        // No variables needed, use original flow
        const tableName = table.name.split(' - ')[1] || table.name;
        const displayText = `${faction} Table ${tableId} - ${tableName}`;
        document.getElementById('selectedTableDisplay').textContent = displayText;
        
        document.getElementById('rollInputSection').classList.add('active');
        document.getElementById('rollCountBasic').focus();
      }
    }

    function cancelSelection() {
      selectedTable = null;
      selectedFaction = null;
      document.getElementById('rollInputSection').classList.remove('active');
      document.getElementById('rollCountBasic').value = 1;
    }

    function cancelVariableSelection() {
      selectedTable = null;
      selectedFaction = null;
      document.getElementById('variableSelectionSection').classList.remove('active');
      document.getElementById('rollCountVariable').value = 1;
    }

    function makeRollsWithVariables() {
      if (!selectedTable) return;
      
      const rollCount = parseInt(document.getElementById('rollCountVariable').value);
      if (rollCount < 1 || rollCount > 20) {
        alert('Please enter a number between 1 and 20');
        return;
      }

      const table = oobTables[selectedTable];
      
      // Get variable selections
      let atafZone = null;
      let crewNationality = null;
      let selectedMissionType = null;
      let tacticalReconNation = null;
      
      if (table.hasATAF) {
        atafZone = document.getElementById('atafZone').value;
      } else if (table.hasNationality) {
        crewNationality = document.getElementById('crewNationality').value;
        // Use nationality as atafZone parameter for simplicity
        atafZone = crewNationality;
      } else if (table.hasMissionType) {
        selectedMissionType = document.getElementById('missionType').value;
        
        // For Table L Tactical Recon, get the selected nation
        if (selectedTable === 'L' && selectedMissionType === 'Tactical Recon') {
          tacticalReconNation = document.getElementById('tacticalReconNation').value;
          // Pass mission type and nation as a combined parameter
          atafZone = `${selectedMissionType}|${tacticalReconNation}`;
        } else {
          // Use mission type as atafZone parameter for simplicity
          atafZone = selectedMissionType;
        }
      }
      
      // Use global scenario date instead of dropdown
      const selectedScenarioDate = scenarioDate;
      
      for (let i = 0; i < rollCount; i++) {
        const result = getTableResultWithVariables(selectedTable, atafZone, selectedScenarioDate);
        
        const resultEntry = {
          id: resultCounter++,
          table: selectedTable,
          faction: selectedFaction,
          tableName: table.name,
          atafZone: atafZone,
          scenarioDate: scenarioDate,
          nationRoll: result.nationRoll,
          aircraftRoll: result.aircraftRoll,
          nationName: result.nationName,
          result: result.text,
          debugText: result.debugText || result.debugInfo?.join(' | ') || '', // Handle both debugText and legacy debugInfo
          timestamp: new Date().getTime() + i // Ensure unique timestamps
        };
        
        results.unshift(resultEntry);
        hasGeneratedResults = true; // Mark that results exist
      }
      
      updateResultsDisplay();
      updateDateButtonStates(); // Update button states
    }

    function viewTableWithVariables() {
      if (!selectedTable) return;
      
      const table = oobTables[selectedTable];
      let atafZone = null;
      
      if (table.hasATAF) {
        atafZone = document.getElementById('atafZone').value;
      } else if (table.hasNationality) {
        atafZone = document.getElementById('crewNationality').value;
      } else if (table.hasMissionType) {
        atafZone = document.getElementById('missionType').value;
      }
      
      // Use global scenario date
      const selectedScenarioDate = scenarioDate;
      
      viewTableStructure(selectedTable, atafZone, selectedScenarioDate);
    }

    function makeRolls() {
      if (!selectedTable) return;
      
      const rollCount = parseInt(document.getElementById('rollCountBasic').value);
      if (rollCount < 1 || rollCount > 20) {
        alert('Please enter a number between 1 and 20');
        return;
      }

      // Check if Table C or D and scenario date is required
      if ((selectedTable === 'C' || selectedTable === 'D') && selectedTable !== 'D' && !scenarioDate) {
        alert('Please select a scenario date first.');
        return;
      }

      const table = oobTables[selectedTable];
      
      for (let i = 0; i < rollCount; i++) {
        let result;
        console.log(`Making roll ${i+1} for table ${selectedTable}`);
        
        // Tables with multiple taskings need special handling
        if (selectedTable === 'C') {
          result = getTableResultWithVariables(selectedTable, null, scenarioDate);
        } else if (selectedTable === 'D') {
          result = getTableResultWithVariables(selectedTable, null, null);
        } else if (selectedTable === 'I' || selectedTable === 'J') {
          console.log(`Routing ${selectedTable} to getTableResultWithVariables`);
          result = getTableResultWithVariables(selectedTable, null, null);
        } else {
          result = getTableResult(selectedTable);
        }
        
        console.log(`Result for ${selectedTable}:`, result);
        
        const resultEntry = {
          id: resultCounter++,
          table: selectedTable,
          faction: selectedFaction,
          tableName: table.name,
          nationRoll: result.nationRoll,
          aircraftRoll: result.aircraftRoll,
          result: result.text,
          debugText: result.debugText || result.debugInfo?.join(' | ') || '', // Handle both debugText and legacy debugInfo
          scenarioDate: selectedTable === 'C' ? scenarioDate : undefined,
          timestamp: new Date().getTime() + i // Ensure unique timestamps
        };
        
        console.log(`Result entry for display:`, resultEntry);
        
        results.unshift(resultEntry);
        hasGeneratedResults = true; // Mark that results exist
      }
      
      updateResultsDisplay();
      updateDateButtonStates(); // Update button states
      cancelSelection();
    }

    function getTableResultWithVariables(tableId, atafZone, scenarioDate) {
      console.log(`getTableResultWithVariables called with tableId: ${tableId}`);
      console.log(`Checking conditions: tableId === 'I' is ${tableId === 'I'}`);
      
      // DIRECT TABLE I INTERCEPT - Handle Table I first before anything else
      if (tableId === 'I') {
        console.log('DIRECT Table I intercept activated!');
        const table = oobTables[tableId];
        console.log('Table I object:', table);
        
        try {
          // Table I: Warsaw Pact Bombing Raid - nationality-based like Table K
          // First roll for nationality: 1-8 USSR, 9-10 GDR
          const nationalityRollResult = makeDebugRoll(10, 'Nationality');
          const nationalityRoll = nationalityRollResult.roll;
          
          let selectedNationality;
          if (nationalityRoll <= 8) {
            selectedNationality = 'USSR';
          } else {
            selectedNationality = 'GDR';
          }
          
          console.log(`Nationality roll: ${nationalityRoll} ‚Üí ${selectedNationality}`);
          
          const nationalityData = table.nationalities[selectedNationality];
          if (!nationalityData) {
            return {
              nationRoll: nationalityRoll,
              aircraftRoll: null,
              text: `Error: Unknown nationality ${selectedNationality}`,
              debugText: ''
            };
          }
          
          const results = [];
          
          // Generate results for each tasking (Close Escort, SEAD, Bombing)
          for (const [taskingName, taskingData] of Object.entries(nationalityData.taskings)) {
            console.log(`Processing tasking: ${taskingName}`);
            
            // Roll for aircraft within this tasking
            const aircraftRollResult = makeDebugRoll(10, `${taskingName} Aircraft`);
            const aircraftRoll = aircraftRollResult.roll;
            let aircraftType = null;
            let subRollResult = null;
            
            // Find matching aircraft based on roll ranges
            for (const [range, aircraft] of Object.entries(taskingData.aircraft)) {
              const [min, max] = parseRange(range);
              if (aircraftRoll >= min && aircraftRoll <= max) {
                aircraftType = aircraft;
                break;
              }
            }
            
            if (!aircraftType) {
              results.push({
                tasking: taskingName,
                text: `Error: No aircraft found for ${taskingName} roll ${aircraftRoll}`
              });
              continue;
            }
            
            // Handle hidden sub-rolls for superscript references (applies to ALL aircraft in tasking)
            let finalAircraftType = aircraftType;
            if (aircraftType && (aircraftType.includes('¬≤') || aircraftType.includes('¬π'))) {
              subRollResult = makeDebugRoll(10, `${taskingName} Sub-roll`);
              if (aircraftType.includes('MiG-23¬≤')) {
                if (subRollResult.roll <= 4) finalAircraftType = 'MiG-23M';
                else if (subRollResult.roll <= 8) finalAircraftType = 'MiG-23MF';
                else finalAircraftType = 'MiG-23ML';
              } else if (aircraftType.includes('MiG-23MF/ML¬π')) {
                // Sub-roll: 1-5 MiG-23MF, 6-10 MiG-23ML
                finalAircraftType = subRollResult.roll <= 5 ? 'MiG-23MF' : 'MiG-23ML';
              }
            }
            
            // Ordnance table for Table I - differs by nationality
            function getOrdnanceAvailabilityTableI(roll, nationality, aircraftType = '', tasking = '') {
              // Apply die roll modifiers for specific aircraft types
              let modifiedRoll = roll;
              if (aircraftType.includes('Su-17M4') || aircraftType.includes('MiG-27K')) {
                modifiedRoll += 1;
              } else if (aircraftType.includes('Su-24')) {
                modifiedRoll += 2;
              }
              
              // Cap the modified roll at 10
              modifiedRoll = Math.min(modifiedRoll, 10);
              
              let ordnance;
              if (nationality === 'USSR') {
                // USSR: 1-5 Bombs/CBU/Rockets, 6-7 +EOGM/ARM, 8-10 +EOGB/LGB
                if (modifiedRoll <= 5) ordnance = "Bombs/CBU/Rockets";
                else if (modifiedRoll <= 7) ordnance = "Bombs/CBU/Rockets + EOGM/ARM";
                else ordnance = "Bombs/CBU/Rockets + EOGM/ARM + EOGB/LGB";
              } else {
                // GDR: 1-6 Bombs/CBU/Rockets, 7-10 +EOGM
                if (modifiedRoll <= 6) ordnance = "Bombs/CBU/Rockets";
                else ordnance = "Bombs/CBU/Rockets + EOGM";
              }
              
              // Add ARM to SEAD flights
              if (tasking === 'SEAD') {
                ordnance += " + ARM";
              }
              
              return ordnance;
            }
            
            let resultText = '';
            let ordnanceRolls = []; // Track ordnance rolls for debug
            
            // Handle ordnance for SEAD and Bombing flights
            if (taskingName === 'Close Escort') {
              // Close Escort flights remain grouped (no ordnance)
              resultText = `${selectedNationality}: ${taskingData.flightCount} x {${taskingData.flightSize}} ${finalAircraftType}, ${taskingName}`;
            } else if (taskingName === 'SEAD' || taskingName === 'Bombing') {
              // SEAD and Bombing flights get individual ordnance rolls
              const individualFlights = [];
              
              for (let i = 1; i <= taskingData.flightCount; i++) {
                const ordnanceRollResult = makeDebugRoll(10, `${taskingName} Flight ${i} Ordnance`);
                const ordnance = getOrdnanceAvailabilityTableI(ordnanceRollResult.roll, selectedNationality, finalAircraftType, taskingName);
                ordnanceRolls.push(ordnanceRollResult);
                
                individualFlights.push(`${selectedNationality}: 1 x {${taskingData.flightSize}} ${finalAircraftType}, ${taskingName} (${ordnance})`);
              }
              
              resultText = individualFlights.join('<br>');
            }
            
            console.log(`Result text for ${taskingName}:`, resultText);
            
            // Build debug text for this tasking
            let taskingDebugText = '';
            if (debugMode) {
              taskingDebugText = `[${taskingName}: ${aircraftRollResult.debugEntry} ‚Üí ${finalAircraftType}`;
              if (subRollResult) {
                taskingDebugText += ` | ${subRollResult.debugEntry} ‚Üí ${finalAircraftType}`;
              }
              
              // Add ordnance debug info for SEAD and Bombing
              if ((taskingName === 'SEAD' || taskingName === 'Bombing') && ordnanceRolls.length > 0) {
                const ordnanceDebugEntries = ordnanceRolls.map((roll, i) => 
                  `Flight ${i+1} Ordnance: ${roll.roll}`
                ).join(' | ');
                taskingDebugText += ` | ${ordnanceDebugEntries}`;
              }
              
              taskingDebugText += ']';
            }
            
            results.push({
              tasking: taskingName,
              text: resultText,
              debugText: taskingDebugText
            });
          }
          
          // Combine nationality roll with all tasking debug texts
          const allDebugTexts = results.map(r => r.debugText).filter(Boolean);
          let combinedDebugText = '';
          if (debugMode) {
            const debugParts = [`Nationality: ${nationalityRollResult.debugEntry} ‚Üí ${selectedNationality}`];
            if (allDebugTexts.length > 0) {
              debugParts.push(...allDebugTexts);
            }
            combinedDebugText = debugParts.length > 0 ? debugParts.join(' ') : '';
          }
          
          const finalResult = {
            taskingResults: results,
            text: results.map(r => r.text).join('<br>'),
            debugText: combinedDebugText
          };
          
          console.log('Table I DIRECT final result:', finalResult);
          return finalResult;
          
        } catch (error) {
          console.error('Error in Table I direct processing:', error);
          return {
            nationRoll: null,
            aircraftRoll: null,
            text: `Error processing Table I: ${error.message}`,
            debugText: ''
          };
        }
      }
      
      // DIRECT TABLE J INTERCEPT - Handle Table J like Table I (with nation rolls)
      if (tableId === 'J') {
        console.log('DIRECT Table J intercept activated!');
        const table = oobTables[tableId];
        console.log('Table J object:', table);
        
        try {
          // Table J: Warsaw Pact Deep Strike Raid - generates ALL taskings
          const allTaskings = Object.keys(table.taskings);
          console.log('Table J taskings:', allTaskings);
          const results = [];
          
          for (const taskingName of allTaskings) {
            console.log(`Processing tasking: ${taskingName}`);
            const taskingData = table.taskings[taskingName];
            
            // Roll for nation (like Table I)
            const nationRollResult = makeDebugRoll(10, `${taskingName} Nation`);
            const nationRoll = nationRollResult.roll;
            
            // Determine nation based on roll
            let selectedNation = null;
            let selectedNationName = '';
            for (const [range, nation] of Object.entries(taskingData.nations)) {
              const [min, max] = parseRange(range);
              if (nationRoll >= min && nationRoll <= max) {
                selectedNation = nation;
                selectedNationName = nation.name;
                break;
              }
            }
            
            if (!selectedNation) {
              results.push({
                tasking: taskingName,
                text: `Error: No nation found for ${taskingName} roll ${nationRoll}`
              });
              continue;
            }
            
            // Roll for aircraft for this tasking
            const aircraftRollResult = makeDebugRoll(10, `${taskingName} Aircraft`);
            const aircraftRoll = aircraftRollResult.roll;
            let aircraftType = null;
            
            // Find matching aircraft based on roll ranges
            for (const [range, aircraft] of Object.entries(selectedNation.aircraft)) {
              const [min, max] = parseRange(range);
              if (aircraftRoll >= min && aircraftRoll <= max) {
                aircraftType = aircraft;
                break;
              }
            }
            
            if (!aircraftType) {
              results.push({
                tasking: taskingName,
                text: `Error: No aircraft found for ${taskingName} roll ${aircraftRoll}`
              });
              continue;
            }
            
            const resultText = `${selectedNationName}: ${taskingData.flightCount} x {${taskingData.flightSize}} ${aircraftType}, ${taskingName}`;
            console.log(`Result text for ${taskingName}:`, resultText);
            
            // Build debug text for this tasking
            let taskingDebugText = '';
            if (debugMode) {
              taskingDebugText = `[${taskingName}: ${nationRollResult.debugEntry} ‚Üí ${selectedNationName} | ${aircraftRollResult.debugEntry} ‚Üí ${aircraftType}]`;
            }
            
            results.push({
              tasking: taskingName,
              text: resultText,
              debugText: taskingDebugText
            });
          }
          
          // Combine all debug texts for Table J
          const allDebugTexts = results.map(r => r.debugText).filter(Boolean);
          const combinedDebugText = allDebugTexts.length > 0 ? allDebugTexts.join(' ') : '';
          
          const finalResult = {
            taskingResults: results,
            text: results.map(r => r.text).join('<br>'),
            debugText: combinedDebugText
          };
          
          console.log('Table J DIRECT final result:', finalResult);
          return finalResult;
          
        } catch (error) {
          console.error('Error in Table J direct processing:', error);
          return {
            nationRoll: null,
            aircraftRoll: null,
            text: `Error processing Table J: ${error.message}`,
            debugText: ''
          };
        }
      }
      
      const table = oobTables[tableId];
      console.log(`Table object:`, table);
      
      if (tableId === 'A') {
        // Table A: NATO QRA Flight - two-roll system with variables
        const variant = table.variants[atafZone][scenarioDate];
        const nationRollResult = makeDebugRoll(10, 'Nation');
        const nationRoll = nationRollResult.roll;
        
        // Determine nation based on roll and variant
        let selectedNation, nationName;
        for (const [nationRange, nationData] of Object.entries(variant.nations)) {
          const [min, max] = parseRange(nationRange);
          if (nationRoll >= min && nationRoll <= max) {
            selectedNation = nationData;
            nationName = nationData.name;
            break;
          }
        }
        
        // Roll for aircraft within that nation
        const aircraftRollResult = makeDebugRoll(10, 'Aircraft');
        const aircraftRoll = aircraftRollResult.roll;
        let aircraftType = null;
        
        // Find matching aircraft based on roll ranges
        for (const [range, aircraft] of Object.entries(selectedNation.aircraft)) {
          const [min, max] = parseRange(range);
          if (aircraftRoll >= min && aircraftRoll <= max) {
            // Use aircraft name exactly as defined in source data
            aircraftType = aircraft;
            break;
          }
        }
        
        const resultText = `${nationName}: 1 x {${table.flightSize}} ${aircraftType}, CAP`;
        
        // Build simple debug string
        let debugText = '';
        if (debugMode) {
          const debugParts = [nationRollResult.debugEntry, aircraftRollResult.debugEntry].filter(Boolean);
          debugText = debugParts.length > 0 ? `[${debugParts.join(' | ')}]` : '';
        }
        
        return {
          nationRoll: nationRoll,
          aircraftRoll: aircraftRoll,
          nationName: nationName,
          text: resultText,
          debugText: debugText
        };
      }
      
      if (tableId === 'B') {
        // Table B: NATO CAP Flight - uses zones structure
        const zoneData = table.zones[atafZone][scenarioDate];
        const nationRollResult = makeDebugRoll(10, 'Nation');
        const nationRoll = nationRollResult.roll;
        
        let selectedNation = null;
        let selectedNationName = '';
        
        // Find which nation this roll corresponds to
        for (const [range, nationData] of Object.entries(zoneData.nations)) {
          const [min, max] = parseRange(range);
          if (nationRoll >= min && nationRoll <= max) {
            selectedNation = nationData;
            selectedNationName = nationData.name;
            break;
          }
        }
        
        if (!selectedNation) {
          return {
            nationRoll: nationRoll,
            aircraftRoll: null,
            text: `Error: No nation found for roll ${nationRoll}`,
            debugText: debugMode ? `[${nationRollResult.debugEntry}]` : ''
          };
        }
        
        // Roll for aircraft type
        const aircraftRollResult = makeDebugRoll(10, 'Aircraft');
        const aircraftRoll = aircraftRollResult.roll;
        let selectedAircraft = null;
        
        // Find which aircraft this roll corresponds to
        for (const [range, aircraft] of Object.entries(selectedNation.aircraft)) {
          const [min, max] = parseRange(range);
          if (aircraftRoll >= min && aircraftRoll <= max) {
            selectedAircraft = aircraft;
            break;
          }
        }
        
        if (!selectedAircraft) {
          return {
            nationRoll: nationRoll,
            aircraftRoll: aircraftRoll,
            text: `Error: No aircraft found for roll ${aircraftRoll}`,
            debugText: debugMode ? `[${nationRollResult.debugEntry} | ${aircraftRollResult.debugEntry}]` : ''
          };
        }
        
        // Build simple debug string
        let debugText = '';
        if (debugMode) {
          const debugParts = [nationRollResult.debugEntry, aircraftRollResult.debugEntry].filter(Boolean);
          debugText = debugParts.length > 0 ? `[${debugParts.join(' | ')}]` : '';
        }
        
        return {
          nationRoll: nationRoll,
          aircraftRoll: aircraftRoll,
          nationName: selectedNationName,
          text: `${selectedNationName}: 1 x {2} ${selectedAircraft}, CAP`,
          debugText: debugText
        };
      }
      
      if (tableId === 'C') {
        // Table C: NATO Bombing Raid - three-tasking system with ordnance availability
        const dateVariant = scenarioDate;
        const taskingData = table.taskings;
        
        const results = [];
        const taskings = ['CAP', 'SEAD', 'Bombing'];
        const flightSizes = { 'CAP': 2, 'SEAD': 2, 'Bombing': 4 };
        const flightCounts = { 'CAP': 4, 'SEAD': 4, 'Bombing': 4 };
        
        // Ordnance table: 1-4 Bombs/CBU/Rockets, 5-7 Bombs/CBU/Rockets + EOGM, 8-10 Bombs/CBU/Rockets + EOGM + LGB/EOGB
        function getOrdnanceAvailability(roll, aircraftType = '', tasking = '') {
          // Apply die roll modifiers for specific aircraft types
          let modifiedRoll = roll;
          if (aircraftType.includes('F-16') || aircraftType.includes('A-10')) {
            modifiedRoll += 2;
          } else if (aircraftType.includes('Tornado GR1') || aircraftType.includes('Tornado IDS') || aircraftType.includes('CF-18')) {
            modifiedRoll += 1;
          }
          
          // Cap the modified roll at 10
          modifiedRoll = Math.min(modifiedRoll, 10);
          
          let ordnance;
          if (modifiedRoll <= 4) ordnance = "Bombs/CBU/Rockets";
          else if (modifiedRoll <= 7) ordnance = "Bombs/CBU/Rockets + EOGM";
          else ordnance = "Bombs/CBU/Rockets + EOGM + LGB/EOGB";
          
          // Add ARM to SEAD flights
          if (tasking === 'SEAD') {
            ordnance += " + ARM";
          }
          
          return ordnance;
        }
        
        for (const tasking of taskings) {
          const taskingVariant = taskingData[tasking][dateVariant];
          
          // Roll for nation
          const nationRollResult = makeDebugRoll(10, `${tasking} Nation`);
          const nationRoll = nationRollResult.roll;
          let selectedNation = null;
          let selectedNationName = '';
          let aircraftRollResult = null;
          let subRollResult = null;
          
          for (const [range, nationData] of Object.entries(taskingVariant.nations)) {
            const [min, max] = parseRange(range);
            if (nationRoll >= min && nationRoll <= max) {
              selectedNation = nationData;
              selectedNationName = nationData.name;
              break;
            }
          }
          
          if (!selectedNation) {
            results.push({
              tasking: tasking,
              nationRoll: nationRoll,
              aircraftRoll: null,
              text: `Error: No nation found for ${tasking} roll ${nationRoll}`
            });
            continue;
          }
          
          // Roll for aircraft
          aircraftRollResult = makeDebugRoll(10, `${tasking} Aircraft`);
          const aircraftRoll = aircraftRollResult.roll;
          let selectedAircraft = null;
          
          for (const [range, aircraft] of Object.entries(selectedNation.aircraft)) {
            const [min, max] = parseRange(range);
            if (aircraftRoll >= min && aircraftRoll <= max) {
              selectedAircraft = aircraft;
              break;
            }
          }
          
          if (!selectedAircraft) {
            results.push({
              tasking: tasking,
              nationRoll: nationRoll,
              aircraftRoll: aircraftRoll,
              text: `Error: No aircraft found for ${tasking} roll ${aircraftRoll}`
            });
            continue;
          }
          
          // Handle aircraft sub-rolls BEFORE ordnance (applies to ALL aircraft in tasking)
          let finalAircraftType = selectedAircraft;
          if (selectedAircraft === 'F-4¬≤') {
            subRollResult = makeDebugRoll(10, `${tasking} Sub-roll`);
            finalAircraftType = subRollResult.roll <= 5 ? 'F-4D' : 'F-4E';
          }
          
          const flightSize = flightSizes[tasking];
          const flightCount = flightCounts[tasking];
          let resultText = '';
          let taskingDebugText = '';
          
          // Handle special aircraft combinations (maintain existing logic for split flights)
          if (tasking === 'SEAD' && selectedNationName === 'US' && selectedAircraft === 'F-4G/F-4E') {
            // Split F-4G/F-4E into separate flights with ordnance
            const f4gFlights = [];
            const f4eFlights = [];
            const ordnanceRolls = [];
            
            // Generate ordnance for each F-4G flight (2 flights)
            for (let i = 1; i <= 2; i++) {
              const ordnanceRollResult = makeDebugRoll(10, `${tasking} F-4G Flight ${i} Ordnance`);
              const ordnance = getOrdnanceAvailability(ordnanceRollResult.roll, 'F-4G', tasking);
              ordnanceRolls.push(ordnanceRollResult);
              f4gFlights.push(`1 x {${flightSize}} ${selectedNationName} F-4G, ${tasking} (${ordnance})`);
            }
            
            // Generate ordnance for each F-4E flight (2 flights)
            for (let i = 1; i <= 2; i++) {
              const ordnanceRollResult = makeDebugRoll(10, `${tasking} F-4E Flight ${i} Ordnance`);
              const ordnance = getOrdnanceAvailability(ordnanceRollResult.roll, 'F-4E', tasking);
              ordnanceRolls.push(ordnanceRollResult);
              f4eFlights.push(`1 x {${flightSize}} ${selectedNationName} F-4E, ${tasking} (${ordnance})`);
            }
            
            resultText = [...f4gFlights, ...f4eFlights].join('<br>');
            
            if (debugMode) {
              const ordnanceDebugEntries = ordnanceRolls.map((roll, i) => {
                const aircraftType = i < 2 ? 'F-4G' : 'F-4E';
                const flightNum = (i % 2) + 1;
                return `${aircraftType} Flight ${flightNum} Ordnance: ${roll.roll}`;
              }).join(' | ');
              
              taskingDebugText = `[${tasking}: ${nationRollResult.debugEntry} | ${aircraftRollResult.debugEntry} | ${ordnanceDebugEntries}]`;
            }
          } else if (tasking === 'SEAD' && selectedNationName === 'US' && selectedAircraft === 'F-4G/F-16C') {
            // Split F-4G/F-16C into separate flights with ordnance
            const f4gFlights = [];
            const f16cFlights = [];
            const ordnanceRolls = [];
            
            // Generate ordnance for each F-4G flight (2 flights)
            for (let i = 1; i <= 2; i++) {
              const ordnanceRollResult = makeDebugRoll(10, `${tasking} F-4G Flight ${i} Ordnance`);
              const ordnance = getOrdnanceAvailability(ordnanceRollResult.roll, 'F-4G', tasking);
              ordnanceRolls.push(ordnanceRollResult);
              f4gFlights.push(`1 x {${flightSize}} ${selectedNationName} F-4G, ${tasking} (${ordnance})`);
            }
            
            // Generate ordnance for each F-16C flight (2 flights)
            for (let i = 1; i <= 2; i++) {
              const ordnanceRollResult = makeDebugRoll(10, `${tasking} F-16C Flight ${i} Ordnance`);
              const ordnance = getOrdnanceAvailability(ordnanceRollResult.roll, 'F-16C', tasking);
              ordnanceRolls.push(ordnanceRollResult);
              f16cFlights.push(`1 x {${flightSize}} ${selectedNationName} F-16C, ${tasking} (${ordnance})`);
            }
            
            resultText = [...f4gFlights, ...f16cFlights].join('<br>');
            
            if (debugMode) {
              const ordnanceDebugEntries = ordnanceRolls.map((roll, i) => {
                const aircraftType = i < 2 ? 'F-4G' : 'F-16C';
                const flightNum = (i % 2) + 1;
                return `${aircraftType} Flight ${flightNum} Ordnance: ${roll.roll}`;
              }).join(' | ');
              
              taskingDebugText = `[${tasking}: ${nationRollResult.debugEntry} | ${aircraftRollResult.debugEntry} | ${ordnanceDebugEntries}]`;
            }
          } else if (tasking === 'CAP') {
            // CAP flights remain grouped (no ordnance)
            resultText = `${flightCount} x {${flightSize}} ${selectedNationName} ${finalAircraftType}, ${tasking}`;
            
            if (debugMode) {
              taskingDebugText = `[${tasking}: ${nationRollResult.debugEntry} | ${aircraftRollResult.debugEntry}`;
              if (subRollResult) {
                taskingDebugText += ` | ${subRollResult.debugEntry} ‚Üí ${finalAircraftType}`;
              }
              taskingDebugText += ']';
            }
          } else if (tasking === 'SEAD' || tasking === 'Bombing') {
            // SEAD and Bombing flights get individual ordnance rolls
            const individualFlights = [];
            const ordnanceRolls = [];
            
            for (let i = 1; i <= flightCount; i++) {
              const ordnanceRollResult = makeDebugRoll(10, `${tasking} Flight ${i} Ordnance`);
              const ordnance = getOrdnanceAvailability(ordnanceRollResult.roll, finalAircraftType, tasking);
              ordnanceRolls.push(ordnanceRollResult);
              
              individualFlights.push(`1 x {${flightSize}} ${selectedNationName} ${finalAircraftType}, ${tasking} (${ordnance})`);
            }
            
            resultText = individualFlights.join('<br>');
            
            if (debugMode) {
              const ordnanceDebugEntries = ordnanceRolls.map((roll, i) => 
                `Flight ${i+1} Ordnance: ${roll.roll}`
              ).join(' | ');
              
              taskingDebugText = `[${tasking}: ${nationRollResult.debugEntry} | ${aircraftRollResult.debugEntry}`;
              if (subRollResult) {
                taskingDebugText += ` | ${subRollResult.debugEntry} ‚Üí ${finalAircraftType}`;
              }
              taskingDebugText += ` | ${ordnanceDebugEntries}]`;
            }
          }
          
          results.push({
            tasking: tasking,
            nationRoll: nationRoll,
            aircraftRoll: aircraftRoll,
            nationName: selectedNationName,
            text: resultText,
            debugText: taskingDebugText
          });
        }
        
        // Combine all debug texts for Table C
        const allDebugTexts = results.map(r => r.debugText).filter(Boolean);
        const combinedDebugText = allDebugTexts.length > 0 ? allDebugTexts.join(' ') : '';
        
        return {
          taskingResults: results,
          text: results.map(r => r.text).join('<br>'),
          debugText: combinedDebugText
        };
      } else if (tableId === 'D') {
        // Table D: NATO Deep Strike Raid - five-tasking system
        const taskingData = table.taskings;
        
        const results = [];
        const taskings = ['Escort Jamming', 'CAP', 'SEAD', 'Bombing', 'Recon'];
        const flightSizes = { 'Escort Jamming': 1, 'CAP': 2, 'SEAD': 2, 'Bombing': 4, 'Recon': 2 };
        const flightCounts = { 'Escort Jamming': 2, 'CAP': 4, 'SEAD': 4, 'Bombing': 4, 'Recon': 2 };
        
        for (const tasking of taskings) {
          const taskingVariant = taskingData[tasking];
          
          // Roll for nation
          const nationRollResult = makeDebugRoll(10, `${tasking} Nation`);
          const nationRoll = nationRollResult.roll;
          let selectedNation = null;
          let selectedNationName = '';
          let aircraftRollResult = null;
          
          for (const [range, nationData] of Object.entries(taskingVariant.nations)) {
            const [min, max] = parseRange(range);
            if (nationRoll >= min && nationRoll <= max) {
              selectedNation = nationData;
              selectedNationName = nationData.name;
              break;
            }
          }
          
          if (!selectedNation) {
            results.push({
              tasking: tasking,
              nationRoll: nationRoll,
              aircraftRoll: null,
              text: `Error: No nation found for ${tasking} roll ${nationRoll}`
            });
            continue;
          }
          
          // Roll for aircraft
          aircraftRollResult = makeDebugRoll(10, `${tasking} Aircraft`);
          const aircraftRoll = aircraftRollResult.roll;
          let selectedAircraft = null;
          
          for (const [range, aircraft] of Object.entries(selectedNation.aircraft)) {
            const [min, max] = parseRange(range);
            if (aircraftRoll >= min && aircraftRoll <= max) {
              selectedAircraft = aircraft;
              break;
            }
          }
          
          if (!selectedAircraft) {
            results.push({
              tasking: tasking,
              nationRoll: nationRoll,
              aircraftRoll: aircraftRoll,
              text: `Error: No aircraft found for ${tasking} roll ${aircraftRoll}`
            });
            continue;
          }
          
          const flightSize = flightSizes[tasking];
          const flightCount = flightCounts[tasking];
          let resultText = '';
          
          // Handle special cases with superscript references for Table D
          if (tableId === 'D' && tasking === 'SEAD' && selectedNationName === 'US' && selectedAircraft === 'F-4G/F-4E') {
            // Table D Reference: Split F-4G/F-4E into separate flights (rolls 7-9)
            resultText = `2 x {${flightSize}} ${selectedNationName} F-4G, 2 x {${flightSize}} ${selectedNationName} F-4E, ${tasking}`;
          } else if (tableId === 'D' && tasking === 'SEAD' && selectedNationName === 'US' && selectedAircraft === 'F-4G/F-16C') {
            // Table D Reference: Split F-4G/F-16C into separate flights (roll 10)
            resultText = `2 x {${flightSize}} ${selectedNationName} F-4G, 2 x {${flightSize}} ${selectedNationName} F-16C, ${tasking}`;
          } else {
            // Standard result
            resultText = `${flightCount} x {${flightSize}} ${selectedNationName} ${selectedAircraft}, ${tasking}`;
          }
          
          // Collect debug text for this tasking
          let taskingDebugText = '';
          if (debugMode) {
            taskingDebugText = `[${tasking}: ${nationRollResult.debugEntry} | ${aircraftRollResult.debugEntry}]`;
          }
          
          results.push({
            tasking: tasking,
            nationRoll: nationRoll,
            aircraftRoll: aircraftRoll,
            nationName: selectedNationName,
            text: resultText,
            debugText: taskingDebugText
          });
        }
        
        // Combine all debug texts for Table D
        const allDebugTexts = results.map(r => r.debugText).filter(Boolean);
        const combinedDebugText = allDebugTexts.length > 0 ? allDebugTexts.join(' ') : '';
        
        return {
          taskingResults: results,
          text: results.map(r => r.text).join('<br>'),
          debugText: combinedDebugText
        };
      } else if (tableId === 'E') {
        // Table E: NATO Combat Rescue - nationality-based system
        // The nationality should be passed via the atafZone parameter for simplicity
        let selectedNationality = atafZone;
        
        // Handle nationality mapping (UK/BE/NE crews all get UK rescue)
        if (selectedNationality === 'UK' || selectedNationality === 'BE' || selectedNationality === 'NE') {
          selectedNationality = 'UK';
        } else if (selectedNationality === 'CAN') {
          // CAN crews use US rescue
          selectedNationality = 'US';
        }
        
        const nationalityData = table.nationalities[selectedNationality];
        if (!nationalityData) {
          return {
            text: `Error: Unknown nationality ${selectedNationality}`
          };
        }
        
        const results = [];
        
        // Generate each flight type for this nationality
        for (const flightData of nationalityData.flights) {
          // Roll for aircraft type
          const aircraftRollResult = makeDebugRoll(10, `${flightData.type} Aircraft`);
          const aircraftRoll = aircraftRollResult.roll;
          let selectedAircraft = null;
          
          for (const [range, aircraft] of Object.entries(flightData.aircraft)) {
            const [min, max] = parseRange(range);
            if (aircraftRoll >= min && aircraftRoll <= max) {
              selectedAircraft = aircraft;
              break;
            }
          }
          
          if (!selectedAircraft) {
            results.push({
              flightType: flightData.type,
              aircraftRoll: aircraftRoll,
              text: `Error: No aircraft found for ${flightData.type} roll ${aircraftRoll}`
            });
            continue;
          }
          
          const resultText = `${flightData.flightCount} x {${flightData.flightSize}} ${selectedAircraft}, ${flightData.type}`;
          
          // Build debug information for this flight type
          let flightDebugText = '';
          if (debugMode) {
            flightDebugText = `[${aircraftRollResult.debugEntry}]`;
          }
          
          results.push({
            flightType: flightData.type,
            aircraftRoll: aircraftRoll,
            text: resultText,
            debugText: flightDebugText
          });
        }
        
        // Combine all debug texts for Table E
        const allDebugTexts = results.map(r => r.debugText).filter(Boolean);
        const combinedDebugText = allDebugTexts.length > 0 ? allDebugTexts.join(' ') : '';
        
        return {
          nationality: selectedNationality,
          raidType: nationalityData.name,
          flightResults: results,
          text: results.map(r => r.text).join('<br>'),
          debugText: combinedDebugText
        };
      } else if (tableId === 'F') {
        // Table F: NATO Special Missions - mission-type based system
        const selectedMissionType = atafZone; // Mission type passed via atafZone parameter
        
        const missionData = table.missionTypes[selectedMissionType];
        if (!missionData) {
          return {
            text: `Error: Unknown mission type ${selectedMissionType}`
          };
        }
        
        // Roll for nation
        const nationRollResult = makeDebugRoll(10, 'Nation');
        const nationRoll = nationRollResult.roll;
        let selectedNation = null;
        let selectedNationName = '';
        
        for (const [range, nationData] of Object.entries(missionData.nations)) {
          const [min, max] = parseRange(range);
          if (nationRoll >= min && nationRoll <= max) {
            selectedNation = nationData;
            selectedNationName = nationData.name;
            break;
          }
        }
        
        if (!selectedNation) {
          return {
            nationRoll: nationRoll,
            aircraftRoll: null,
            text: `Error: No nation found for ${selectedMissionType} roll ${nationRoll}`
          };
        }
        
        // Roll for aircraft
        const aircraftRollResult = makeDebugRoll(10, 'Aircraft');
        const aircraftRoll = aircraftRollResult.roll;
        let selectedAircraft = null;
        
        for (const [range, aircraft] of Object.entries(selectedNation.aircraft)) {
          const [min, max] = parseRange(range);
          if (aircraftRoll >= min && aircraftRoll <= max) {
            selectedAircraft = aircraft;
            break;
          }
        }
        
        if (!selectedAircraft) {
          return {
            nationRoll: nationRoll,
            aircraftRoll: aircraftRoll,
            text: `Error: No aircraft found for ${selectedMissionType} roll ${aircraftRoll}`
          };
        }
        
        const resultText = `${missionData.flightCount} x {${missionData.flightSize}} ${selectedNationName} ${selectedAircraft}, ${selectedMissionType}`;
        
        // Build simple debug string
        let debugText = '';
        if (debugMode) {
          const debugParts = [nationRollResult.debugEntry, aircraftRollResult.debugEntry].filter(Boolean);
          debugText = debugParts.length > 0 ? `[${debugParts.join(' | ')}]` : '';
        }
        
        return {
          missionType: selectedMissionType,
          nationRoll: nationRoll,
          aircraftRoll: aircraftRoll,
          nationName: selectedNationName,
          text: resultText,
          debugText: debugText
        };
      }
      
      if (tableId === 'K') {
        // Warsaw Pact Table K: Combat Rescue - nationality-based
        const nationalityData = table.nationalities[atafZone];
        if (!nationalityData) {
          return {
            nationRoll: null,
            aircraftRoll: null,
            text: `Error: Unknown nationality ${atafZone}`,
            debugText: ''
          };
        }

        let resultParts = [];
        let debugParts = [];
        
        // Generate results for each flight type
        nationalityData.flights.forEach(flightType => {
          const aircraftRollResult = makeDebugRoll(10, `${flightType.type} Aircraft`);
          const aircraftRoll = aircraftRollResult.roll;
          let aircraftType = null;
          
          // Find matching aircraft based on roll ranges
          for (const [range, aircraft] of Object.entries(flightType.aircraft)) {
            const [min, max] = parseRange(range);
            if (aircraftRoll >= min && aircraftRoll <= max) {
              aircraftType = aircraft;
              break;
            }
          }
          
          if (aircraftType) {
            resultParts.push(`${flightType.flightCount} x {${flightType.flightSize}} ${aircraftType}, ${flightType.type}`);
            
            // Add debug info if in debug mode
            if (debugMode) {
              debugParts.push(`[${flightType.type}: ${aircraftRollResult.debugEntry} ‚Üí ${aircraftType}]`);
            }
          }
        });
        
        const resultText = resultParts.join(', ');
        const debugText = debugParts.length > 0 ? debugParts.join(' ') : '';
        
        return {
          nationRoll: null,
          aircraftRoll: null,
          text: resultText,
          debugText: debugText
        };
      }
      
      if (tableId === 'L') {
        // Warsaw Pact Table L: Special Missions - mission type-based
        let missionType, selectedNation, selectedNationName, nationRollResult;
        
        // Check if this is Tactical Recon with nation selection
        if (atafZone.includes('|')) {
          const [mType, nation] = atafZone.split('|');
          missionType = mType;
          const missionData = table.missionTypes[missionType];
          
          if (!missionData || !missionData.requiresNationSelection) {
            return {
              nationRoll: null,
              aircraftRoll: null,
              text: `Error: Invalid mission configuration ${atafZone}`
            };
          }
          
          // Use manually selected nation for Tactical Recon
          selectedNation = missionData.nationData[nation];
          selectedNationName = selectedNation.name;
        } else {
          // Standard mission type with nation roll (Standoff Jamming)
          missionType = atafZone;
          const missionData = table.missionTypes[missionType];
          
          if (!missionData) {
            return {
              nationRoll: null,
              aircraftRoll: null,
              text: `Error: Unknown mission type ${atafZone}`
            };
          }
          
          // Roll for nation
          nationRollResult = makeDebugRoll(10, 'Nation');
          const nationRoll = nationRollResult.roll;
          
          for (const [range, nation] of Object.entries(missionData.nations)) {
            const [min, max] = parseRange(range);
            if (nationRoll >= min && nationRoll <= max) {
              selectedNation = nation;
              selectedNationName = nation.name;
              break;
            }
          }
          
          if (!selectedNation) {
            return {
              nationRoll: nationRoll,
              aircraftRoll: null,
              text: `Error: No nation found for mission ${missionType} roll ${nationRoll}`
            };
          }
        }
        
        // Roll for aircraft within that nation
        const aircraftRollResult = makeDebugRoll(10, 'Aircraft');
        const aircraftRoll = aircraftRollResult.roll;
        let aircraftType = null;
        
        // Find matching aircraft based on roll ranges
        for (const [range, aircraft] of Object.entries(selectedNation.aircraft)) {
          const [min, max] = parseRange(range);
          if (aircraftRoll >= min && aircraftRoll <= max) {
            aircraftType = aircraft;
            break;
          }
        }
        
        if (!aircraftType) {
          return {
            nationRoll: null,
            aircraftRoll: aircraftRoll,
            text: `Error: No aircraft found for mission ${missionType} roll ${aircraftRoll}`
          };
        }
        
        const missionData = table.missionTypes[missionType];
        const resultText = `${selectedNationName}: ${missionData.flightCount} x {${missionData.flightSize}} ${aircraftType}, ${missionType}`;
        
        // Build debug text for Table L
        let debugText = '';
        if (debugMode) {
          if (atafZone.includes('|')) {
            // Tactical Recon with manual nation selection
            debugText = `[Mission: ${missionType} | Nation: Manual | ${aircraftRollResult.debugEntry}]`;
          } else {
            // Standoff Jamming with nation roll
            debugText = `[Mission: ${missionType} | ${nationRollResult.debugEntry} | ${aircraftRollResult.debugEntry}]`;
          }
        }
        
        return {
          nationRoll: null,
          aircraftRoll: aircraftRoll,
          text: resultText,
          debugText: debugText
        };
      }
      
      // Placeholder for other tables
      return {
        nationRoll: null,
        aircraftRoll: null,
        text: `Placeholder result for Table ${tableId}`
      };
    }

    function getTableResult(tableId) {
      const table = oobTables[tableId];
      
      if (tableId === 'A') {
        // Table A: NATO QRA Flight - two-roll system
        const nationRollResult = makeDebugRoll(10, 'Nation');
        const nationRoll = nationRollResult.roll;
        
        // Determine nation based on roll
        let selectedNation, nationName;
        if (nationRoll >= 1 && nationRoll <= 4) {
          selectedNation = table.nations['1-4'];
          nationName = 'UK';
        } else if (nationRoll >= 5 && nationRoll <= 6) {
          selectedNation = table.nations['5-6'];
          nationName = 'BE/NE';
        } else if (nationRoll >= 7 && nationRoll <= 10) {
          selectedNation = table.nations['7-10'];
          nationName = 'FRG';
        }
        
        // Roll for aircraft within that nation
        const aircraftRollResult = makeDebugRoll(10, 'Aircraft');
        const aircraftRoll = aircraftRollResult.roll;
        let aircraftType = null;
        
        // Find matching aircraft based on roll ranges
        for (const [range, aircraft] of Object.entries(selectedNation.aircraft)) {
          const [min, max] = parseRange(range);
          if (aircraftRoll >= min && aircraftRoll <= max) {
            aircraftType = aircraft;
            // Add nation suffix if not already included
            if (!aircraftType.includes('(') && nationName !== 'FRG') {
              aircraftType += `(${nationName})`;
            }
            break;
          }
        }
        
        const resultText = `1 x {${table.flightSize}} ${aircraftType}`;
        
        // Build simple debug string
        let debugText = '';
        if (debugMode) {
          const debugParts = [nationRollResult.debugEntry, aircraftRollResult.debugEntry].filter(Boolean);
          debugText = debugParts.length > 0 ? `[${debugParts.join(' | ')}]` : '';
        }
        
        return {
          nationRoll: nationRoll,
          aircraftRoll: aircraftRoll,
          text: resultText,
          debugText: debugText
        };
      }
      
      if (tableId === 'G' || tableId === 'H') {
        // Warsaw Pact QRA Flight and Fighter Sweep - two-roll system
        const nationRollResult = makeDebugRoll(10, 'Nation');
        const nationRoll = nationRollResult.roll;
        
        // Determine nation based on roll
        let selectedNation = null;
        for (const [range, nation] of Object.entries(table.nations)) {
          const [min, max] = parseRange(range);
          if (nationRoll >= min && nationRoll <= max) {
            selectedNation = nation;
            break;
          }
        }
        
        if (selectedNation) {
          // Handle Table H with multiple flights
          if (tableId === 'H') {
            // Roll for aircraft within that nation once for all flights
            const aircraftRollResult = makeDebugRoll(10, 'Aircraft');
            const aircraftRoll = aircraftRollResult.roll;
            let aircraftType = null;
            let subRollResult = null;
            
            // Find matching aircraft based on roll ranges
            for (const [range, aircraft] of Object.entries(selectedNation.aircraft)) {
              const [min, max] = parseRange(range);
              if (aircraftRoll >= min && aircraftRoll <= max) {
                aircraftType = aircraft;
                break;
              }
            }
            
            // Handle hidden sub-rolls for superscript references
            if (aircraftType && aircraftType.includes('¬π')) {
              subRollResult = makeDebugRoll(10, 'Sub-roll');
              if (aircraftType.includes('MiG-25PD/Su-27S¬π')) {
                aircraftType = subRollResult.roll <= 5 ? 'MiG-25PD' : 'Su-27S';
              }
            }
            
            const resultText = `${selectedNation.name}: ${table.flightCount} x {${table.flightSize}} ${aircraftType}, CAP`;
            
            // Build debug string
            let debugText = '';
            if (debugMode) {
              const debugParts = [nationRollResult.debugEntry, aircraftRollResult.debugEntry];
              if (subRollResult) debugParts.push(subRollResult.debugEntry);
              debugText = debugParts.filter(Boolean).length > 0 ? `[${debugParts.filter(Boolean).join(' | ')}]` : '';
            }
            
            return {
              nationRoll: nationRoll,
              aircraftRoll: aircraftRoll,
              text: resultText,
              debugText: debugText
            };
          } else {
            // Table G - single flight
            // Roll for aircraft within that nation
            const aircraftRollResult = makeDebugRoll(10, 'Aircraft');
            const aircraftRoll = aircraftRollResult.roll;
            let aircraftType = null;
            let subRollResult = null;
            
            // Find matching aircraft based on roll ranges
            for (const [range, aircraft] of Object.entries(selectedNation.aircraft)) {
              const [min, max] = parseRange(range);
              if (aircraftRoll >= min && aircraftRoll <= max) {
                aircraftType = aircraft;
                break;
              }
            }
            
            // Handle hidden sub-rolls for superscript references
            if (aircraftType && aircraftType.includes('¬π')) {
              subRollResult = makeDebugRoll(10, 'Sub-roll');
              if (aircraftType.includes('MiG-25PD/Su-27S¬π')) {
                aircraftType = subRollResult.roll <= 5 ? 'MiG-25PD' : 'Su-27S';
              }
            }
            
            const resultText = `${selectedNation.name}: 1 x {${table.flightSize}} ${aircraftType}, CAP`;
            
            // Build simple debug string
            let debugText = '';
            if (debugMode) {
              const debugParts = [nationRollResult.debugEntry, aircraftRollResult.debugEntry];
              if (subRollResult) debugParts.push(subRollResult.debugEntry);
              debugText = debugParts.filter(Boolean).length > 0 ? `[${debugParts.filter(Boolean).join(' | ')}]` : '';
            }
            
            return {
              nationRoll: nationRoll,
              aircraftRoll: aircraftRoll,
              text: resultText,
              debugText: debugText
            };
          }
        }
      } else if (tableId === 'I') {
        console.log('REACHED Table I conditional block!');
        console.log('Processing Table I - Nationality-based structure');
        try {
          // Table I: Warsaw Pact Bombing Raid - nationality-based like Table K
          // First roll for nationality: 1-8 USSR, 9-10 GDR
          const nationalityRollResult = makeDebugRoll(10, 'Nationality');
          const nationalityRoll = nationalityRollResult.roll;
          
          let selectedNationality;
          if (nationalityRoll <= 8) {
            selectedNationality = 'USSR';
          } else {
            selectedNationality = 'GDR';
          }
          
          console.log(`Nationality roll: ${nationalityRoll} ‚Üí ${selectedNationality}`);
          
          const nationalityData = table.nationalities[selectedNationality];
          if (!nationalityData) {
            return {
              nationRoll: nationalityRoll,
              aircraftRoll: null,
              text: `Error: Unknown nationality ${selectedNationality}`,
              debugText: ''
            };
          }
          
          const results = [];
          
          // Generate results for each tasking (Close Escort, SEAD, Bombing)
          for (const [taskingName, taskingData] of Object.entries(nationalityData.taskings)) {
            console.log(`Processing tasking: ${taskingName}`);
            
            // Roll for aircraft within this tasking
            const aircraftRollResult = makeDebugRoll(10, `${taskingName} Aircraft`);
            const aircraftRoll = aircraftRollResult.roll;
            let aircraftType = null;
            let subRollResult = null;
            
            // Find matching aircraft based on roll ranges
            for (const [range, aircraft] of Object.entries(taskingData.aircraft)) {
              const [min, max] = parseRange(range);
              if (aircraftRoll >= min && aircraftRoll <= max) {
                aircraftType = aircraft;
                break;
              }
            }
            
            if (!aircraftType) {
              results.push({
                tasking: taskingName,
                text: `Error: No aircraft found for ${taskingName} roll ${aircraftRoll}`
              });
              continue;
            }
            
            // Handle hidden sub-rolls for superscript references
            if (aircraftType && (aircraftType.includes('¬≤') || aircraftType.includes('¬π'))) {
              subRollResult = makeDebugRoll(10, `${taskingName} Sub-roll`);
              if (aircraftType.includes('MiG-23¬≤')) {
                if (subRollResult.roll <= 4) aircraftType = 'MiG-23M';
                else if (subRollResult.roll <= 8) aircraftType = 'MiG-23MF';
                else aircraftType = 'MiG-23ML';
              } else if (aircraftType.includes('MiG-23MF/ML¬π')) {
                // Sub-roll: 1-5 MiG-23MF, 6-10 MiG-23ML
                aircraftType = subRollResult.roll <= 5 ? 'MiG-23MF' : 'MiG-23ML';
              }
            }
            
            const resultText = `${selectedNationality}: ${taskingData.flightCount} x {${taskingData.flightSize}} ${aircraftType}, ${taskingName}`;
            console.log(`Result text for ${taskingName}:`, resultText);
            
            // Build debug text for this tasking
            let taskingDebugText = '';
            if (debugMode) {
              taskingDebugText = `[${taskingName}: ${aircraftRollResult.debugEntry} ‚Üí ${aircraftType}`;
              if (subRollResult) {
                taskingDebugText += ` | ${subRollResult.debugEntry} ‚Üí ${aircraftType}`;
              }
              taskingDebugText += ']';
            }
            
            results.push({
              tasking: taskingName,
              text: resultText,
              debugText: taskingDebugText
            });
          }
          
          // Combine nationality roll with all tasking debug texts
          const allDebugTexts = results.map(r => r.debugText).filter(Boolean);
          let combinedDebugText = '';
          if (debugMode) {
            const debugParts = [`Nationality: ${nationalityRollResult.debugEntry} ‚Üí ${selectedNationality}`];
            if (allDebugTexts.length > 0) {
              debugParts.push(...allDebugTexts);
            }
            combinedDebugText = debugParts.length > 0 ? debugParts.join(' ') : '';
          }
          
          const finalResult = {
            taskingResults: results,
            text: results.map(r => r.text).join('<br>'),
            debugText: combinedDebugText
          };
          
          console.log('Table I final result:', finalResult);
          console.log('About to return from Table I...');
          return finalResult;
          
        } catch (error) {
          console.error('Error in Table I processing:', error);
          return {
            nationRoll: null,
            aircraftRoll: null,
            text: `Error processing Table I: ${error.message}`,
            debugText: ''
          };
        }
      } else if (tableId === 'J') {
        console.log('Execution continued past Table I - this should not happen!');
        console.log('Processing Table J');
        // Table J: Warsaw Pact Deep Strike Raid - generates ALL taskings automatically (USSR only)
        const allTaskings = Object.keys(table.taskings);
        console.log('Table J taskings:', allTaskings);
        const resultParts = [];
        let debugParts = [];
        
        // Debug: Check if taskings exist
        if (!table.taskings || allTaskings.length === 0) {
          console.log('No taskings found for Table J');
          return {
            nationRoll: null,
            aircraftRoll: null,
            text: `Error: No taskings found for Table J`,
            debugText: ''
          };
        }
        
        for (const taskingName of allTaskings) {
          const taskingData = table.taskings[taskingName];
          
          // Table J is USSR only - no nation roll needed
          const nationData = taskingData.nations['1-10']; // USSR covers full range
          
          // Roll for aircraft for this tasking
          const aircraftRollResult = makeDebugRoll(10, `${taskingName} Aircraft`);
          const aircraftRoll = aircraftRollResult.roll;
          let aircraftType = null;
          
          // Find matching aircraft based on roll ranges
          for (const [range, aircraft] of Object.entries(nationData.aircraft)) {
            const [min, max] = parseRange(range);
            if (aircraftRoll >= min && aircraftRoll <= max) {
              aircraftType = aircraft;
              break;
            }
          }
          
          // Handle hidden sub-rolls for superscript references
          if (aircraftType && aircraftType.includes('¬≤')) {
            const subRollResult = makeDebugRoll(10, `${taskingName} Sub-roll`);
            if (aircraftType.includes('MiG-23¬≤')) {
              if (subRollResult.roll <= 4) aircraftType = 'MiG-23M';
              else if (subRollResult.roll <= 8) aircraftType = 'MiG-23MF';
              else aircraftType = 'MiG-23ML';
            }
            if (debugMode) debugParts.push(subRollResult.debugEntry);
          }
          
          // Add this tasking to results
          resultParts.push(`${taskingData.flightCount} x {${taskingData.flightSize}} ${aircraftType}, ${taskingName}`);
          if (debugMode) debugParts.push(aircraftRollResult.debugEntry);
        }
        
        const resultText = `USSR: ${resultParts.join(', ')}`;
        
        // Build simple debug string
        let debugText = '';
        if (debugMode && debugParts.length > 0) {
          debugText = `[${debugParts.filter(Boolean).join(' | ')}]`;
        }
        
        return {
          nationRoll: null,
          aircraftRoll: null,
          text: resultText,
          debugText: debugText
        };
      } else if (tableId === 'K') {
        // Warsaw Pact Combat Rescue - nationality-based system
        const nationalityNames = Object.keys(table.nationalities);
        const selectedNationality = nationalityNames[Math.floor(Math.random() * nationalityNames.length)];
        const nationalityData = table.nationalities[selectedNationality];
        
        let resultText = '';
        
        // Generate results for each flight type
        nationalityData.flights.forEach(flightType => {
          const aircraftRoll = Math.floor(Math.random() * 10) + 1;
          let aircraftType = null;
          
          // Find matching aircraft based on roll ranges
          for (const [range, aircraft] of Object.entries(flightType.aircraft)) {
            const [min, max] = parseRange(range);
            if (aircraftRoll >= min && aircraftRoll <= max) {
              aircraftType = aircraft;
              break;
            }
          }
          
          if (resultText) resultText += ', ';
          resultText += `${flightType.flightCount} x {${flightType.flightSize}} ${aircraftType}, ${flightType.type}`;
        });
        
        // Prepend nationality name to the result
        resultText = `${nationalityData.name.replace(' Combat Rescue Raid', '')}: ${resultText}`;
        
        // Build simple debug string
        let debugText = '';
        if (debugMode) {
          debugText = `[Nationality: ${selectedNationality}]`;
        }
        
        return {
          nationRoll: null,
          aircraftRoll: null,
          text: resultText,
          debugText: debugText
        };
      } else if (tableId === 'L') {
        // Warsaw Pact Special Missions - mission type-based system
        const missionTypeNames = Object.keys(table.missionTypes);
        const selectedMissionType = missionTypeNames[Math.floor(Math.random() * missionTypeNames.length)];
        const missionData = table.missionTypes[selectedMissionType];
        
        const nationRoll = Math.floor(Math.random() * 10) + 1;
        
        // Determine nation based on roll
        let selectedNation = null;
        for (const [range, nation] of Object.entries(missionData.nations)) {
          const [min, max] = parseRange(range);
          if (nationRoll >= min && nationRoll <= max) {
            selectedNation = nation;
            break;
          }
        }
        
        if (selectedNation) {
          // Roll for aircraft within that nation
          const aircraftRoll = Math.floor(Math.random() * 10) + 1;
          let aircraftType = null;
          
          // Find matching aircraft based on roll ranges
          for (const [range, aircraft] of Object.entries(selectedNation.aircraft)) {
            const [min, max] = parseRange(range);
            if (aircraftRoll >= min && aircraftRoll <= max) {
              aircraftType = aircraft;
              break;
            }
          }
          
          const resultText = `${selectedNation.name}: ${missionData.flightCount} x {${missionData.flightSize}} ${aircraftType}, ${selectedMissionType}`;
          
          // Build simple debug string
          let debugText = '';
          if (debugMode) {
            debugText = `[Mission: ${selectedMissionType} | Nation: ${nationRoll} | Aircraft: ${aircraftRoll}]`;
          }
          
          return {
            nationRoll: nationRoll,
            aircraftRoll: aircraftRoll,
            text: resultText,
            debugText: debugText
          };
        }
      }
      
      // Placeholder for other tables
      return {
        nationRoll: null,
        aircraftRoll: null,
        text: `Placeholder result for Table ${tableId}`,
        debugText: ''
      };
    }
    
    function parseRange(range) {
      if (range.includes('-')) {
        const [min, max] = range.split('-').map(num => parseInt(num));
        return [min, max];
      } else {
        const num = parseInt(range);
        return [num, num];
      }
    }

    function updateResultsDisplay() {
      const container = document.getElementById('resultsList');
      const resultsSection = document.getElementById('resultsSection');
      
      if (results.length === 0) {
        resultsSection.style.display = 'none';
        return;
      }
      
      resultsSection.style.display = 'block';
      
      const resultsHTML = results.map(result => {
        let rollText = '';
        let variableText = '';
        
        // Only show roll text for NATO tables, not Warsaw Pact
        if (result.faction === 'NATO') {
          if (result.nationRoll && result.aircraftRoll && result.table !== 'A' && result.table !== 'B' && result.table !== 'F') {
            rollText = `(aircraft: ${result.aircraftRoll})`;
          } else if (result.roll) {
            rollText = `(rolled ${result.roll})`;
          }
        }
        
        if (result.atafZone || result.scenarioDate) {
          const parts = [];
          if (result.atafZone) parts.push(result.atafZone);
          // Only show date for date-dependent tables (A, B, C)
          if (result.scenarioDate && (result.table === 'A' || result.table === 'B' || result.table === 'C')) {
            parts.push(result.scenarioDate === 'pre' ? 'Pre-6/1/87' : '6/1/87+');
          }
          if (parts.length > 0) {
            variableText = ` [${parts.join(', ')}]`;
          }
        }
        
        // Determine faction styling
        const factionClass = result.faction === 'NATO' ? 'nato-result' : 'wp-result';
        
        // Build debug display
        let debugDisplay = '';
        if (debugMode && result.debugText && result.debugText.trim()) {
          debugDisplay = `<div style="font-size: 11px; color: #888; font-family: monospace; margin-top: 4px; padding: 2px 4px; background-color: rgba(255,255,255,0.05); border-radius: 2px;">${result.debugText}</div>`;
        }
        
        return `
          <div class="result-item ${factionClass}">
            <div class="result-info">
              <div class="result-table">${result.tableName}${variableText}</div>
              <div class="result-text">
                ${result.result}
                <span class="result-roll">${rollText}</span>
              </div>
              ${debugDisplay}
            </div>
            <button class="action-button remove-result" onclick="removeResult(${result.id})">
              Remove
            </button>
          </div>
        `;
      }).join('');
      
      container.innerHTML = resultsHTML;
    }

    function removeResult(resultId) {
      results = results.filter(result => result.id !== resultId);
      
      // Check if all results are gone
      if (results.length === 0) {
        hasGeneratedResults = false;
        updateDateButtonStates(); // Unlock date selection
      }
      
      updateResultsDisplay();
    }

    function clearAllResults() {
      if (results.length === 0) return;
      
      if (confirm('Are you sure you want to clear all results?')) {
        results = [];
        hasGeneratedResults = false; // Mark that no results exist
        updateDateButtonStates(); // Unlock date selection
        updateResultsDisplay();
      }
    }

    function viewTableStructure(tableId, atafZone, scenarioDate) {
      const table = oobTables[tableId];
      const titleElement = document.getElementById('tableViewTitle');
      const contentElement = document.getElementById('tableViewContent');
      const modalElement = document.querySelector('.table-view-modal');
      
      // Determine faction and apply appropriate styling
      const isWarsaw = ['G', 'H', 'I', 'J', 'K', 'L'].includes(tableId);
      modalElement.className = 'table-view-modal'; // Reset classes
      
      if (isWarsaw) {
        modalElement.classList.add('wp-table-view');
      } else {
        modalElement.classList.add('nato-table-view');
      }
      
      let titleText = table.name;
      // Only add date/zone info for date-dependent tables (A, B, C)
      if ((tableId === 'A' || tableId === 'B' || tableId === 'C') && atafZone && scenarioDate) {
        const dateText = scenarioDate === 'pre' ? 'Pre-6/1/87' : '6/1/87 or later';
        titleText += ` [${atafZone}, ${dateText}]`;
      } else if ((tableId === 'A' || tableId === 'B') && atafZone) {
        // For tables A/B, show zone even without date
        titleText += ` [${atafZone}]`;
      } else if (tableId === 'E' && atafZone) {
        // For table E, show nationality
        titleText += ` [${atafZone}]`;
      } else if (tableId === 'F' && atafZone) {
        // For table F, show mission type
        titleText += ` [${atafZone}]`;
      }
      titleElement.textContent = titleText;
      
      if (tableId === 'A') {
        const variant = table.variants[atafZone][scenarioDate];
        let tableHTML = `<div class="table-view-content">`;
        tableHTML += `<div class="table-description">${table.description}</div>`;
        
        // Show nation roll ranges and aircraft for this variant (sorted by roll number)
        const sortedNations = Object.entries(variant.nations).sort((a, b) => {
          const aMin = parseRange(a[0])[0];
          const bMin = parseRange(b[0])[0];
          return aMin - bMin;
        });
        
        for (const [nationRange, nationData] of sortedNations) {
          tableHTML += `<div class="nation-section">`;
          tableHTML += `<div class="nation-header">${nationRange}: ${nationData.name}</div>`;
          tableHTML += `<div class="aircraft-list">`;
          
          // Sort aircraft ranges numerically
          const sortedAircraft = Object.entries(nationData.aircraft).sort((a, b) => {
            const aStart = parseInt(a[0].split('-')[0]) || parseInt(a[0]);
            const bStart = parseInt(b[0].split('-')[0]) || parseInt(b[0]);
            return aStart - bStart;
          });
          
          for (const [aircraftRange, aircraftType] of sortedAircraft) {
            // Use aircraft names exactly as defined in source data
            const displayType = aircraftType;
            tableHTML += `<div class="aircraft-item">${aircraftRange}: ${displayType}</div>`;
          }
          
          tableHTML += `</div></div>`;
        }
        
        tableHTML += `</div>`;
        contentElement.innerHTML = tableHTML;
      } else if (tableId === 'B') {
        const zoneData = table.zones[atafZone][scenarioDate];
        let tableHTML = `<div class="table-view-content">`;
        tableHTML += `<div class="table-description">${table.description}</div>`;
        
        // Show nation roll ranges and aircraft for this zone/date combination (sorted by roll number)
        const sortedNations = Object.entries(zoneData.nations).sort((a, b) => {
          const aMin = parseInt(a[0].split('-')[0]);
          const bMin = parseInt(b[0].split('-')[0]);
          return aMin - bMin;
        });
        
        for (const [nationRange, nationData] of sortedNations) {
          tableHTML += `<div class="nation-section">`;
          tableHTML += `<div class="nation-header">${nationRange}: ${nationData.name}</div>`;
          tableHTML += `<div class="aircraft-list">`;
          
          // Sort aircraft ranges numerically
          const sortedAircraft = Object.entries(nationData.aircraft).sort((a, b) => {
            const aStart = parseInt(a[0].split('-')[0]) || parseInt(a[0]);
            const bStart = parseInt(b[0].split('-')[0]) || parseInt(b[0]);
            return aStart - bStart;
          });
          
          for (const [aircraftRange, aircraftType] of sortedAircraft) {
            tableHTML += `<div class="aircraft-item">${aircraftRange}: ${aircraftType}</div>`;
          }
          
          tableHTML += `</div></div>`;
        }
        
        tableHTML += `</div>`;
        contentElement.innerHTML = tableHTML;
      } else if (tableId === 'C') {
        // Table C: NATO Bombing Raid - show all three taskings
        let tableHTML = `<div class="table-view-content">`;
        tableHTML += `<div class="table-description">${table.description}</div>`;
        if (table.ordnanceNote) {
          tableHTML += `<div class="ordnance-note" style="font-style: italic; color: #888; margin-top: 10px; padding: 8px; background-color: #f5f5f5; border-radius: 4px;">Ordnance: ${table.ordnanceNote}</div>`;
        }
        
        const taskings = ['CAP', 'SEAD', 'Bombing'];
        const dateVariant = scenarioDate;
        
        for (const tasking of taskings) {
          const taskingData = table.taskings[tasking][dateVariant];
          
          tableHTML += `<div class="tasking-section">`;
          tableHTML += `<div class="tasking-header">${tasking} (4 x {${tasking === 'Bombing' ? '4' : '2'}})</div>`;
          
          // Sort nations by roll number
          const sortedNations = Object.entries(taskingData.nations).sort((a, b) => {
            const aMin = parseInt(a[0].split('-')[0]);
            const bMin = parseInt(b[0].split('-')[0]);
            return aMin - bMin;
          });
          
          for (const [nationRange, nationData] of sortedNations) {
            tableHTML += `<div class="nation-section">`;
            tableHTML += `<div class="nation-header">${nationRange}: ${nationData.name}</div>`;
            tableHTML += `<div class="aircraft-list">`;
            
            // Sort aircraft ranges numerically
            const sortedAircraft = Object.entries(nationData.aircraft).sort((a, b) => {
              const aStart = parseInt(a[0].split('-')[0]) || parseInt(a[0]);
              const bStart = parseInt(b[0].split('-')[0]) || parseInt(b[0]);
              return aStart - bStart;
            });
            
            // Array to collect sub-roll notes for this nation
            const nationSubRollNotes = [];
            
            for (const [aircraftRange, aircraftType] of sortedAircraft) {
              tableHTML += `<div class="aircraft-item">${aircraftRange}: ${aircraftType}</div>`;
              
              // Check for superscripted aircraft and add sub-roll explanations
              if (aircraftType.includes('F-4¬≤')) {
                nationSubRollNotes.push('¬≤ Roll again: 1-5 F-4D; 6-10 F-4E');
              }
            }
            
            tableHTML += `</div>`;
            
            // Add sub-roll notes at the bottom of this nation section
            if (nationSubRollNotes.length > 0) {
              for (const note of nationSubRollNotes) {
                tableHTML += `<div class="sub-roll-note" style="font-size: 11px; color: #666; margin-top: 8px; padding-left: 12px; font-style: italic;">${note}</div>`;
              }
            }
            
            tableHTML += `</div>`;
          }
          
          tableHTML += `</div>`;
        }
        
        tableHTML += `</div>`;
        contentElement.innerHTML = tableHTML;
      } else if (tableId === 'D') {
        // Table D: NATO Deep Strike Raid - show all five taskings (no date variants)
        let tableHTML = `<div class="table-view-content">`;
        tableHTML += `<div class="table-description">${table.description}</div>`;
        if (table.ordnanceNote) {
          tableHTML += `<div class="ordnance-note" style="font-style: italic; color: #888; margin-top: 10px; padding: 8px; background-color: #f5f5f5; border-radius: 4px;">Ordnance: ${table.ordnanceNote}</div>`;
        }
        
        const taskings = ['Escort Jamming', 'CAP', 'SEAD', 'Bombing', 'Recon'];
        
        for (const tasking of taskings) {
          const taskingData = table.taskings[tasking];
          
          tableHTML += `<div class="tasking-section">`;
          const flightInfo = taskingData.flightCount + ' x {' + taskingData.flightSize + '}';
          tableHTML += `<div class="tasking-header">${tasking} (${flightInfo})</div>`;
          
          // Sort nations by roll number
          const sortedNations = Object.entries(taskingData.nations).sort((a, b) => {
            const aMin = parseInt(a[0].split('-')[0]);
            const bMin = parseInt(b[0].split('-')[0]);
            return aMin - bMin;
          });
          
          for (const [nationRange, nationData] of sortedNations) {
            tableHTML += `<div class="nation-section">`;
            tableHTML += `<div class="nation-header">${nationRange}: ${nationData.name}</div>`;
            tableHTML += `<div class="aircraft-list">`;
            
            // Sort aircraft ranges numerically
            const sortedAircraft = Object.entries(nationData.aircraft).sort((a, b) => {
              const aStart = parseInt(a[0].split('-')[0]) || parseInt(a[0]);
              const bStart = parseInt(b[0].split('-')[0]) || parseInt(b[0]);
              return aStart - bStart;
            });
            
            for (const [aircraftRange, aircraftType] of sortedAircraft) {
              tableHTML += `<div class="aircraft-item">${aircraftRange}: ${aircraftType}</div>`;
            }
            
            tableHTML += `</div></div>`;
          }
          
          tableHTML += `</div>`;
        }
        
        tableHTML += `</div>`;
        contentElement.innerHTML = tableHTML;
      } else if (tableId === 'E') {
        // Table E: NATO Combat Rescue - show nationality-based rescue raids
        let selectedNationality = atafZone;
        
        // Handle nationality mapping
        if (selectedNationality === 'UK' || selectedNationality === 'BE' || selectedNationality === 'NE') {
          selectedNationality = 'UK';
        } else if (selectedNationality === 'CAN') {
          selectedNationality = 'US';
        }
        
        const nationalityData = table.nationalities[selectedNationality];
        
        let tableHTML = `<div class="table-view-content">`;
        tableHTML += `<div class="table-description">${table.description}</div>`;
        if (table.ordnanceNote) {
          tableHTML += `<div class="ordnance-note" style="font-style: italic; color: #888; margin-top: 10px; padding: 8px; background-color: #f5f5f5; border-radius: 4px;">Ordnance: ${table.ordnanceNote}</div>`;
        }
        
        if (nationalityData) {
          for (const flightData of nationalityData.flights) {
            tableHTML += `<div class="tasking-section">`;
            const flightInfo = flightData.flightCount + ' x {' + flightData.flightSize + '}';
            tableHTML += `<div class="tasking-header">${flightData.type} (${flightInfo})</div>`;
            
            tableHTML += `<div class="aircraft-list">`;
            
            // Sort aircraft ranges numerically
            const sortedAircraft = Object.entries(flightData.aircraft).sort((a, b) => {
              const aStart = parseInt(a[0].split('-')[0]) || parseInt(a[0]);
              const bStart = parseInt(b[0].split('-')[0]) || parseInt(b[0]);
              return aStart - bStart;
            });
            
            for (const [aircraftRange, aircraftType] of sortedAircraft) {
              tableHTML += `<div class="aircraft-item">${aircraftRange}: ${aircraftType}</div>`;
            }
            
            tableHTML += `</div></div>`;
          }
        } else {
          tableHTML += `<div class="error">Unknown nationality: ${atafZone}</div>`;
        }
        
        tableHTML += `</div>`;
        contentElement.innerHTML = tableHTML;
      } else if (tableId === 'F') {
        // Table F: NATO Special Missions - show mission-type based structure
        const selectedMissionType = atafZone; // Mission type passed via atafZone parameter
        
        const missionData = table.missionTypes[selectedMissionType];
        
        let tableHTML = `<div class="table-view-content">`;
        tableHTML += `<div class="table-description">${table.description}</div>`;
        
        if (missionData) {
          if (missionData.ordnanceNote) {
            tableHTML += `<div class="ordnance-note" style="font-style: italic; color: #888; margin-top: 10px; padding: 8px; background-color: #f5f5f5; border-radius: 4px;">Ordnance: ${missionData.ordnanceNote}</div>`;
          }
          //tableHTML += `<div class="mission-info">${missionData.flightCount} x {${missionData.flightSize}} [${missionData.name}], ${missionData.description}</div>`;
          
          // Sort nations by roll number
          const sortedNations = Object.entries(missionData.nations).sort((a, b) => {
            const aMin = parseInt(a[0].split('-')[0]);
            const bMin = parseInt(b[0].split('-')[0]);
            return aMin - bMin;
          });
          
          for (const [nationRange, nationData] of sortedNations) {
            tableHTML += `<div class="nation-section">`;
            tableHTML += `<div class="nation-header">${nationRange}: ${nationData.name}</div>`;
            tableHTML += `<div class="aircraft-list">`;
            
            // Sort aircraft ranges numerically
            const sortedAircraft = Object.entries(nationData.aircraft).sort((a, b) => {
              const aStart = parseInt(a[0].split('-')[0]) || parseInt(a[0]);
              const bStart = parseInt(b[0].split('-')[0]) || parseInt(b[0]);
              return aStart - bStart;
            });
            
            for (const [aircraftRange, aircraftType] of sortedAircraft) {
              tableHTML += `<div class="aircraft-item">${aircraftRange}: ${aircraftType}</div>`;
            }
            
            tableHTML += `</div></div>`;
          }
        } else {
          tableHTML += `<div class="error">Unknown mission type: ${atafZone}</div>`;
        }
        
        tableHTML += `</div>`;
        contentElement.innerHTML = tableHTML;
      } else if (tableId === 'G' || tableId === 'H') {
        // Warsaw Pact Tables G & H - simple nation/aircraft structure
        let tableHTML = `<div class="table-view-content">`;
        tableHTML += `<div class="table-description">${table.description}</div>`;
        
        // Show nation roll ranges and aircraft (sorted by roll number)
        const sortedNations = Object.entries(table.nations).sort((a, b) => {
          const aMin = parseRange(a[0])[0];
          const bMin = parseRange(b[0])[0];
          return aMin - bMin;
        });
        
        for (const [nationRange, nationData] of sortedNations) {
          tableHTML += `<div class="nation-section">`;
          tableHTML += `<div class="nation-header">${nationRange}: ${nationData.name}</div>`;
          tableHTML += `<div class="aircraft-list">`;
          
          // Sort aircraft ranges numerically
          const sortedAircraft = Object.entries(nationData.aircraft).sort((a, b) => {
            const aStart = parseInt(a[0].split('-')[0]) || parseInt(a[0]);
            const bStart = parseInt(b[0].split('-')[0]) || parseInt(b[0]);
            return aStart - bStart;
          });
          
          // Array to collect sub-roll notes for this nation
          const nationSubRollNotes = [];
          
          for (const [aircraftRange, aircraftType] of sortedAircraft) {
            tableHTML += `<div class="aircraft-item">${aircraftRange}: ${aircraftType}</div>`;
            
            // Check for superscripted aircraft and add sub-roll explanations
            if (aircraftType.includes('MiG-25PD/Su-27S¬π')) {
              nationSubRollNotes.push('¬π Roll again: 1-5 MiG-25PD; 6-10 Su-27S');
            }
          }
          
          tableHTML += `</div>`;
          
          // Add sub-roll notes at the bottom of this nation section
          if (nationSubRollNotes.length > 0) {
            for (const note of nationSubRollNotes) {
              tableHTML += `<div class="sub-roll-note" style="font-size: 11px; color: #666; margin-top: 8px; padding-left: 12px; font-style: italic;">${note}</div>`;
            }
          }
          
          tableHTML += `</div>`;
        }
        
        tableHTML += `</div>`;
        contentElement.innerHTML = tableHTML;
      } else if (tableId === 'I') {
        // Warsaw Pact Table I - nationality-based structure
        let tableHTML = `<div class="table-view-content">`;
        tableHTML += `<div class="table-description">${table.description}</div>`;
        if (table.ordnanceNote) {
          tableHTML += `<div class="ordnance-note" style="font-style: italic; color: #888; margin-top: 10px; padding: 8px; background-color: #f5f5f5; border-radius: 4px;">Ordnance: ${table.ordnanceNote}</div>`;
        }
        tableHTML += `<div class="raid-nationality"><strong>Raid Nationality: 1-8 USSR, 9-10 GDR</strong></div>`;
        
        // Show both USSR and GDR sections
        for (const [nationalityName, nationalityData] of Object.entries(table.nationalities)) {
          tableHTML += `<div class="nationality-section">`;
          tableHTML += `<div class="nationality-header">${nationalityData.name}</div>`;
          
          // Show each tasking for this nationality
          for (const [taskingName, taskingData] of Object.entries(nationalityData.taskings)) {
            tableHTML += `<div class="tasking-section">`;
            const flightInfo = taskingData.flightCount + ' x {' + taskingData.flightSize + '}';
            tableHTML += `<div class="tasking-header">${taskingName} (${flightInfo})</div>`;
            
            tableHTML += `<div class="aircraft-list">`;
            
            // Sort aircraft ranges numerically and collect sub-roll notes
            const sortedAircraft = Object.entries(taskingData.aircraft).sort((a, b) => {
              const aStart = parseInt(a[0].split('-')[0]) || parseInt(a[0]);
              const bStart = parseInt(b[0].split('-')[0]) || parseInt(b[0]);
              return aStart - bStart;
            });
            
            let subRollNotes = [];
            
            for (const [aircraftRange, aircraftType] of sortedAircraft) {
              tableHTML += `<div class="aircraft-item">${aircraftRange}: ${aircraftType}</div>`;
              
              // Check for superscripted aircraft and add sub-roll explanations
              if (aircraftType.includes('MiG-23¬≤')) {
                subRollNotes.push('¬≤ Roll again: 1-4 MiG-23M; 5-8 MiG-23MF; 9-10 MiG-23ML');
              } else if (aircraftType.includes('MiG-23MF/ML¬π')) {
                subRollNotes.push('¬π Roll again: 1-5 MiG-23MF; 6-10 MiG-23ML');
              }
            }
            
            tableHTML += `</div>`;
            
            // Add sub-roll notes at the bottom of this tasking section (within the tasking section)
            if (subRollNotes.length > 0) {
              for (const note of subRollNotes) {
                tableHTML += `<div class="sub-roll-note" style="font-size: 11px; color: #666; margin-top: 8px; padding-left: 12px; font-style: italic;">${note}</div>`;
              }
            }
            
            tableHTML += `</div>`;
          }
          
          tableHTML += `</div>`;
        }
        
        tableHTML += `</div>`;
        contentElement.innerHTML = tableHTML;
      } else if (tableId === 'J') {
        // Table J: USSR Deep Strike Raid - display exactly as reference shows
        let tableHTML = `<div class="table-view-content">`;
        tableHTML += `<div class="table-description">${table.description}</div>`;
        if (table.ordnanceNote) {
          tableHTML += `<div class="ordnance-note" style="font-style: italic; color: #888; margin-top: 10px; padding: 8px; background-color: #f5f5f5; border-radius: 4px;">Ordnance: ${table.ordnanceNote}</div>`;
        }
        
        // Hard-coded reference data to match official rules exactly
        const referenceData = {
          'Escort Jamming': {
            flightInfo: '3 x {1}',
            aircraft: [
              { range: '1-2', type: 'Su-24MP' },
              { range: '3-5', type: 'MiG-25BM' },
              { range: '6-8', type: 'Yak-28PP' },
              { range: '9-10', type: 'Tu-22PD' }
            ]
          },
          'Chaff Laying': {
            flightInfo: '3 x {1}',
            aircraft: [
              { range: '1-5', type: 'MiG-21bis' },
              { range: '6-10', type: 'MiG-23M' }
            ]
          },
          'Close Escort': {
            flightInfo: '4 x {4}',
            aircraft: [
              { range: '1-3', type: 'MiG-23MLA' },
              { range: '4-7', type: 'MiG-23MLD' },
              { range: '8-10', type: 'Su-27S' }
            ]
          },
          'Bombing': {
            flightInfo: '6 x {4}',
            aircraft: [
              { range: '1-4', type: 'Su-24M' },
              { range: '5-8', type: 'Su-24M4' },
              { range: '9-10', type: 'MiG-27K' }
            ]
          },
          'Recon': {
            flightInfo: '2 x {1}',
            aircraft: [
              { range: '1-5', type: 'Su-24MR' },
              { range: '6-10', type: 'MiG-25RB' }
            ]
          }
        };
        
        for (const [taskingName, taskingData] of Object.entries(referenceData)) {
          tableHTML += `<div class="tasking-section">`;
          tableHTML += `<div class="tasking-header">${taskingName} (${taskingData.flightInfo})</div>`;
          
          for (const aircraft of taskingData.aircraft) {
            tableHTML += `<div class="aircraft-item">${aircraft.range}: ${aircraft.type}</div>`;
          }
          
          tableHTML += `</div>`;
        }
        
        tableHTML += `</div>`;
        contentElement.innerHTML = tableHTML;
      } else if (tableId === 'K') {
        // Warsaw Pact Table K - nationality-based structure
        let tableHTML = `<div class="table-view-content">`;
        tableHTML += `<div class="table-description">${table.description}</div>`;
        if (table.ordnanceNote) {
          tableHTML += `<div class="ordnance-note" style="font-style: italic; color: #888; margin-top: 10px; padding: 8px; background-color: #f5f5f5; border-radius: 4px;">Ordnance: ${table.ordnanceNote}</div>`;
        }
        
        if (atafZone && table.nationalities[atafZone]) {
          const nationalityData = table.nationalities[atafZone];
          
          // Display nationality as header without extra wrapper section
          tableHTML += `<div style="font-size: 18px; font-weight: bold; color: #ff9999; margin: 20px 0 15px 0;">
            ${nationalityData.name}
          </div>`;
          
          for (const flightType of nationalityData.flights) {
            tableHTML += `<div class="flight-type-section">`;
            const flightInfo = flightType.flightCount + ' x {' + flightType.flightSize + '}';
            tableHTML += `<div class="flight-type-header">${flightType.type} (${flightInfo})</div>`;
            tableHTML += `<div class="aircraft-list">`;
            
            // Sort aircraft ranges numerically
            const sortedAircraft = Object.entries(flightType.aircraft).sort((a, b) => {
              const aStart = parseInt(a[0].split('-')[0]) || parseInt(a[0]);
              const bStart = parseInt(b[0].split('-')[0]) || parseInt(b[0]);
              return aStart - bStart;
            });
            
            for (const [aircraftRange, aircraftType] of sortedAircraft) {
              tableHTML += `<div class="aircraft-item">${aircraftRange}: ${aircraftType}</div>`;
            }
            
            tableHTML += `</div></div>`;
          }
        } else {
          tableHTML += `<div class="error">Unknown nationality: ${atafZone}</div>`;
        }
        
        tableHTML += `</div>`;
        contentElement.innerHTML = tableHTML;
      } else if (tableId === 'L') {
        // Warsaw Pact Table L - mission type-based structure - show selected mission type only
        const selectedMissionType = atafZone; // Mission type passed via atafZone parameter
        
        const missionData = table.missionTypes[selectedMissionType];
        
        let tableHTML = `<div class="table-view-content">`;
        tableHTML += `<div class="table-description">${table.description}</div>`;
        
        if (missionData) {
          if (missionData.ordnanceNote) {
            tableHTML += `<div class="ordnance-note" style="font-style: italic; color: #888; margin-top: 10px; padding: 8px; background-color: #f5f5f5; border-radius: 4px;">Ordnance: ${missionData.ordnanceNote}</div>`;
          }
          
          // Show only the selected mission type
          tableHTML += `<div class="mission-section">`;
          const flightInfo = missionData.flightCount + ' x {' + missionData.flightSize + '}';
          tableHTML += `<div class="mission-header">${missionData.name} (${flightInfo})</div>`;
          
          if (missionData.requiresNationSelection) {
            // For Tactical Recon, show available nations without die rolls
            for (const [nationName, nationData] of Object.entries(missionData.nationData)) {
              tableHTML += `<div class="nation-section">`;
              tableHTML += `<div class="nation-header">${nationName}</div>`;
              tableHTML += `<div class="aircraft-list">`;
              
              // Sort aircraft ranges numerically
              const sortedAircraft = Object.entries(nationData.aircraft).sort((a, b) => {
                const aStart = parseInt(a[0].split('-')[0]) || parseInt(a[0]);
                const bStart = parseInt(b[0].split('-')[0]) || parseInt(b[0]);
                return aStart - bStart;
              });
              
              for (const [aircraftRange, aircraftType] of sortedAircraft) {
                tableHTML += `<div class="aircraft-item">${aircraftRange}: ${aircraftType}</div>`;
              }
              
              tableHTML += `</div></div>`;
            }
          } else {
            // For Standoff Jamming, show nations with die roll ranges
            const sortedNations = Object.entries(missionData.nations).sort((a, b) => {
              const aMin = parseInt(a[0].split('-')[0]);
              const bMin = parseInt(b[0].split('-')[0]);
              return aMin - bMin;
            });
            
            for (const [nationRange, nationData] of sortedNations) {
              tableHTML += `<div class="nation-section">`;
              tableHTML += `<div class="nation-header">${nationRange}: ${nationData.name}</div>`;
              tableHTML += `<div class="aircraft-list">`;
              
              // Sort aircraft ranges numerically
              const sortedAircraft = Object.entries(nationData.aircraft).sort((a, b) => {
                const aStart = parseInt(a[0].split('-')[0]) || parseInt(a[0]);
                const bStart = parseInt(b[0].split('-')[0]) || parseInt(b[0]);
                return aStart - bStart;
              });
              
              for (const [aircraftRange, aircraftType] of sortedAircraft) {
                tableHTML += `<div class="aircraft-item">${aircraftRange}: ${aircraftType}</div>`;
              }
              
              tableHTML += `</div></div>`;
            }
          }
          
          tableHTML += `</div>`; // Close mission-section
        } else {
          tableHTML += `<div class="error-message">Mission type not found: ${selectedMissionType}</div>`;
        }
        
        tableHTML += `</div>`;
        contentElement.innerHTML = tableHTML;
      } else {
        contentElement.innerHTML = `<div class="table-view-content">Table data not yet implemented for Table ${tableId}</div>`;
      }
      
      document.getElementById('tableViewOverlay').style.display = 'flex';
    }

    function viewTable() {
      if (!selectedTable) return;
      
      // Check if Table C and scenario date is required
      if (selectedTable === 'C' && !scenarioDate) {
        alert('Please select a scenario date first.');
        return;
      }
      
      // For tables without variables, use default values
      if (selectedTable === 'A') {
        // Default to 2ATAF, pre-6/1/87 for backward compatibility
        viewTableStructure(selectedTable, '2ATAF', 'pre');
      } else if (selectedTable === 'B') {
        // Table B uses global scenario date and default ATAF zone
        const defaultAtaf = '2ATAF';
        const globalDate = scenarioDate || 'pre';
        viewTableStructure(selectedTable, defaultAtaf, globalDate);
      } else if (selectedTable === 'C') {
        // Table C uses global scenario date for all taskings
        const globalDate = scenarioDate || 'pre';
        viewTableStructure(selectedTable, null, globalDate);
      } else if (selectedTable === 'D') {
        // Table D: No date dependency, so we can use any date value
        viewTableStructure(selectedTable, null, null);
      } else if (selectedTable === 'E') {
        // Table E: Combat Rescue - default to US nationality for view
        viewTableStructure(selectedTable, 'US', null);
      } else if (selectedTable === 'F') {
        // Table F: Special Missions - default to Fast FAC mission for view
        viewTableStructure(selectedTable, 'Fast FAC', null);
      } else if (selectedTable === 'G' || selectedTable === 'H') {
        // Warsaw Pact Tables G & H - simple nation/aircraft structure
        viewTableStructure(selectedTable, null, null);
      } else if (selectedTable === 'I' || selectedTable === 'J') {
        // Warsaw Pact Tables I & J - tasking-based, show all taskings
        viewTableStructure(selectedTable, null, null);
      } else if (selectedTable === 'K') {
        // Warsaw Pact Table K - nationality-based, default to USSR
        viewTableStructure(selectedTable, 'USSR', null);
      } else if (selectedTable === 'L') {
        // Warsaw Pact Table L - mission type-based, default to Standoff Jamming
        viewTableStructure(selectedTable, 'Standoff Jamming', null);
      } else {
        // Handle other tables that don't have variables yet
        const table = oobTables[selectedTable];
        const titleElement = document.getElementById('tableViewTitle');
        const contentElement = document.getElementById('tableViewContent');
        
        titleElement.textContent = table.name;
        contentElement.innerHTML = `<div class="table-view-content">Table data not yet implemented for Table ${selectedTable}</div>`;
        document.getElementById('tableViewOverlay').style.display = 'flex';
      }
    }

    function hideTableView() {
      document.getElementById('tableViewOverlay').style.display = 'none';
    }

    // Close modal when clicking outside the modal content
    function closeModalOnOverlayClick(event) {
      if (event.target === event.currentTarget) {
        hideTableView();
      }
    }

    // Close modal on Escape key press
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        const overlay = document.getElementById('tableViewOverlay');
        if (overlay && overlay.style.display === 'flex') {
          hideTableView();
        }
      }
    });

    // Generate Printable Flight Sheet
    function generatePrintableSheet() {
      // Use the results array directly instead of localStorage
      if (results.length === 0) {
        alert('No flights generated yet. Generate some flights first!');
        return;
      }

      // Create a new window for printing
      const printWindow = window.open('', '_blank');
      
      // Build the HTML for the printable sheet
      let htmlContent = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <base href="https://augustdragon.github.io/red-storm-tools-suite/">
  <title>Red Storm Flight Sheet</title>
  <style>
    @page {
      size: letter;
      margin: 0.5in;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      font-size: 10pt;
      background: white;
      color: black;
    }
    
    .page-title {
      text-align: center;
      font-size: 14pt;
      font-weight: bold;
      margin-bottom: 12px;
      border-bottom: 2px solid black;
      padding-bottom: 3px;
    }
    
    .flight-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .flight-card {
      border: 2px solid black;
      padding: 6px;
      page-break-inside: avoid;
      background: white;
      max-width: 450px;
    }
    
    .flight-header {
      display: grid;
      grid-template-columns: 2fr 1.5fr 1fr 1fr;
      gap: 4px;
      margin-bottom: 4px;
      padding-bottom: 3px;
      border-bottom: 1px solid black;
    }
    
    .field {
      border: 1px solid #666;
      padding: 3px 5px;
      min-height: 22px;
    }
    
    .field-label {
      font-size: 7pt;
      color: #999;
      font-style: italic;
    }
    
    .field-value {
      font-weight: bold;
      font-size: 9pt;
    }
    
    .tasking-fuel-row {
      display: grid;
      grid-template-columns: 1.2fr 0.6fr 2fr;
      gap: 4px;
      margin-bottom: 5px;
    }
    
    .weapon-field {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 2px;
      font-size: 7pt;
      color: #666;
      padding: 1px 3px;
    }
    
    .weapon-label {
      min-width: 22px;
      text-align: right;
    }
    
    .weapon-brackets {
      display: flex;
      gap: 16px;
      align-items: center;
    }
    
    .weapon-bracket {
      font-size: 10pt;
      color: #999;
    }
    
    .aircraft-section {
      display: grid;
      grid-template-columns: repeat(${getMaxFlightSize(results)}, 1fr);
      gap: 4px;
      margin-bottom: 4px;
    }
    
    .aircraft-card {
      border: 1px solid #333;
      padding: 1px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    
    .aircraft-row {
      display: flex;
      gap: 3px;
      align-items: stretch;
      margin-bottom: 2px;
    }
    
    .aircraft-left {
      display: flex;
      gap: 4px;
      align-items: center;
    }
    
    .aircraft-weapons {
      display: flex;
      flex-direction: column;
      gap: 2px;
      justify-content: center;
      margin-left: auto;
    }
    
    .aircraft-silhouette {
      width: 60px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px dashed #ccc;
      background: #f9f9f9;
      overflow: hidden;
    }
    
    .aircraft-silhouette img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    .health-checkboxes {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .checkbox {
      display: flex;
      align-items: center;
      gap: 3px;
      font-size: 7pt;
    }
    
    .checkbox-box {
      width: 10px;
      height: 10px;
      border: 1px solid black;
      display: inline-block;
      flex-shrink: 0;
    }
    
    .ordnance-area {
      border: 1px solid #666;
      min-height: 20px;
      margin-bottom: 0px;
      padding: 2px;
      width: 100%;
    }
    
    .ordnance-label {
      font-size: 7pt;
      color: #999;
      font-style: italic;
    }
    
    .ordnance-text {
      font-size: 7pt;
      margin-top: 2px;
      color: #333;
    }
    
    .ordnance-rolled {
      font-size: 7pt;
      padding: 2px;
      background: #f0f0f0;
      border-top: 1px solid #ccc;
      min-height: 12px;
    }
    
    .fuel-section {
      border: 1px solid #666;
      padding: 2px 4px;
      display: flex;
      align-items: center;
      gap: 3px;
    }
    
    .fuel-label {
      font-size: 7pt;
      font-weight: bold;
      white-space: nowrap;
    }
    
    .fuel-grid {
      display: grid;
      grid-template-columns: repeat(9, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 0px;
      flex: 1;
    }
    
    .fuel-box {
      width: 7px;
      height: 7px;
      border: 1px solid black;
      border-radius: 50%;
      flex-shrink: 0;
    }
    
    
    @media print {
      body {
        print-color-adjust: exact;
        -webkit-print-color-adjust: exact;
      }
      .flight-card {
        page-break-inside: avoid;
      }
      .faction-break {
        page-break-before: always;
      }
    }

  </style>
</head>
<body>
`;

      // Sort flights by faction: NATO first, then WP
      const natoFlights = results.filter(f => f.faction === 'NATO');
      const wpFlights = results.filter(f => f.faction === 'WP');
      


      // Add NATO title and grid only if there are NATO flights
      if (natoFlights.length > 0) {
        htmlContent += `
  <div class="page-title">Red Storm - Flight Sheet (NATO)</div>
  <div class="flight-grid" style="display:grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px;">
`;
      }
      
      // Generate NATO flight cards
      for (const flight of natoFlights) {
        htmlContent += generateFlightCard(flight);
      }
      
      // Close the NATO grid and add page break before WP flights if both factions exist
      if (natoFlights.length > 0 && wpFlights.length > 0) {
        htmlContent += `
  </div>
  <div style="page-break-after: always;"></div>
`;
      }
      
      // Add WP title and grid only if there are WP flights
      if (wpFlights.length > 0) {
        htmlContent += `
  <div class="page-title">Red Storm - Flight Sheet (Warsaw Pact)</div>
  <div class="flight-grid" style="display:grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px;">
`;
      }
      
      // Generate WP flight cards
      for (const flight of wpFlights) {
        htmlContent += generateFlightCard(flight);
      }

      htmlContent += `
  </div>
</body>
</html>
`;

    // Write the print window content
    printWindow.document.write(htmlContent);
    printWindow.document.close();
    }

    function getMaxFlightSize(results) {
      let max = 2;
      for (const flight of results) {
        const flightSize = parseInt(flight.flightSize) || 2;
        if (flightSize > max) max = flightSize;
      }
      return Math.min(max, 6); // Cap at 6 aircraft per row
    }

    function generateFlightCard(flight) {
      // Parse the result text to extract aircraft and flight info
      // Example result format: "FRG: 1 x {2} F-4F, CAP"
      // For multi-flight results (Table C): Individual flights separated by <br> tags
      const resultText = flight.result || '';
      const nationName = flight.nationName || '';
      const tableName = flight.tableName || '';
      
      // Check if this is a multi-flight result (contains <br> or semicolons)
      if (resultText.includes('<br>') || resultText.includes(';')) {
        // Split by <br> or semicolon and generate separate cards for each flight
        const separator = resultText.includes('<br>') ? '<br>' : ';';
        const flightParts = resultText.split(separator).map(part => part.trim()).filter(part => part.length > 0);
        let allCards = '';
        
        for (const flightPart of flightParts) {
          // Create a temporary flight object for each part
          const tempFlight = {
            ...flight,
            result: flightPart
          };
          allCards += generateSingleFlightCard(tempFlight);
        }
        
        return allCards;
      } else {
        // Single flight - process normally
        return generateSingleFlightCard(flight);
      }
    }
    
    function generateSingleFlightCard(flight) {
      const resultText = flight.result || '';
      const nationName = flight.nationName || '';
      const tableName = flight.tableName || '';
      const faction = flight.faction || 'NATO';
      
      // Extract aircraft type from result text
      let aircraft = 'Unknown';
      let flightSize = 4; // Default aircraft per flight
      let numFlights = 1; // Default number of flights
      let tasking = '';
      let ordnance = '';
      
      // Try to parse flight multiplier and size from "4 x {2}" pattern
      const flightSizeMatch = resultText.match(/(\d+)\s*x\s*\{(\d+)\}/);
      if (flightSizeMatch) {
        numFlights = parseInt(flightSizeMatch[1]); // Number of flights (4)
        flightSize = parseInt(flightSizeMatch[2]); // Aircraft per flight (2)
      }
      
      // Extract ordnance if present (text in parentheses)
      const ordnanceMatch = resultText.match(/\(([^)]+)\)/);
      if (ordnanceMatch) {
        ordnance = ordnanceMatch[1].trim();
      }
      
      // Extract aircraft type (everything after the } up to comma, excluding ordnance in parens)
      const aircraftMatch = resultText.match(/\}\s*([^,\(<]+)/);
      if (aircraftMatch) {
        aircraft = aircraftMatch[1].trim();
      }
      
      // For Table C format: "1 x {2} US F-4G" - nation is in the aircraft string
      // Extract nation from aircraft string if it starts with a nation code
      let extractedNation = nationName;
      const nationInAircraft = aircraft.match(/^(US|UK|FRG|CAN|HOL|BEL|USSR|DDR|POL|CZE)\s+(.+)/);
      if (nationInAircraft) {
        extractedNation = nationInAircraft[1];
        aircraft = nationInAircraft[2];
      }
      
      // Extract tasking (everything after comma, before ordnance parens or debug info)
      const taskingMatch = resultText.match(/,\s*([^<\(]+)/);
      if (taskingMatch) {
        tasking = taskingMatch[1].trim();
      } else {
        // Fallback: use table name if no explicit tasking
        tasking = tableName.split(' - ')[1] || tableName;
      }
      
      // Format aircraft display with nation
      const aircraftDisplay = extractedNation ? `${aircraft} (${extractedNation})` : aircraft;
      
      // Generate multiple flight cards if needed (for results like "4 x {2}")
      let allCards = '';
      for (let flightNum = 0; flightNum < numFlights; flightNum++) {
        let card = `
    <div class="flight-card">
      <!-- Header: Aircraft Type, Callsign, Counter, Aggression -->
      <div class="flight-header">
        <div class="field">
          <div class="field-value">${escapeHtml(aircraftDisplay)}</div>
        </div>
        <div class="field">
          <div class="field-label">Callsign</div>
        </div>
        <div class="field">
          <div class="field-label">Counter</div>
        </div>
        <div class="field">
          <div class="field-label">Aggression</div>
        </div>
      </div>
      
      <!-- Tasking and Fuel Row -->
      <div class="tasking-fuel-row">
        <div class="field">
          <div class="field-value">${escapeHtml(tasking)}</div>
        </div>
        <div class="field">
          <div class="field-label">Crew</div>
        </div>
        <div class="fuel-section">
          <div class="fuel-label">Fuel:</div>
          <div class="fuel-grid">
`;

        // Generate 18 fuel boxes in 2 rows of 9
        for (let i = 0; i < 18; i++) {
          card += `            <div class="fuel-box"></div>\n`;
        }

        card += `
          </div>
        </div>
      </div>
      
      <!-- Aircraft Section -->
      <div class="aircraft-section">
`;

        // Generate individual aircraft cards for this flight
        for (let i = 0; i < flightSize; i++) {
          card += `
        <div class="aircraft-card">
          <!-- Aircraft row with silhouette, health checkboxes, and weapons -->
          <div class="aircraft-row">
            <div class="aircraft-left">
        <div class="aircraft-silhouette" style="width:60px; height:50px; display:flex; align-items:center; justify-content:center; border:1px dashed #ccc; background:#f9f9f9; overflow:hidden;">
       <img 
         alt="${faction} Aircraft" 
         style="max-width:100%; max-height:100%; width:auto; height:auto; object-fit:contain; display:block;"
         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
         src="https://augustdragon.github.io/red-storm-tools-suite/assets/${faction === 'NATO' ? 'nato' : 'wp'}.jpg?v=${Date.now()}"
       >
                <svg width="60" height="50" viewBox="0 0 60 50" style="width: 100%; height: 100%; display: none;">
                  <!-- NATO aircraft silhouette (F-16 style) -->
                  <g fill="#666" style="display: ${faction === 'NATO' ? 'block' : 'none'}">
                    <ellipse cx="30" cy="25" rx="20" ry="3" />
                    <rect x="28" y="15" width="4" height="20" />
                    <polygon points="25,20 35,20 32,25 28,25" />
                    <polygon points="20,22 40,22 42,28 18,28" />
                    <polygon points="15,30 45,30 40,35 20,35" />
                  </g>
                  <!-- WP aircraft silhouette (MiG style) -->
                  <g fill="#666" style="display: ${faction === 'WP' ? 'block' : 'none'}">
                    <ellipse cx="30" cy="25" rx="18" ry="3" />
                    <rect x="29" y="15" width="2" height="20" />
                    <polygon points="27,20 33,20 31,25 29,25" />
                    <polygon points="22,22 38,22 40,27 20,27" />
                    <polygon points="18,30 42,30 38,34 22,34" />
                    <circle cx="25" cy="28" r="2" />
                    <circle cx="35" cy="28" r="2" />
                  </g>
                  <!-- Fallback if neither matches -->
                  <text x="30" y="30" text-anchor="middle" font-size="12" fill="#666" style="display: ${faction !== 'NATO' && faction !== 'WP' ? 'block' : 'none'}">${faction}</text>
                </svg>
              </div>
              
              <!-- Health checkboxes stacked vertically -->
              <div class="health-checkboxes">
                <div class="checkbox">
                  <span class="checkbox-box"></span>
                  <span>Da</span>
                </div>
                <div class="checkbox">
                  <span class="checkbox-box"></span>
                  <span>Cr</span>
                </div>
                <div class="checkbox">
                  <span class="checkbox-box"></span>
                  <span>‚ò†</span>
                </div>
              </div>
            </div>
            
            <!-- Air-to-air weapons stacked vertically on right -->
            <div class="aircraft-weapons">
              <div class="weapon-field">
                <span class="weapon-label">Gun</span>
                <span class="weapon-brackets">
                  <span class="weapon-bracket">{</span><span class="weapon-bracket">}</span>
                </span>
              </div>
              <div class="weapon-field">
                <span class="weapon-label">IRM</span>
                <span class="weapon-brackets">
                  <span class="weapon-bracket">{</span><span class="weapon-bracket">}</span>
                </span>
              </div>
              <div class="weapon-field">
                <span class="weapon-label">RHM</span>
                <span class="weapon-brackets">
                  <span class="weapon-bracket">{</span><span class="weapon-bracket">}</span>
                </span>
              </div>
            </div>
          </div>
          
          <!-- Ordnance area -->
          <div class="ordnance-area">
            <div class="ordnance-label">Ordnance</div>
          </div>
        </div>
`;
        }

        card += `
      </div>
    </div>
`;
        
        allCards += card;
      }

      return allCards;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize the app
    updateResultsDisplay();
    updateDateButtonStates(); // Set initial button states
  </script>
  
  <!-- Placeholder module references for future refactoring -->
  <!-- These modules are currently empty placeholders and don't affect functionality -->
  <script src="js/utils.js"></script>
  <script src="js/dice-roller.js"></script>
  <script src="js/state-manager.js"></script>
  <script src="js/table-processor.js"></script>
  <script src="js/ui-controller.js"></script>
  <script src="js/print-generator.js"></script>
  <script src="js/app.js"></script>
</body>
</html>