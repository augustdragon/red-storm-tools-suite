<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flight Sheet Designer - Red Storm</title>
  <link rel="stylesheet" href="../shared/red-storm.css">
  <style>
    /* Override body for designer-specific styling */
    body {
      padding: 20px;
    }
    
    .designer-container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      padding: 15px;
      background-color: #3a4a3a;
      border-radius: 8px;
    }
    
    .controls button {
      padding: 10px 20px;
      background-color: #4a5a4a;
      color: #f4f4f4;
      border: 1px solid #6a7a6a;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .controls button:hover {
      background-color: #5a6a5a;
    }
    
    .controls select {
      padding: 10px 15px;
      background-color: #2d3a2d;
      color: #f4f4f4;
      border: 2px solid #4a5a4a;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      min-width: 200px;
    }
    
    .controls select:hover {
      background-color: #3a4a3a;
    }
    
    .controls label {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #d4e4d4;
      font-size: 14px;
    }
    
    .preview-frame {
      background: white;
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    /* Print Preview Styles */
    @page {
      size: letter;
      margin: 0.5in;
    }
    
    .page-title {
      text-align: center;
      font-size: 14pt;
      font-weight: bold;
      margin-bottom: 12px;
      border-bottom: 2px solid black;
      padding-bottom: 3px;
      color: black;
    }
    
    .flight-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .flight-card {
      border: 2px solid black;
      padding: 6px;
      page-break-inside: avoid;
      background: white;
      max-width: 450px;
      color: black;
      display: flex;
      flex-direction: column;
    }
    
    .flight-info-section {
      border-bottom: 2px solid black;
      padding-bottom: 4px;
      margin-bottom: 4px;
    }
    
    .flight-header {
      display: grid;
      grid-template-columns: 50px auto 1.2fr 50px 0.8fr;
      gap: 4px;
      margin-bottom: 4px;
      align-items: stretch;
    }
    
    .roundel-box-header {
      border: 1px solid #666;
      padding: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      min-height: 18px;
      max-height: 28px;
    }
    
    .roundel-box-header img {
      max-width: 100%;
      height: 28px;
      width: auto;
      object-fit: contain;
    }
    
    .flight-weapons-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      padding: 3px;
      background: #f5f5f5;
    }
    
    .weapons-display {
      display: flex;
      gap: 15px;
      font-size: 7pt;
    }
    
    .weapon-item {
      display: flex;
      gap: 3px;
    }
    
    .weapon-item .weapon-label {
      font-weight: bold;
    }
    
    .aircraft-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 3px;
    }
    
    .aircraft-box {
      border: 1px solid #666;
      padding: 3px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 120px;
      position: relative;
    }
    
    .aircraft-header {
      display: flex;
      flex-direction: row;
      gap: 3px;
      margin-bottom: 3px;
      width: 100%;
    }
    
    .aircraft-number {
      border: 1px solid #666;
      width: 16px;
      height: 16px;
      background: white;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 7pt;
      font-weight: bold;
      flex-shrink: 0;
    }
    
    .damage-boxes {
      display: flex;
      flex-direction: row;
      gap: 2px;
    }
    
    .damage-column {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }
    
    .damage-row {
      display: flex;
      gap: 2px;
      align-items: center;
    }
    
    .damage-label {
      border: 1px solid #666;
      padding: 1px 3px;
      height: 16px;
      font-size: 6pt;
      background: white;
      display: flex;
      align-items: center;
      min-width: 50px;
      box-sizing: border-box;
    }
    
    .damage-checkbox {
      border: 1px solid #666;
      width: 16px;
      height: 16px;
      background: white;
      box-sizing: border-box;
    }
    
    .ordnance-area-small {
      border: none;
      border-top: 1px solid #666;
      padding: 4px 0;
      padding-top: 6px;
      min-height: 60px;
      width: 100%;
      background: white;
      flex: 1;
    }
    
    .ordnance-label-small {
      font-size: 7pt;
      color: #999;
      font-style: italic;
    }
    
    .fuel-box {
      border: 1px solid #666;
      padding: 2px 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .fuel-circles-row {
      display: flex;
      gap: 2px;
    }
    
    .fuel-circle {
      width: 10px;
      height: 10px;
      border: 1px solid #666;
      border-radius: 50%;
      background: white;
    }
    
    .field {
      border: 1px solid #666;
      padding: 2px 4px;
      min-height: 18px;
      max-height: 28px;
      overflow: hidden;
      white-space: nowrap;
    }
    
    .field-label {
      font-size: 7pt;
      color: #999;
      font-style: italic;
    }
    
    .field-value {
      font-weight: bold;
      font-size: 7pt;
    }
    
    .tasking-fuel-row {
      display: grid;
      grid-template-columns: 0.7fr 0.9fr 0.8fr;
      gap: 4px;
      margin-bottom: 5px;
    }
    
    .fuel-box {
      border: 1px solid #666;
      padding: 2px 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .fuel-label-value {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1px;
      font-size: 7pt;
      white-space: nowrap;
    }
    
    .fuel-label-value .field-label {
      margin: 0;
    }
    
    .fuel-label-value .fuel-value {
      font-weight: bold;
      font-size: 7pt;
    }
    
    .fuel-circles-container {
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1;
    }
    
    .fuel-circles-row {
      display: flex;
      gap: 2px;
    }
    
    .aircraft-section {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 4px;
      margin-bottom: 4px;
    }
    
    .aircraft-card {
      border: 1px solid #333;
      padding: 3px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 3px;
      position: relative;
    }
    
    .aircraft-top-row {
      display: flex;
      gap: 3px;
      position: relative;
    }
    
    .damage-status-container {
      position: absolute;
      right: 3px;
      top: 3px;
      border: 1px solid #666;
    }
    
    .damage-table {
      border-collapse: collapse;
      font-size: 6pt;
      font-weight: bold;
    }
    
    .damage-table td {
      border: 1px solid #666;
      padding: 0px 3px;
      text-align: center;
    }
    
    .damage-table .damage-label {
      padding: 0px 3px;
      text-align: right;
      width: 30px;
    }
    
    .damage-table .damage-cell {
      width: 18px;
      height: 14px;
      background: white;
    }
    
    .aircraft-stats {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 7pt;
      padding-left: 3px;
      padding-right: 60px;
    }
    
    .stat-row {
      display: flex;
      gap: 4px;
    }
    
    .stat-item {
      display: flex;
      gap: 2px;
    }
    
    .stat-label {
      font-weight: bold;
    }
    
    .rwr-jam-column {
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-left: auto;
    }
    
    .speed-table {
      border: 1px solid #666;
      border-collapse: collapse;
      width: 100%;
      font-size: 6pt;
      margin-top: 2px;
    }
    
    .speed-table th,
    .speed-table td {
      border: 1px solid #666;
      padding: 1px 2px;
      text-align: center;
    }
    
    .speed-table th {
      background: #e0e0e0;
      font-weight: bold;
    }
    
    .radar-info {
      font-size: 6pt;
      line-height: 1.3;
      margin-top: 2px;
      display: flex;
      justify-content: space-between;
      gap: 4px;
    }
    
    .radar-left {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    
    .radar-right {
      display: flex;
      flex-direction: column;
      gap: 1px;
      align-items: flex-end;
    }
    
    .weapons-container {
      display: flex;
      flex-direction: column;
      gap: 2px;
      padding-left: 10px;
    }
    
    .weapon-line {
      font-size: 6pt;
      display: flex;
      justify-content: flex-end;
      gap: 2px;
    }
    
    .weapon-label {
      font-weight: bold;
      text-align: right;
    }
    
    .weapon-value {
      font-weight: normal;
    }
    
    .crew-info {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0px;
      font-size: 6pt;
      position: absolute;
      right: 3px;
      top: 85px;
    }
    
    .crew-icon {
      font-size: 16pt;
      filter: grayscale(100%) brightness(0%);
    }
    
    .crew-count {
      border: 1px solid #666;
      padding: 1px 4px;
      font-size: 7pt;
      font-weight: bold;
      background: white;
      min-width: 10px;
      text-align: center;
    }
    
    .speed-table {
      margin-top: 20px;
    }
    
    .ordnance-area {
      border: 1px solid #999;
      padding: 3px;
      min-height: 30px;
      background: #fafafa;
    }
    
    .ordnance-label {
      font-size: 6pt;
      color: #666;
      margin-bottom: 2px;
    }
    
    .ordnance-text {
      font-size: 7pt;
      font-weight: bold;
    }
    
    @media print {
      body {
        background: white;
        padding: 0;
      }
      
      .designer-container {
        max-width: none;
      }
      
      .header, .controls {
        display: none;
      }
      
      .preview-frame {
        padding: 0;
        box-shadow: none;
      }
    }
  </style>
</head>
<body>
  <div class="designer-container">
    <div class="header">
      <h1>üé® Flight Sheet Designer</h1>
      <p>Design and test alternative flight sheet layouts</p>
    </div>
    
    <div class="controls">
      <label>
        Nation:
        <select id="nationSelector">
          <option value="">-- All Nations --</option>
          <option value="US">United States (USAF)</option>
          <option value="UK">United Kingdom (RAF)</option>
          <option value="FRG">West Germany (Luftwaffe)</option>
          <option value="Belgium">Belgium</option>
          <option value="Canada">Canada</option>
          <option value="Netherlands">Netherlands</option>
          <option value="USSR">Soviet Union (VVS)</option>
          <option value="GDR">East Germany (LSK)</option>
        </select>
      </label>
      <label>
        Aircraft:
        <select id="aircraftSelector">
          <option value="">-- Select Aircraft --</option>
        </select>
      </label>
      <label>
        Flight Size:
        <select id="flightSizeSelector">
          <option value="1">1-ship</option>
          <option value="2">2-ship</option>
          <option value="4">4-ship</option>
        </select>
      </label>
      <button onclick="generateTestFlight()">üéØ Generate Flight</button>
      <button onclick="loadSampleData()">üìÑ Load Sample Flights</button>
      <button onclick="window.print()">üñ®Ô∏è Print Preview</button>
      <button onclick="clearPreview()">üóëÔ∏è Clear</button>
      <button onclick="exportDesign()">üíæ Export HTML</button>
    </div>
    
    <div class="preview-frame" id="previewFrame">
      <div class="page-title">Red Storm - Flight Sheet (Sample)</div>
      <div class="flight-grid" id="flightGrid">
        <p style="color: #999; text-align: center; padding: 40px;">
          Click "Load Sample Flights" to preview the flight sheet design
        </p>
      </div>
    </div>
  </div>
  
  <script>
    // Global data stores
    let aircraftDatabase = {};
    let weaponsDatabase = {};
    
    // Load JSON databases
    async function loadDatabases() {
      try {
        const [aircraftNatoResponse, aircraftWpResponse, weaponsResponse] = await Promise.all([
          fetch('data/aircraft-nato.json'),
          fetch('data/aircraft-wp.json'),
          fetch('data/weapons.json')
        ]);
        
        const aircraftNato = await aircraftNatoResponse.json();
        const aircraftWp = await aircraftWpResponse.json();
        weaponsDatabase = await weaponsResponse.json();
        
        // Merge NATO and WP databases
        aircraftDatabase = { ...aircraftNato, ...aircraftWp };
        
        // Remove metadata fields
        delete aircraftDatabase._comment;
        delete aircraftDatabase._version;
        delete aircraftDatabase._created;
        delete aircraftDatabase._description;
        
        console.log('Databases loaded:', Object.keys(aircraftDatabase).length, 'aircraft');
        return true;
      } catch (error) {
        console.error('Error loading databases:', error);
        alert('Error loading aircraft database. Using fallback data.');
        return false;
      }
    }
    
    // Populate aircraft dropdown
    function populateAircraftDropdown() {
      const selector = document.getElementById('aircraftSelector');
      const nationFilter = document.getElementById('nationSelector').value;
      selector.innerHTML = '<option value="">-- Select Aircraft --</option>';
      
      Object.keys(aircraftDatabase).forEach(key => {
        const aircraft = aircraftDatabase[key];
        
        // Filter by nation if one is selected
        if (nationFilter) {
          // Check if aircraft matches the selected nation
          const matchesNation = aircraft.nation === nationFilter || 
                               (aircraft.nationOptions && aircraft.nationOptions.includes(nationFilter));
          if (!matchesNation) {
            return; // Skip this aircraft
          }
        }
        
        const option = document.createElement('option');
        option.value = key;
        // Display name with nation to differentiate variants (e.g., F-16A Fighting Falcon [US])
        let nationLabel;
        if (aircraft.nationOptions) {
          // Abbreviate Belgium/Canada/Netherlands to BE/CA/NE
          const abbreviated = aircraft.nationOptions.map(n => 
            n === 'Belgium' ? 'BE' : 
            n === 'Canada' ? 'CA' : 
            n === 'Netherlands' ? 'NE' : n
          ).join('/');
          nationLabel = `[${abbreviated}]`;
        } else {
          nationLabel = `[${aircraft.nation}]`;
        }
        option.textContent = `${aircraft.name} ${nationLabel}`;
        selector.appendChild(option);
      });
    }
    
    // Generate test flight based on dropdown selections
    async function generateTestFlight() {
      const aircraftKey = document.getElementById('aircraftSelector').value;
      const flightSize = document.getElementById('flightSizeSelector').value;
      
      if (!aircraftKey) {
        return; // No aircraft selected
      }
      
      // Ensure databases are loaded
      if (Object.keys(aircraftDatabase).length === 0) {
        await loadDatabases();
        populateAircraftDropdown();
      }
      
      const aircraft = aircraftDatabase[aircraftKey];
      if (!aircraft) {
        console.error('Aircraft not found:', aircraftKey);
        return;
      }
      
      // Create a test flight object
      const testFlight = {
        id: Date.now(),
        table: 'Test',
        faction: 'NATO',
        tableName: 'Test Flight',
        result: `${aircraft.nation}: 1 x {${flightSize}} ${aircraft.name}, CAP`,
        debugText: '[Test Flight]',
        timestamp: Date.now(),
        aircraft: aircraftKey,
        crew: aircraft.crew,
        fuel: aircraft.fuel
      };
      
      // Clear and display the test flight
      const grid = document.getElementById('flightGrid');
      grid.innerHTML = '';
      grid.appendChild(createFlightCard(testFlight));
    }
    
    // Convert JSON aircraft data to display format
    function convertAircraftData(jsonData, altitudeBand = 'H') {
      if (!jsonData) return null;
      
      // Helper function to extract speed for a specific altitude band
      function extractSpeedForBand(speedString, index) {
        if (!speedString || speedString === 'N/A') return 'N/A';
        const values = speedString.split('/');
        return values[index] || 'N/A';
      }
      
      // Build weapon display strings
      let gunDisplay = '';
      if (jsonData.weapons.gun && jsonData.weapons.gunAmmo) {
        const gunData = weaponsDatabase.guns[jsonData.weapons.gun];
        const rating = gunData ? `+${gunData.stdRtg}` : '+3';
        gunDisplay = `${rating} {${jsonData.weapons.gunAmmo}}`;
      }
      
      let irmDisplay = '';
      if (jsonData.weapons.irm && jsonData.weapons.irmAmmo) {
        const missileData = weaponsDatabase.missiles[jsonData.weapons.irm];
        const stdRtg = missileData ? `+${missileData.stdRtg}` : '+3';
        const bvrRtg = missileData && missileData.bvrRtg !== null 
          ? `/${missileData.bvrRtg > 0 ? '+' : ''}${missileData.bvrRtg}` 
          : '/NA';
        irmDisplay = `${stdRtg}${bvrRtg} {${jsonData.weapons.irmAmmo}}`;
      }
      
      let rhmDisplay = '';
      if (jsonData.weapons.rhm && jsonData.weapons.rhmAmmo) {
        const missileData = weaponsDatabase.missiles[jsonData.weapons.rhm];
        const stdRtg = missileData ? `+${missileData.stdRtg}` : '+3';
        const bvrRtg = missileData && missileData.bvrRtg !== null 
          ? `/${missileData.bvrRtg > 0 ? '+' : ''}${missileData.bvrRtg}` 
          : '/NA';
        rhmDisplay = `${stdRtg}${bvrRtg} {${jsonData.weapons.rhmAmmo}}`;
      }
      
      // Build radar display
      let radarDisplay = null;
      let radarModifier = null;
      if (jsonData.radar && jsonData.radar.name) {
        radarDisplay = jsonData.radar.name;
        if (jsonData.radar.type) radarDisplay += ` ${jsonData.radar.type}`;
        if (jsonData.radar.range) radarDisplay += ` [${jsonData.radar.range}]`;
        if (jsonData.radar.modifier) radarModifier = jsonData.radar.modifier;
      }
      
      // RWR and Jam are separate fields - filter out dash-only values
      const rwrDisplay = (jsonData.rwr && jsonData.rwr !== '-' && jsonData.rwr !== '-/-') ? jsonData.rwr : null;
      const jamDisplay = (jsonData.jam && jsonData.jam !== '-' && jsonData.jam !== '-/-') ? jsonData.jam : null;
      
      // Build ordnance string
      const ordnanceStr = jsonData.ordnance && jsonData.ordnance.length > 0
        ? jsonData.ordnance.map(o => o.quantity ? `${o.type}(${o.quantity})` : o.type).join(', ')
        : '';
      
      // Build capabilities string
      const capabilitiesStr = jsonData.capabilities && jsonData.capabilities.length > 0
        ? jsonData.capabilities.join(', ')
        : '';
      
      // Extract speeds for display - each altitude band gets its own extracted values
      const speeds = {};
      if (jsonData.speeds && jsonData.speeds.clean) {
        // For each altitude band, extract the corresponding value from the L/M/H/VH format
        const altitudeBands = ['VH', 'H', 'M', 'L/D'];
        const indices = { 'VH': 3, 'H': 2, 'M': 1, 'L/D': 0 };
        
        altitudeBands.forEach(band => {
          const idx = indices[band];
          speeds[band] = {
            combat: extractSpeedForBand(jsonData.speeds.clean.combat, idx),
            dash: extractSpeedForBand(jsonData.speeds.clean.dash, idx),
            maneuver: extractSpeedForBand(jsonData.speeds.clean.maneuver, idx)
          };
        });
      }
      
      // Helper function to extract speed for a specific altitude band
      function extractSpeedForBand(speedString, index) {
        if (!speedString || speedString === 'N/A') return 'N/A';
        const values = speedString.split('/');
        return values[index] || 'N/A';
      }
      
      let speedsLaden = null;
      if (jsonData.speeds && jsonData.speeds.laden) {
        speedsLaden = {};
        const altitudeBands = ['VH', 'H', 'M', 'L/D'];
        const indices = { 'VH': 3, 'H': 2, 'M': 1, 'L/D': 0 };
        
        altitudeBands.forEach(band => {
          const idx = indices[band];
          speedsLaden[band] = {
            combat: extractSpeedForBand(jsonData.speeds.laden.combat, idx),
            dash: extractSpeedForBand(jsonData.speeds.laden.dash, idx),
            maneuver: extractSpeedForBand(jsonData.speeds.laden.maneuver, idx)
          };
        });
      }
      
      return {
        model: jsonData.model,
        nation: jsonData.nation,
        crew: jsonData.crew,
        rwy: jsonData.rwy,
        fuel: jsonData.fuel,
        notes: jsonData.notes,
        gun: gunDisplay,
        irm: irmDisplay,
        rhm: rhmDisplay,
        rwr: rwrDisplay,
        jam: jamDisplay,
        ordnance: ordnanceStr,
        aam: jsonData.aam,
        bomb: jsonData.bomb,
        sight: jsonData.sight,
        capabilities: capabilitiesStr,
        speeds: speeds,
        speedsClean: speeds,
        speedsLaden: speedsLaden,
        hasCleanLaden: speedsLaden !== null,
        radar: radarDisplay,
        radarModifier: radarModifier
      };
    }
    
    // Sample flight data for testing
    const sampleFlights = [
      {
        id: 1,
        table: 'A',
        faction: 'NATO',
        tableName: 'NATO Table A - QRA Flight',
        result: 'US: 1 x {4} F-15C Eagle, CAP',
        debugText: '[Nation: 3 | Aircraft: 7]',
        timestamp: Date.now(),
        aircraft: 'F-15C',
        crew: 1,
        fuel: 8
      },
      {
        id: 2,
        table: 'A',
        faction: 'NATO',
        tableName: 'NATO Table A - QRA Flight',
        result: 'US: 1 x {2} F-16C Fighting Falcon, CAP',
        debugText: '[Nation: 3 | Aircraft: 8]',
        timestamp: Date.now(),
        aircraft: 'F-16C',
        crew: 1,
        fuel: 6
      },
      {
        id: 3,
        table: 'B',
        faction: 'NATO',
        tableName: 'NATO Table B - Strike Package',
        result: 'US: 1 x {4} F-16A Fighting Falcon, Strike',
        debugText: '[Nation: 3 | Aircraft: 8]',
        timestamp: Date.now(),
        aircraft: 'F-16A',
        crew: 1,
        fuel: 6
      },
      {
        id: 4,
        table: 'C',
        faction: 'NATO',
        tableName: 'NATO Table C - Heavy Strike',
        result: 'US: 1 x {2} F-4E Phantom II, Strike',
        debugText: '[Nation: 2 | Aircraft: 5]',
        timestamp: Date.now(),
        aircraft: 'F-4E',
        crew: 2,
        fuel: 10
      }
    ];
    
    // F-15C aircraft data
    const f15cData = {
      crew: 1,
      rwy: 3,
      fuel: 15,
      notes: 'A, C, M, P',
      gun: '+3 {2}',
      irm: '+3/+1 {3}',
      rhm: '+3/+2 {3}',
      rwr: 'C',
      jam: '3d',
      ordnance: '',
      capabilities: 'Night',
      speeds: {
        'VH': { combat: 'N/A', dash: 'N/A', maneuver: 'N/A' },
        'H': { combat: '5', dash: '8', maneuver: '9' },
        'M': { combat: '4', dash: '6', maneuver: '9' },
        'L/D': { combat: '4', dash: '5', maneuver: '8' }
      },
      radar: 'APG-63PSPLD TS [30]',
      radarModifier: '24+ : -1'
    };
    
    // F-16C aircraft data
    const f16cData = {
      crew: 1,
      rwy: 2,
      fuel: 6,
      notes: 'A, C, L, M, P',
      gun: '+3 {2}',
      irm: '+3/+1 {3}',
      rhm: '',
      rwr: 'C',
      jam: '3d',
      ordnance: 'EOGM(1), HARM(1), Shrike(1)',
      aam: 'AIM-9M',
      bomb: '3',
      sight: '+3',
      capabilities: 'Radar, TFR, Night',
      speeds: {
        'VH': { combat: 'N/A', dash: 'N/A', maneuver: 'N/A' },
        'H': { combat: '5', dash: '8', maneuver: '9' },
        'M': { combat: '4', dash: '6', maneuver: '9' },
        'L/D': { combat: '4', dash: '5', maneuver: '8' }
      },
      speedsClean: {
        'VH': { combat: 'N/A', dash: 'N/A', maneuver: 'N/A' },
        'H': { combat: '5', dash: '8', maneuver: '9' },
        'M': { combat: '4', dash: '6', maneuver: '9' },
        'L/D': { combat: '4', dash: '5', maneuver: '8' }
      },
      speedsLaden: {
        'VH': { combat: 'N/A', dash: 'N/A', maneuver: 'N/A' },
        'H': { combat: '4', dash: '5', maneuver: '5' },
        'M': { combat: '3', dash: '5', maneuver: '5' },
        'L/D': { combat: '3', dash: '4', maneuver: '4' }
      },
      hasCleanLaden: true,
      radar: 'APG-68 LD TS [16]',
      radarModifier: '14+ : -1'
    };
    
    async function loadSampleData() {
      // Load databases if not already loaded
      if (Object.keys(aircraftDatabase).length === 0) {
        await loadDatabases();
        populateAircraftDropdown();
      }
      
      const grid = document.getElementById('flightGrid');
      grid.innerHTML = '';
      
      sampleFlights.forEach(flight => {
        grid.appendChild(createFlightCard(flight));
      });
    }
    
    function createFlightCard(flight) {
      const card = document.createElement('div');
      card.className = 'flight-card';
      
      // Parse the result to extract flight information
      const resultLines = flight.result.split('<br>');
      const firstLine = resultLines[0];
      
      // Extract nation and aircraft from the first line
      const match = firstLine.match(/^([^:]+):\s*(\d+)\s*x\s*{(\d+)}\s*([^,]+),\s*(.+)$/);
      
      let nation = 'Unknown';
      let flightCount = '1';
      let flightSize = '2';
      let aircraft = 'Unknown';
      let tasking = 'CAP';
      
      if (match) {
        nation = match[1].trim();
        flightCount = match[2];
        flightSize = match[3];
        aircraft = match[4].trim();
        tasking = match[5].trim();
      }
      
      // Select aircraft data from database
      let aircraftData = null;
      
      // If flight object has aircraft key, use it directly (for test flights from dropdown)
      let aircraftKey = flight.aircraft;
      
      // Otherwise, parse from result string (for OOB generator results)
      if (!aircraftKey || !aircraftDatabase[aircraftKey]) {
        // Try exact match first, then partial match
        aircraftKey = Object.keys(aircraftDatabase).find(key => 
          key === aircraft || aircraftDatabase[key].name === aircraft
        );
        
        // If no exact match, try partial match (but prefer longer keys first to avoid GR.1 matching before GR.1A)
        if (!aircraftKey) {
          const sortedKeys = Object.keys(aircraftDatabase).sort((a, b) => b.length - a.length);
          aircraftKey = sortedKeys.find(key => 
            aircraft.includes(key) || aircraftDatabase[key].name.includes(aircraft)
          );
        }
      }
      
      if (aircraftKey) {
        aircraftData = convertAircraftData(aircraftDatabase[aircraftKey]);
      }
      
      // Fallback to hardcoded data if not found
      if (!aircraftData) {
        aircraftData = aircraft.includes('F-16') ? f16cData : f15cData;
      }
      
      card.innerHTML = `
        <!-- Flight-level information -->
        <div class="flight-info-section">
          <div class="flight-header">
            <div class="roundel-box-header">
              <img src="assets/${
                aircraftData.nation === 'US' ? 'USAF.jpg' : 
                aircraftData.nation === 'UK' ? 'UK.jpg' : 
                aircraftData.nation === 'FRG' ? 'FRG.jpg' :
                aircraftData.nation === 'Belgium' ? 'Belgium.jpg' :
                aircraftData.nation === 'Netherlands' ? 'Netherlands.jpg' :
                aircraftData.nation === 'Canada' ? 'Canada.jpg' :
                aircraftData.nation === 'Soviet' || aircraftData.nation === 'USSR' ? 'USSR.jpg' :
                aircraftData.nation === 'GDR' ? 'GDR.jpg' :
                'USAF.jpg'
              }" alt="${aircraftData.nation || 'US'} Roundel">
            </div>
            <div class="field">
              <div class="field-label">Aircraft</div>
              <div class="field-value">${aircraftData.model || aircraft}</div>
            </div>
            <div class="field">
              <div class="field-label">Callsign</div>
              <div class="field-value"></div>
            </div>
            <div class="field">
              <div class="field-label">Counter</div>
              <div class="field-value"></div>
            </div>
            <div class="field">
              <div class="field-label">Aggr.</div>
              <div class="field-value"></div>
            </div>
          </div>
          
          <div class="tasking-fuel-row">
            <div class="field">
              <div class="field-label">Tasking</div>
              <div class="field-value">${tasking}</div>
            </div>
            <div class="fuel-box">
              <div class="fuel-label-value">
                <span class="field-label">Fuel</span>
                <span class="fuel-value">${aircraftData.fuel || flight.fuel || 18}</span>
              </div>
              <div class="fuel-circles-container">
                ${typeof (aircraftData.fuel || flight.fuel) === 'number' ? `
                <div class="fuel-circles-row">
                  ${Array(Math.ceil((aircraftData.fuel || flight.fuel || 18) / 2)).fill(0).map(() => 
                    `<div class="fuel-circle"></div>`
                  ).join('')}
                </div>
                <div class="fuel-circles-row">
                  ${Array(Math.floor((aircraftData.fuel || flight.fuel || 18) / 2)).fill(0).map(() => 
                    `<div class="fuel-circle"></div>`
                  ).join('')}
                </div>
                ` : ''}
              </div>
            </div>
            <div class="field">
              <div class="field-label">Notes</div>
              <div class="field-value">${aircraftData.notes || ''}</div>
            </div>
          </div>
          
          <div class="flight-weapons-row">
            <div class="weapons-display">
              ${aircraftData.gun ? `<div class="weapon-item">
                <span class="weapon-label">Gun:</span>
                <span>${aircraftData.gun}</span>
              </div>` : ''}
              ${aircraftData.irm ? `<div class="weapon-item">
                <span class="weapon-label">IRM:</span>
                <span>${aircraftData.irm}</span>
              </div>` : ''}
              ${aircraftData.rhm ? `<div class="weapon-item">
                <span class="weapon-label">RHM:</span>
                <span>${aircraftData.rhm}</span>
              </div>` : ''}
            </div>
            ${aircraftData.crew || aircraftData.rwy ? `<div style="display: flex; gap: 10px; font-size: 7pt;">
              ${aircraftData.crew ? `<div><strong>Crew:</strong> ${aircraftData.crew}</div>` : ''}
              ${aircraftData.rwy ? `<div><strong>Rwy:</strong> ${aircraftData.rwy}</div>` : ''}
            </div>` : ''}
          </div>
          
          ${aircraftData.ordnance || aircraftData.aam || aircraftData.bomb || (aircraftData.sight && aircraftData.sight !== '-') ? `<div style="padding: 3px; background: #f5f5f5; font-size: 7pt; margin-bottom: 4px;">
            ${aircraftData.aam ? `<strong>AAM:</strong> ${aircraftData.aam}` : ''}${(aircraftData.aam && aircraftData.ordnance) ? ' | ' : ''}${aircraftData.ordnance ? `<strong>Ordnance:</strong> ${aircraftData.ordnance}` : ''}${((aircraftData.aam || aircraftData.ordnance) && aircraftData.bomb) ? ' | ' : ''}${aircraftData.bomb ? `<strong>Bomb:</strong> ${aircraftData.bomb}` : ''}${((aircraftData.aam || aircraftData.ordnance || aircraftData.bomb) && aircraftData.sight && aircraftData.sight !== '-') ? ' | ' : ''}${aircraftData.sight && aircraftData.sight !== '-' ? `<strong>Sight:</strong> ${aircraftData.sight}` : ''}
          </div>` : ''}
          
          ${aircraftData.radar || aircraftData.rwr || aircraftData.jam ? `<div style="padding: 3px; background: #f5f5f5; font-size: 7pt; margin-bottom: 4px;">
            ${aircraftData.radar ? `<strong>Radar:</strong> ${aircraftData.radar} ${aircraftData.radarModifier || ''}` : ''}
            ${aircraftData.radar && aircraftData.rwr ? ' | ' : ''}
            ${aircraftData.rwr ? `<strong>RWR:</strong> ${aircraftData.rwr}` : ''}
            ${(aircraftData.radar || aircraftData.rwr) && aircraftData.jam ? ' | ' : ''}
            ${aircraftData.jam ? `<strong>Jam:</strong> ${aircraftData.jam}` : ''}
          </div>` : ''}
          
          ${aircraftData.capabilities ? `<div style="padding: 3px; background: #f5f5f5; font-size: 7pt; margin-bottom: 4px;">
            <strong>Capabilities:</strong> ${aircraftData.capabilities}
          </div>` : ''}
          
          ${aircraftData.hasCleanLaden ? `
          <table class="speed-table">
            <tr>
              <th rowspan="2">Alt</th>
              <th colspan="3">Clean</th>
              <th colspan="3">Laden</th>
            </tr>
            <tr>
              <th>C</th>
              <th>D</th>
              <th>M</th>
              <th>C</th>
              <th>D</th>
              <th>M</th>
            </tr>
            ${Object.keys(aircraftData.speedsClean).map(alt => `
              <tr>
                <td><strong>${alt}</strong></td>
                <td>${aircraftData.speedsClean[alt].combat}</td>
                <td>${aircraftData.speedsClean[alt].dash}</td>
                <td>${aircraftData.speedsClean[alt].maneuver}</td>
                <td>${aircraftData.speedsLaden[alt].combat}</td>
                <td>${aircraftData.speedsLaden[alt].dash}</td>
                <td>${aircraftData.speedsLaden[alt].maneuver}</td>
              </tr>
            `).join('')}
          </table>
          ` : `
          <table class="speed-table">
            <tr>
              <th>Alt</th>
              <th>C</th>
              <th>D</th>
              <th>M</th>
            </tr>
            ${Object.entries(aircraftData.speeds).map(([alt, speeds]) => `
              <tr>
                <td><strong>${alt}</strong></td>
                <td>${speeds.combat}</td>
                <td>${speeds.dash}</td>
                <td>${speeds.maneuver}</td>
              </tr>
            `).join('')}
          </table>
          `}
        </div>
        
        <!-- Individual aircraft boxes -->
        <div class="aircraft-grid">
          ${Array(parseInt(flightSize)).fill(0).map((_, i) => `
            <div class="aircraft-box">
              <div class="aircraft-header">
                <div class="aircraft-number">${i + 1}</div>
                <div class="damage-boxes">
                  <div class="damage-column">
                    <div class="damage-row">
                      <div class="damage-label">Damaged</div>
                      <div class="damage-checkbox"></div>
                    </div>
                    <div class="damage-row">
                      <div class="damage-label">Crippled</div>
                      <div class="damage-checkbox"></div>
                    </div>
                    <div class="damage-row">
                      <div class="damage-label">Destroyed</div>
                      <div class="damage-checkbox"></div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="ordnance-area-small">
                <div class="ordnance-label-small">Ordnance</div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
      
      return card;
    }
    
    function extractOrdnance(resultLines) {
      // Extract ordnance from lines that contain it
      const ordnanceLines = resultLines.filter(line => line.includes('(') && line.includes(')'));
      if (ordnanceLines.length === 0) return 'Standard loadout';
      
      // Extract just the ordnance part (in parentheses)
      const ordnance = ordnanceLines.map(line => {
        const match = line.match(/\(([^)]+)\)/);
        return match ? match[1] : '';
      }).filter(Boolean);
      
      return ordnance.length > 0 ? ordnance.join(' / ') : 'Standard loadout';
    }
    
    function clearPreview() {
      document.getElementById('flightGrid').innerHTML = `
        <p style="color: #999; text-align: center; padding: 40px;">
          Click "Load Sample Flights" to preview the flight sheet design
        </p>
      `;
    }
    
    function exportDesign() {
      const previewFrame = document.getElementById('previewFrame');
      const htmlContent = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Red Storm - Flight Sheet</title>
  <style>
${document.querySelector('style').textContent}
  </style>
</head>
<body>
${previewFrame.innerHTML}
</body>
</html>`;
      
      const blob = new Blob([htmlContent], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'flight-sheet-design.html';
      a.click();
      URL.revokeObjectURL(url);
      
      alert('Design exported! You can open the file to see the standalone version.');
    }
    
    // Auto-load databases and sample data on page load
    window.addEventListener('load', async () => {
      await loadDatabases();
      populateAircraftDropdown();
      setTimeout(loadSampleData, 500);
      
      // Add event listeners to dropdowns for automatic generation
      document.getElementById('nationSelector').addEventListener('change', () => {
        populateAircraftDropdown();
        generateTestFlight();
      });
      document.getElementById('aircraftSelector').addEventListener('change', generateTestFlight);
      document.getElementById('flightSizeSelector').addEventListener('change', generateTestFlight);
    });
  </script>
</body>
</html>
