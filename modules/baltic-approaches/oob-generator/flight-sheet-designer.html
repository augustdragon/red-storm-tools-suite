<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flight Sheet Designer - Baltic Approaches</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="stylesheet" href="/shared/css/red-storm.css">
  <style>
    /* Override body for designer-specific styling */
    body {
      padding: 20px;
      font-family: Arial, sans-serif;
    }
    
    .designer-container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .controls {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
      padding: 15px;
      background-color: #3a4a3a;
      border-radius: 8px;
    }
    
    .controls-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .controls button {
      padding: 10px 20px;
      background-color: #4a5a4a;
      color: #f4f4f4;
      border: 1px solid #6a7a6a;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .controls button:hover {
      background-color: #5a6a5a;
    }
    
    .controls button.add-to-queue {
      background-color: #4a7a4a;
    }
    
    .controls button.add-to-queue:hover {
      background-color: #5a8a5a;
    }
    
    .controls button.print-queue {
      background-color: #5a5a7a;
    }
    
    .controls button.print-queue:hover {
      background-color: #6a6a8a;
    }
    
    .controls select {
      padding: 10px 15px;
      background-color: #2d3a2d;
      color: #f4f4f4;
      border: 2px solid #4a5a4a;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      min-width: 200px;
    }
    
    #nationSelector {
      width: 250px;
    }
    
    #aircraftSelector {
      width: 400px;
    }
    
    #flightSizeSelector {
      width: 150px;
    }
    
    .controls select:hover {
      background-color: #3a4a3a;
    }
    
    .controls label {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #d4e4d4;
      font-size: 14px;
    }
    
    .preview-frame {
      background: white;
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      font-family: Arial, sans-serif;
    }
    
    .queue-panel {
      background-color: #2d3a2d;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    
    .queue-header {
      color: #d4e4d4;
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .queue-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .queue-item {
      background-color: #3a4a3a;
      padding: 10px;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #d4e4d4;
      font-size: 13px;
    }
    
    .queue-item-info {
      flex: 1;
    }
    
    .queue-item button {
      padding: 5px 12px;
      background-color: #7a4a4a;
      color: #f4f4f4;
      border: 1px solid #8a5a5a;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .queue-item button:hover {
      background-color: #8a5a5a;
    }
    
    .queue-empty {
      color: #999;
      text-align: center;
      padding: 20px;
      font-style: italic;
    }
    
    /* Print Preview Styles */
    @page {
      size: letter;
      margin: 0.5in;
    }
    
    .page-title {
      text-align: center;
      font-size: 14pt;
      font-weight: bold;
      margin-bottom: 12px;
      border-bottom: 2px solid black;
      padding-bottom: 3px;
      color: black;
    }
    
    .flight-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 12px;
      min-height: 200px;
    }
    
    .flight-grid > p {
      grid-column: 1 / -1;
    }
    
    .flight-card {
      border: 2px solid black;
      padding: 6px;
      page-break-inside: avoid;
      background: white;
      color: black;
      display: flex;
      flex-direction: column;
    }
    
    .flight-info-section {
      border-bottom: 2px solid black;
      padding-bottom: 4px;
      margin-bottom: 4px;
    }
    
    .flight-header {
      display: grid;
      grid-template-columns: 50px auto 1.2fr 50px 0.8fr;
      gap: 4px;
      margin-bottom: 4px;
      align-items: stretch;
    }
    
    .roundel-box-header {
      border: none;
      padding: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      min-height: 18px;
      max-height: 28px;
    }
    
    .roundel-box-header img {
      max-width: 100%;
      height: 28px;
      width: auto;
      object-fit: contain;
    }
    
    .flight-weapons-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      padding: 3px;
      background: #f5f5f5;
    }
    
    .weapons-display {
      display: flex;
      gap: 15px;
      font-size: 7pt;
    }
    
    .weapon-item {
      display: flex;
      gap: 3px;
    }
    
    .weapon-item .weapon-label {
      font-weight: bold;
    }
    
    .aircraft-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 3px;
    }
    
    .aircraft-box {
      border: 1px solid #666;
      padding: 3px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 120px;
      position: relative;
    }
    
    .aircraft-header {
      display: flex;
      flex-direction: row;
      gap: 3px;
      margin-bottom: 3px;
      width: 100%;
    }
    
    .aircraft-number {
      border: 1px solid #666;
      width: 16px;
      height: 16px;
      background: white;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 7pt;
      font-weight: bold;
      flex-shrink: 0;
    }
    
    .damage-boxes {
      display: flex;
      flex-direction: row;
      gap: 2px;
    }
    
    .damage-column {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }
    
    .damage-row {
      display: flex;
      gap: 2px;
      align-items: center;
    }
    
    .damage-label {
      border: 1px solid #666;
      padding: 1px 3px;
      height: 16px;
      font-size: 6pt;
      background: white;
      display: flex;
      align-items: center;
      min-width: 50px;
      box-sizing: border-box;
    }
    
    .damage-checkbox {
      border: 1px solid #666;
      width: 16px;
      height: 16px;
      background: white;
      box-sizing: border-box;
    }
    
    .ordnance-area-small {
      border: none;
      border-top: 1px solid #666;
      padding: 4px 0;
      padding-top: 6px;
      min-height: 60px;
      width: 100%;
      background: white;
      flex: 1;
    }
    
    .ordnance-label-small {
      font-size: 7pt;
      color: #999;
      font-style: italic;
    }
    
    .fuel-box {
      border: 1px solid #666;
      padding: 2px 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .fuel-circles-row {
      display: flex;
      gap: 2px;
    }
    
    .fuel-circle {
      width: 10px;
      height: 10px;
      border: 1px solid #666;
      border-radius: 50%;
      background: white;
    }
    
    .field {
      border: 1px solid #666;
      padding: 2px 4px;
      overflow: hidden;
      white-space: nowrap;
    }
    
    .field-label {
      font-size: 7pt;
      color: #999;
      font-style: italic;
    }
    
    .field-value {
      font-weight: bold;
      font-size: 7pt;
    }
    
    .tasking-fuel-row {
      display: grid;
      grid-template-columns: 0.7fr 0.9fr 0.8fr;
      gap: 4px;
      margin-bottom: 5px;
      align-items: stretch;
      height: 45px;
    }
    
    .tasking-fuel-row .field {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    
    .fuel-box {
      border: 1px solid #666;
      padding: 2px 4px;
      display: flex;
      align-items: center;
      gap: 4px;
      height: 100%;
    }
    
    .fuel-label-value {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1px;
      font-size: 7pt;
      white-space: nowrap;
    }
    
    .fuel-label-value .field-label {
      margin: 0;
    }
    
    .fuel-label-value .fuel-value {
      font-weight: bold;
      font-size: 7pt;
    }
    
    .fuel-circles-container {
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1;
    }
    
    .fuel-circles-row {
      display: flex;
      gap: 2px;
    }
    
    .aircraft-section {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 4px;
      margin-bottom: 4px;
    }
    
    .aircraft-card {
      border: 1px solid #333;
      padding: 3px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 3px;
      position: relative;
    }
    
    .aircraft-top-row {
      display: flex;
      gap: 3px;
      position: relative;
    }
    
    .damage-status-container {
      position: absolute;
      right: 3px;
      top: 3px;
      border: 1px solid #666;
    }
    
    .damage-table {
      border-collapse: collapse;
      font-size: 6pt;
      font-weight: bold;
    }
    
    .damage-table td {
      border: 1px solid #666;
      padding: 0px 3px;
      text-align: center;
    }
    
    .damage-table .damage-label {
      padding: 0px 3px;
      text-align: right;
      width: 30px;
    }
    
    .damage-table .damage-cell {
      width: 18px;
      height: 14px;
      background: white;
    }
    
    .aircraft-stats {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 7pt;
      padding-left: 3px;
      padding-right: 60px;
    }
    
    .stat-row {
      display: flex;
      gap: 4px;
    }
    
    .stat-item {
      display: flex;
      gap: 2px;
    }
    
    .stat-label {
      font-weight: bold;
    }
    
    .rwr-jam-column {
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-left: auto;
    }
    
    .speed-table {
      border: 1px solid #666;
      border-collapse: collapse;
      width: 100%;
      font-size: 6pt;
      margin-top: 2px;
    }
    
    .speed-table th,
    .speed-table td {
      border: 1px solid #666;
      padding: 1px 2px;
      text-align: center;
    }
    
    .speed-table th {
      background: #e0e0e0;
      font-weight: bold;
    }
    
    .radar-info {
      font-size: 6pt;
      line-height: 1.3;
      margin-top: 2px;
      display: flex;
      justify-content: space-between;
      gap: 4px;
    }
    
    .radar-left {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    
    .radar-right {
      display: flex;
      flex-direction: column;
      gap: 1px;
      align-items: flex-end;
    }
    
    .weapons-container {
      display: flex;
      flex-direction: column;
      gap: 2px;
      padding-left: 10px;
    }
    
    .weapon-line {
      font-size: 6pt;
      display: flex;
      justify-content: flex-end;
      gap: 2px;
    }
    
    .weapon-label {
      font-weight: bold;
      text-align: right;
    }
    
    .weapon-value {
      font-weight: normal;
    }
    
    .crew-info {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0px;
      font-size: 6pt;
      position: absolute;
      right: 3px;
      top: 85px;
    }
    
    .crew-icon {
      font-size: 16pt;
      filter: grayscale(100%) brightness(0%);
    }
    
    .crew-count {
      border: 1px solid #666;
      padding: 1px 4px;
      font-size: 7pt;
      font-weight: bold;
      background: white;
      min-width: 10px;
      text-align: center;
    }
    
    .speed-table {
      margin-top: 20px;
    }
    
    .ordnance-area {
      border: 1px solid #999;
      padding: 3px;
      min-height: 30px;
      background: #fafafa;
    }
    
    .ordnance-label {
      font-size: 6pt;
      color: #666;
      margin-bottom: 2px;
    }
    
    .ordnance-text {
      font-size: 7pt;
      font-weight: bold;
    }
    
    @media print {
      body {
        background: white;
        padding: 0;
      }
      
      .designer-container {
        max-width: none;
      }
      
      .header, .controls {
        display: none;
      }
      
      .back-link {
        display: none;
      }
      
      .preview-frame {
        padding: 0;
        box-shadow: none;
      }
    }
  </style>
</head>
<body>
  <div class="designer-container">
    
    
    <div class="header">
      <h1>Flight Sheet Generator</h1>
      <p>Generate and print individual flight sheets</p>
    </div>
    <a href="../index.html" class="back-link">‚Üê Back to Baltic Approaches Tools Suite</a>
    <div class="controls">
      <div class="controls-row">
        <label>
          Nation:
          <select id="nationSelector">
            <option value="">-- All Nations --</option>
            <option value="US">United States (USAF)</option>
            <option value="UK">United Kingdom (RAF)</option>
            <option value="FRG">West Germany (Luftwaffe)</option>
            <option value="Belgium">Belgium</option>
            <option value="Canada">Canada</option>
            <option value="Netherlands">Netherlands</option>
            <option value="USSR">Soviet Union (VVS)</option>
            <option value="GDR">East Germany (LSK)</option>
          </select>
        </label>
        <label>
          Aircraft:
          <select id="aircraftSelector">
            <option value="">-- Select Aircraft --</option>
          </select>
        </label>
        <label>
          Flight Size:
          <select id="flightSizeSelector">
            <option value="1">1-ship</option>
            <option value="2">2-ship</option>
            <option value="4">4-ship</option>
          </select>
        </label>
      </div>
      <div class="controls-row">
        <button class="add-to-queue" onclick="addToQueue()">‚ûï Add to Queue</button>
        <button class="print-queue" onclick="printQueue()">üñ®Ô∏è Print All Flights</button>
        <button onclick="clearPreview()">üóëÔ∏è Clear Preview</button>
        <button onclick="exportDesign()">üíæ Export HTML</button>
      </div>
    </div>
    
    <div class="queue-panel">
      <div class="queue-header">
        <span>Flight Queue (<span id="queueCount">0</span>)</span>
        <button onclick="clearQueue()" style="padding: 5px 12px; background-color: #7a4a4a; color: #f4f4f4; border: 1px solid #8a5a5a; border-radius: 3px; cursor: pointer; font-size: 12px;">Clear All</button>
      </div>
      <div class="queue-list" id="queueList">
        <div class="queue-empty">No flights in queue. Configure a flight above and click "Add to Queue".</div>
      </div>
    </div>
    
    <div class="preview-frame" id="previewFrame">
      <div class="page-title">Baltic Approaches - Flight Sheet (Sample)</div>
      <div class="flight-grid" id="flightGrid">
        <p style="color: #999; text-align: center; padding: 40px; grid-column: 1 / -1;">
          Select a nation, aircraft, and flight size to create a sample flight card
        </p>
      </div>
    </div>
  </div>
  <script>
    // Global data stores
    let aircraftDatabase = {};
    let weaponsDatabase = {};
    let noteRulesDatabase = {};
    let flightQueue = [];
    let queueIdCounter = 1;
    
    // Load JSON databases (Baltic Approaches aircraft only)
    async function loadDatabases() {
      try {
        const [aircraftNatoResponse, aircraftWpResponse, weaponsResponse, noteRulesResponse] = await Promise.all([
          fetch('data/aircraft-nato.json'),
          fetch('data/aircraft-wp.json'),
          fetch('data/weapons.json'),
          fetch('data/aircraft-note-rules.json')
        ]);
        
        const aircraftNato = await aircraftNatoResponse.json();
        const aircraftWp = await aircraftWpResponse.json();
        weaponsDatabase = await weaponsResponse.json();
        noteRulesDatabase = await noteRulesResponse.json();
        
        // Merge NATO and WP databases
        aircraftDatabase = { ...aircraftNato, ...aircraftWp };
        
        // Remove metadata fields
        delete aircraftDatabase._comment;
        delete aircraftDatabase._version;
        delete aircraftDatabase._created;
        delete aircraftDatabase._description;
        
        console.log('Databases loaded:', Object.keys(aircraftDatabase).length, 'aircraft');
        console.log('Note rules loaded for:', Object.keys(noteRulesDatabase).join(', '));
        return true;
      } catch (error) {
        console.error('Error loading databases:', error);
        alert('Error loading aircraft database. Using fallback data.');
        return false;
      }
    }
    
    // Populate selectors and wire up UI
    function populateAircraftSelector() {
      const sel = document.getElementById('aircraftSelector');
      sel.innerHTML = '<option value="">-- Select Aircraft --</option>';
      const nationFilter = document.getElementById('nationSelector').value;
      const entries = Object.keys(aircraftDatabase).filter(k => {
        // skip metadata keys
        if (k.startsWith('_')) return false;
        const a = aircraftDatabase[k];
        if (!a) return false;
        if (!nationFilter) return true;
        // allow matching country codes or full nation name
        return String(a.nation || '').toLowerCase().includes(nationFilter.toLowerCase()) || String(nationFilter).toLowerCase() === String(a.nation || '').toLowerCase();
      }).map(k => ({ key: k, name: aircraftDatabase[k].name || k, nation: aircraftDatabase[k].nation || '' }));
      entries.sort((a,b) => a.name.localeCompare(b.name));
      for (const e of entries) {
        const opt = document.createElement('option');
        opt.value = e.key;
        opt.textContent = `${e.name} (${e.nation || e.key})`;
        sel.appendChild(opt);
      }
    }

    function updateAircraftSelectorOnNation() {
      populateAircraftSelector();
    }

    function addToQueue() {
      const aircraftKey = document.getElementById('aircraftSelector').value;
      const size = parseInt(document.getElementById('flightSizeSelector').value, 10) || 1;
      if (!aircraftKey) { alert('Please select an aircraft first.'); return; }
      const aircraft = aircraftDatabase[aircraftKey];
      const nation = (document.getElementById('nationSelector').value) || (aircraft && aircraft.nation) || '';
      const item = {
        id: queueIdCounter++,
        aircraftKey,
        size,
        nation
      };
      flightQueue.push(item);
      updateQueueUI();
      renderPreview();
    }

    function removeFromQueue(id) {
      const idx = flightQueue.findIndex(f => f.id === id);
      if (idx >= 0) flightQueue.splice(idx, 1);
      updateQueueUI();
      renderPreview();
    }

    function clearQueue() {
      if (!confirm('Clear all flights from the queue?')) return;
      flightQueue = [];
      updateQueueUI();
      clearPreview();
    }

    function updateQueueUI() {
      const list = document.getElementById('queueList');
      const count = document.getElementById('queueCount');
      list.innerHTML = '';
      if (!flightQueue.length) {
        const empty = document.createElement('div');
        empty.className = 'queue-empty';
        empty.textContent = 'No flights in queue. Configure a flight above and click "Add to Queue".';
        list.appendChild(empty);
        count.textContent = '0';
        return;
      }
      count.textContent = String(flightQueue.length);
      for (const f of flightQueue) {
        const item = document.createElement('div');
        item.className = 'queue-item';
        const info = document.createElement('div');
        info.className = 'queue-item-info';
        const aircraft = aircraftDatabase[f.aircraftKey] || { name: f.aircraftKey };
        info.textContent = `${aircraft.name || f.aircraftKey} ‚Äî ${f.nation || aircraft.nation || ''} ‚Äî ${f.size}-ship`;
        const btn = document.createElement('button');
        btn.textContent = 'Remove';
        btn.onclick = () => removeFromQueue(f.id);
        item.appendChild(info);
        item.appendChild(btn);
        list.appendChild(item);
      }
    }

    function renderPreview() {
      const grid = document.getElementById('flightGrid');
      grid.innerHTML = '';
      if (!flightQueue.length) {
        clearPreview();
        return;
      }
      for (const f of flightQueue) {
          const a = aircraftDatabase[f.aircraftKey] || { name: f.aircraftKey, ordnance: [], fuel: 0, crew: 1 };
          const card = document.createElement('div');
          card.className = 'flight-card';

          const header = document.createElement('div');
          header.className = 'flight-info-section';
          header.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;\"><div><strong>${a.name || f.aircraftKey}</strong><div style="font-size:10px;color:#444">${a.model || ''} ‚Äî ${f.nation || a.nation || ''}</div></div><div style="font-weight:bold;">${f.size}-ship</div></div>`;
          card.appendChild(header);

          const aircraftGrid = document.createElement('div');
          aircraftGrid.className = 'aircraft-grid';
          for (let i = 1; i <= f.size; i++) {
            const box = document.createElement('div');
            box.className = 'aircraft-box';

            const top = document.createElement('div');
            top.className = 'aircraft-header';
            const num = document.createElement('div');
            num.className = 'aircraft-number';
            num.textContent = String(i);

            const nameDiv = document.createElement('div');
            nameDiv.style.flex = '1';
            nameDiv.innerHTML = `<div style="font-weight:bold;font-size:10px">${a.name || f.aircraftKey}</div><div style="font-size:8px;color:#666">${a.model || ''}</div>`;

            const crewDiv = document.createElement('div');
            crewDiv.className = 'crew-info';
            crewDiv.innerHTML = `<div class="crew-icon">üë®‚Äç‚úàÔ∏è</div><div class="crew-count">${a.crew || 1}</div>`;

            top.appendChild(num);
            top.appendChild(nameDiv);
            top.appendChild(crewDiv);
            box.appendChild(top);

            const ordArea = document.createElement('div');
            ordArea.className = 'ordnance-area-small';
            const ordLabel = document.createElement('div');
            ordLabel.className = 'ordnance-label-small';
            ordLabel.textContent = 'Ordnance';
            const ordText = document.createElement('div');
            ordText.className = 'ordnance-text';
            ordText.textContent = getOrdnanceText(a);
            ordArea.appendChild(ordLabel);
            ordArea.appendChild(ordText);
            box.appendChild(ordArea);

            const fuelBox = document.createElement('div');
            fuelBox.className = 'fuel-box';
            const fuelLabel = document.createElement('div');
            fuelLabel.className = 'field-label';
            fuelLabel.textContent = 'Fuel';
            const circles = document.createElement('div');
            circles.className = 'fuel-circles-row';
            const fuel = Math.max(0, Math.min(10, a.fuel || 0));
            const displayCount = Math.max(1, fuel);
            for (let c = 0; c < displayCount; c++) {
              const fc = document.createElement('div');
              fc.className = 'fuel-circle';
              circles.appendChild(fc);
            }
            fuelBox.appendChild(fuelLabel);
            fuelBox.appendChild(circles);
            box.appendChild(fuelBox);

            aircraftGrid.appendChild(box);
          }
          card.appendChild(aircraftGrid);

          // Weapons display
          const wRow = document.createElement('div');
          wRow.className = 'flight-weapons-row';
          const weaponsDiv = document.createElement('div');
          weaponsDiv.className = 'weapons-display';
          if (a.weapons) {
            if (a.weapons.gun) {
              const wi = document.createElement('div');
              wi.className = 'weapon-item';
              wi.innerHTML = `<span class="weapon-label">Gun:</span><span class="weapon-value">${a.weapons.gun}${a.weapons.gunDepletion ? ' (' + a.weapons.gunDepletion + ')' : ''}</span>`;
              weaponsDiv.appendChild(wi);
            }
            if (a.weapons.irm) {
              const wi = document.createElement('div');
              wi.className = 'weapon-item';
              wi.innerHTML = `<span class="weapon-label">IRM:</span><span class="weapon-value">${a.weapons.irm}${a.weapons.irmDepletion ? ' x' + a.weapons.irmDepletion : ''}</span>`;
              weaponsDiv.appendChild(wi);
            }
            if (a.weapons.rhm) {
              const wi = document.createElement('div');
              wi.className = 'weapon-item';
              wi.innerHTML = `<span class="weapon-label">RHM:</span><span class="weapon-value">${a.weapons.rhm}${a.weapons.rhmDepletion ? ' x' + a.weapons.rhmDepletion : ''}</span>`;
              weaponsDiv.appendChild(wi);
            }
          }
          wRow.appendChild(weaponsDiv);
          card.appendChild(wRow);

          grid.appendChild(card);
        }
    }

    function clearPreview() {
      const grid = document.getElementById('flightGrid');
      grid.innerHTML = '<p style="color: #999; text-align: center; padding: 40px; grid-column: 1 / -1;">Select a nation, aircraft, and flight size to create a sample flight card</p>';
    }

    function getOrdnanceText(a) {
      const parts = [];
      if (a && Array.isArray(a.ordnance) && a.ordnance.length) {
        for (const o of a.ordnance) {
          if (!o) continue;
          const type = o.type || o.name || '';
          const qty = o.quantity;
          let label = type;
          if (weaponsDatabase && weaponsDatabase.ordnance && weaponsDatabase.ordnance[type]) label = weaponsDatabase.ordnance[type].name || type;
          else if (weaponsDatabase && weaponsDatabase.missiles && weaponsDatabase.missiles[type]) label = weaponsDatabase.missiles[type].name || type;
          else if (weaponsDatabase && weaponsDatabase.guns && weaponsDatabase.guns[type]) label = weaponsDatabase.guns[type].name || type;
          parts.push(qty ? `${label} x${qty}` : `${label}`);
        }
      }
      if (a && a.aam) {
        // include the AAM string if present
        parts.push(typeof a.aam === 'string' ? a.aam : String(a.aam));
      }
      if (parts.length) return parts.join(' ¬∑ ');
      if (a && a.aam) return a.aam || 'None';
      return 'No ordnance listed';
    }

    function renderPreview() {
      const grid = document.getElementById('flightGrid');
      grid.innerHTML = '';
      if (!flightQueue.length) {
        clearPreview();
        return;
      }
      for (const f of flightQueue) {
        const aircraft = aircraftDatabase[f.aircraftKey] || { name: f.aircraftKey, ordnance: [] };
        const card = document.createElement('div');
        card.className = 'flight-card';
        const header = document.createElement('div');
        header.className = 'flight-info-section';
        header.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;\"><div><strong>${aircraft.name || f.aircraftKey}</strong><div style="font-size:10px;">${aircraft.model || ''} ‚Äî ${f.nation || aircraft.nation || ''}</div></div><div style="font-weight:bold;">${f.size}-ship</div></div>`;
        card.appendChild(header);

        const ord = document.createElement('div');
        ord.className = 'ordnance-area';
        const ordLabel = document.createElement('div');
        ordLabel.className = 'ordnance-label';
        ordLabel.textContent = 'Ordnance';
        ord.appendChild(ordLabel);
        const ordText = document.createElement('div');
        ordText.className = 'ordnance-text';
        ordText.textContent = getOrdnanceText(aircraft);
        ord.appendChild(ordText);
        card.appendChild(ord);

        grid.appendChild(card);
      }
    }

    function buildPrintableHtml() {
      const rows = flightQueue.map(f => {
        const a = aircraftDatabase[f.aircraftKey] || { name: f.aircraftKey, ordnance: [] };
        const ordText = getOrdnanceText(a);
          return `<div class="flight-card" style="margin-bottom:12px;padding:8px;">` +
            `<div style="font-weight:bold;margin-bottom:6px;">${a.name || f.aircraftKey} ‚Äî ${f.nation || a.nation || ''} ‚Äî ${f.size}-ship</div>` +
            `<div style="font-size:12px;">Ordnance: ${ordText}</div>` +
          `</div>`;
      }).join('\n');
      const html = `<!doctype html><html><head><meta charset="utf-8"><title>Flight Queue Print</title><style>body{font-family:Arial,Helvetica,sans-serif;padding:20px} .flight-card{border:1px solid #222;padding:8px;background:#fff}</style></head><body><h1>Flight Queue</h1>${rows}</body></html>`;
      return html;
    }

    function printQueue() {
      if (!flightQueue.length) { alert('Queue is empty.'); return; }
      const html = buildPrintableHtml();
      const w = window.open('', '_blank');
      if (!w) { alert('Unable to open print window.'); return; }
      w.document.open();
      w.document.write(html);
      w.document.close();
      setTimeout(() => { w.print(); }, 300);
    }

    function exportDesign() {
      if (!flightQueue.length) { alert('Queue is empty. Nothing to export.'); return; }
      const html = buildPrintableHtml();
      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'baltic-flight-queue.html';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // Initialize after loading DBs
    loadDatabases().then(ok => {
      if (ok) {
        populateAircraftSelector();
        document.getElementById('nationSelector').addEventListener('change', () => updateAircraftSelectorOnNation());
        document.getElementById('aircraftSelector').addEventListener('change', () => {/* keep for future preview triggers */});
      }
    });
  </script>
  <div style="text-align: center; margin-top: 60px; padding: 30px 20px; border-top: 1px solid #4a5a4a; opacity: 0.8; background-color: #1a2a1a;">
    <p style="margin: 10px 0;">Baltic Approaches Tools Suite | Version 1.0.0</p>
    <p style="font-size: 0.85em; margin-top: 10px; opacity: 0.7;">
      Baltic Approaches and all related game materials are ¬© GMT Games. This is an unofficial fan-made tool suite not affiliated with or endorsed by the copyright holder.
    <a href="https://github.com/augustdragon/red-storm-tools-suite" style="display: inline-block; margin-top: 20px; color: #d4e4d4; text-decoration: none; padding: 10px 20px; border: 1px solid #4a5a4a; border-radius: 6px;" target="_blank">
      üìÇ View on GitHub
    </a>
  </div>
</body>
</html>
